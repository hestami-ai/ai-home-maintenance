services:
  # Reverse Proxy
  traefik:
    image: traefik:v3.6.6
    container_name: hestami-traefik
    command:
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=hestami-ai-os_hestami-network"
#      - "--entrypoints.websecure.address=:443"
#      - "--entrypoints.websecure.http.tls=true"
      - "--entrypoints.web.address=:80"
#      - "--providers.file.directory=/etc/traefik/certs"
      - "--providers.file.watch=true"
      - "--log.level=DEBUG"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      # Optimize for large file uploads
#      - "--entrypoints.websecure.transport.respondingTimeouts.readTimeout=300s"
#      - "--entrypoints.websecure.transport.respondingTimeouts.writeTimeout=300s"
#      - "--entrypoints.websecure.transport.respondingTimeouts.idleTimeout=180s"
      - "--entrypoints.web.transport.respondingTimeouts.readTimeout=300s"
      - "--entrypoints.web.transport.respondingTimeouts.writeTimeout=300s"
      - "--entrypoints.web.transport.respondingTimeouts.idleTimeout=180s"
      # Increase max request body size for file uploads (100MB)
#      - "--entrypoints.websecure.http.middlewares=upload-limit@docker"
#      - "--entrypoints.web.http.middlewares=upload-limit@docker"
      # HTTP/2 settings for large uploads
#      - "--entrypoints.websecure.http2.maxConcurrentStreams=250"
    ports:
      #- "443:443"
      - "8282:80"
      # Expose S3 Gateway and TUSD for local dev/testing if needed (via Traefik is preferred)
      # - "8333:8333" # SeaweedFS S3
      # - "1080:1080" # TUSD
    volumes:
      - "./volumes/traefik/certs:/etc/traefik/certs:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./volumes/traefik/logs:/var/log/traefik"
    networks:
      - hestami-network
    #restart: unless-stopped
    logging:
      driver: "local"
      options:
        max-size: "20m"
        max-file: "5" 

  # Storage: SeaweedFS Master
  seaweedfs-master:
    image: chrislusf/seaweedfs:4.04
    container_name: hestami-seaweedfs-master
    env_file:
      - ./.env
    #ports:
    #  - "9333:9333"
    #  - "19333:19333"
    command: "master -ip=hestami-seaweedfs-master -volumeSizeLimitMB=1000 -defaultReplication=000"
    networks:
      - hestami-network
    logging:
      driver: "local"
      options:
        max-size: "10m"

  # Storage: SeaweedFS Volume
  seaweedfs-volume:
    image: chrislusf/seaweedfs:4.04
    container_name: hestami-seaweedfs-volume
    env_file:
      - ./.env
    #ports:
    #  - "8080:8080"
    #  - "18080:18080"
    command: "volume -mserver=hestami-seaweedfs-master:9333 -port=8080"
    volumes:
      - ./volumes/seaweedfs/data:/data
    depends_on:
      - seaweedfs-master
    networks:
      - hestami-network
    logging:
      driver: "local"
      options:
        max-size: "10m"

  # Storage: SeaweedFS Filer (Required for S3)
  seaweedfs-filer:
    image: chrislusf/seaweedfs:4.04
    container_name: hestami-seaweedfs-filer
    env_file:
      - ./.env
    #ports:
    #  - "8888:8888"
    #  - "18888:18888"
    command: "filer -master=hestami-seaweedfs-master:9333 -port=8888"
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
    networks:
      - hestami-network
    logging:
      driver: "local"
      options:
        max-size: "10m"

  # Storage: SeaweedFS S3 Gateway
  seaweedfs-s3:
    image: chrislusf/seaweedfs:4.04
    container_name: hestami-seaweedfs-s3
    env_file:
      - ./.env
    #ports:
    #  - "8333:8333"
    entrypoint: ["/bin/sh", "/scripts/s3-entrypoint.sh"]
    command: ["s3", "-filer=hestami-seaweedfs-filer:8888", "-port=8333", "-ip.bind=0.0.0.0", "-config=/etc/seaweedfs/s3.json"]
    volumes:
      - ./docker/seaweedfs/s3-entrypoint.sh:/scripts/s3-entrypoint.sh:ro
    depends_on:
      - seaweedfs-master
      - seaweedfs-volume
      - seaweedfs-filer
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.s3.rule=Host(`dev-s3.hestami-ai.com`)"
      - "traefik.http.services.s3.loadbalancer.server.port=8333"
    networks:
      - hestami-network
    logging:
      driver: "local"
      options:
        max-size: "10m"

  # Upload: TUSD
  tusd:
    image: tusproject/tusd:v2.8.0
    container_name: hestami-tusd
    env_file:
      - ./.env
    environment:
      - AWS_ACCESS_KEY_ID=${S3_ACCESS_KEY:-hestami_admin}
      - AWS_SECRET_ACCESS_KEY=${S3_SECRET_KEY:-hestami_secret}
      - AWS_REGION=us-east-1
    command:
      - "-s3-endpoint=http://hestami-seaweedfs-s3:8333"
      - "-s3-bucket=uploads"
      - "-s3-object-prefix="
      - "-behind-proxy"
      - "-base-path=/files/"
      - "-hooks-http=http://hestami-app:3000/api/internal/tus-hook"
      - "-hooks-http-retry=3"
      - "-hooks-http-backoff=1s"
    depends_on:
      - seaweedfs-s3
      - app # Needs app for hooks
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.tusd.rule=Host(`dev-upload.hestami-ai.com`)"
      - "traefik.http.services.tusd.loadbalancer.server.port=8080"
      - "traefik.http.routers.tusd.middlewares=tusd-headers,tusd-cors,upload-limit"
      # Headers middleware to pass X-Forwarded-Proto for HTTPS URL generation
      - "traefik.http.middlewares.tusd-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      # CORS middleware for TUS protocol - allows browser uploads from app domain
      - "traefik.http.middlewares.tusd-cors.headers.accessControlAllowMethods=GET,POST,PUT,PATCH,DELETE,HEAD,OPTIONS"
      - "traefik.http.middlewares.tusd-cors.headers.accessControlAllowHeaders=Authorization,Content-Type,Upload-Length,Upload-Offset,Tus-Resumable,Upload-Metadata,Upload-Concat,Upload-Defer-Length,X-Requested-With,X-HTTP-Method-Override"
      - "traefik.http.middlewares.tusd-cors.headers.accessControlExposeHeaders=Upload-Offset,Location,Upload-Length,Tus-Version,Tus-Resumable,Tus-Max-Size,Tus-Extension,Upload-Metadata,Upload-Defer-Length,Upload-Concat"
      - "traefik.http.middlewares.tusd-cors.headers.accessControlAllowOriginList=https://dev-platform.hestami-ai.com,http://localhost:5173,http://localhost:3000"
      - "traefik.http.middlewares.tusd-cors.headers.accessControlMaxAge=86400"
      - "traefik.http.middlewares.tusd-cors.headers.addVaryHeader=true"
    networks:
      - hestami-network
    logging:
      driver: "local"
      options:
        max-size: "10m"

  # Worker: Document Processing (Dumb Muscle)
  worker-document:
    build:
      context: ./docker/worker-document
      dockerfile: Dockerfile
    container_name: hestami-worker-document
    env_file:
      - ./.env
    environment:
      - SEAWEEDFS_S3_ENDPOINT=http://hestami-seaweedfs-s3:8333
      - SEAWEEDFS_S3_ACCESS_KEY=${S3_ACCESS_KEY:-hestami_admin}
      - SEAWEEDFS_S3_SECRET_KEY=${S3_SECRET_KEY:-hestami_secret}
      - MAX_CONCURRENT_TASKS=3
      - OTEL_SERVICE_NAME=hestami-worker-document
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://signoz-otel-collector:4318
      - CLAMAV_UPDATE_INTERVAL_HOURS=6
    volumes:
      - clamav_data:/var/lib/clamav
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          memory: 512M
    depends_on:
      - seaweedfs-s3
    networks:
      - hestami-network
      - signoz-net
    logging:
      driver: "local"
      options:
        max-size: "10m" 

  # PostgreSQL with PostGIS
  postgres:
    build:
      context: ./docker/postgres
      dockerfile: Dockerfile
    container_name: hestami-postgres
    env_file:
      - ./.env
    ports:
      - "5432:5432"
    volumes:
      # PostgreSQL 18+ stores data in /var/lib/postgresql/18/main (not /data)
      - postgres_data:/var/lib/postgresql
      #- ./docker/postgres/init:/docker-entrypoint-initdb.d
    networks:
      - hestami-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    #restart: unless-stopped
    logging:
      driver: "local"
      options:
        max-size: "20m"
        max-file: "5"

  # Redis for session storage and caching
  redis:
    image: redis:8.0-M02-alpine3.20
    container_name: hestami-redis
    #command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    env_file:
      - ./.env
    #ports:
    #  - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - hestami-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    #restart: unless-stopped
    logging:
      driver: "local"
      options:
        max-size: "20m"
        max-file: "5"

  # Cerbos Policy Decision Point
  cerbos:
    image: cerbos/cerbos:0.48.0
    container_name: hestami-cerbos
    env_file:
      - ./.env
    environment:
      - OTEL_SERVICE_NAME=cerbos
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://signoz-otel-collector:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
    #ports:
    #  - "3593:3593"  # gRPC
    #  - "3592:3592"  # HTTP (for debugging/playground)
    volumes:
      - ./cerbos/policies:/policies
      - ./cerbos/config.yaml:/config.yaml
    command: ["server", "--config=/config.yaml"]
    networks:
      - hestami-network
      - signoz-net
    healthcheck:
      test: ["CMD", "/cerbos", "healthcheck", "--config=/config.yaml"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    #restart: unless-stopped
    logging:
      driver: "local"
      options:
        max-size: "20m"
        max-file: "5"

  # SvelteKit Application (Bun runtime, single process per container)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    # Note: container_name removed to allow replicas
    # container_name: hestami-app
    env_file:
      - ./.env
    environment:
      # Connection pool settings for deterministic DB connections
      # Total connections = replicas Ã— (PRISMA_POOL_MAX + DBOS_POOL_MAX)
      - PRISMA_POOL_MAX=${PRISMA_POOL_MAX:-5}
      - DBOS_POOL_MAX=${DBOS_POOL_MAX:-3}
      - SHUTDOWN_TIMEOUT_MS=${SHUTDOWN_TIMEOUT_MS:-30000}
    #ports:
    #  - "3000:3000" #SvelteKit Hestami AI OS App
    #  - "3001:3001" #DBOS Admin -- https://docs.dbos.dev/production/self-hosting/admin-api
    #deploy:
      # Replica scaling - adjust based on load requirements
      # Default: 1 replica for development, increase for production
      #replicas: ${APP_REPLICAS:-1}
      #resources:
        #limits:
          #memory: 4G  # Production: allow more concurrent uploads
        #reservations:
          #memory: 1G  # Base memory for app
      #restart_policy:
        #condition: unless-stopped
        #delay: 5s
        #max_attempts: 3
        #window: 120s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      cerbos:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`dev-platform.hestami-ai.com`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
      # Health-aware load balancing - remove unhealthy containers from rotation
      - "traefik.http.services.frontend.loadbalancer.healthcheck.path=/api/ready"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.frontend.loadbalancer.healthcheck.timeout=5s"
      # Define upload-limit middleware (referenced by entrypoint)
      - "traefik.http.middlewares.upload-limit.buffering.maxRequestBodyBytes=104857600"  # 100MB
      - "traefik.http.middlewares.upload-limit.buffering.memRequestBodyBytes=104857600"  # 100MB in memory
      # Apply middlewares to router
      - "traefik.http.routers.frontend.middlewares=upload-limit"
    networks:
      - hestami-network
      - signoz-net
    volumes:
      - ./volumes/hestami-ai-os-app/user_media:/mnt/hestami-user-media
    logging:
      # Use json-file driver so Signoz OTel Collector filelog receiver can scrape DBOS logs
      # Winston logs also go via OTLP directly, but DBOS logs only go to console
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

volumes:
  postgres_data:
  redis_data:
  clamav_data:

networks:
  hestami-network:
    driver: bridge
  signoz-net:
    external: true
