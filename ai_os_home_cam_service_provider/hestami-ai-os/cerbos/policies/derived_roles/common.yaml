# Common Derived Roles for Hestami AI OS
# These roles are derived from the user's organization membership
# and are used across all resource policies.
#
# Principal attributes expected:
#   - orgRoles: Record<organizationId, UserRole>
#   - vendorId?: string (for vendor users)
#
# Resource attributes expected:
#   - organizationId: string
#   - ownerIds?: string[] (for ownership-based access)
#   - memberIds?: string[] (for membership-based access)

apiVersion: api.cerbos.dev/v1
derivedRoles:
  name: common_roles
  definitions:
    # User has ADMIN role in the resource's organization
    - name: org_admin
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "ADMIN"

    # User has MANAGER role in the resource's organization
    - name: org_manager
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "MANAGER"

    # User has BOARD_MEMBER role in the resource's organization
    - name: org_board_member
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "BOARD_MEMBER"

    # User has OWNER role in the resource's organization
    - name: org_owner
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "OWNER"

    # User has TENANT role in the resource's organization
    - name: org_tenant
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "TENANT"

    # User has VENDOR role in the resource's organization
    - name: org_vendor
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "VENDOR"

    # User is a technician in the resource's organization
    # Technicians are VENDOR role users with a technicianId attribute
    - name: org_technician
      parentRoles: ["user"]
      condition:
        match:
          all:
            of:
              - expr: >-
                  has(P.attr.orgRoles) && 
                  has(R.attr.organizationId) && 
                  P.attr.orgRoles[R.attr.organizationId] == "VENDOR"
              - expr: >-
                  has(P.attr.technicianId)

    # User is a concierge staff member (MANAGER in property owner org)
    # Used for Phase 3 Concierge pillar resources
    - name: org_concierge
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "MANAGER"

    # User is listed as an owner of this specific resource
    # Used for unit ownership, property ownership, etc.
    - name: resource_owner
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(R.attr.ownerIds) && 
            P.id in R.attr.ownerIds

    # User is a member of this resource (e.g., association member)
    - name: resource_member
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(R.attr.memberIds) && 
            P.id in R.attr.memberIds

    # User is the assigned vendor for this resource (e.g., work order)
    - name: assigned_vendor
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.vendorId) && 
            has(R.attr.assignedVendorId) && 
            P.attr.vendorId == R.attr.assignedVendorId

    # Combined: User has any management role (ADMIN or MANAGER)
    - name: org_management
      parentRoles: ["user"]
      condition:
        match:
          any:
            of:
              - expr: >-
                  has(P.attr.orgRoles) && 
                  has(R.attr.organizationId) && 
                  P.attr.orgRoles[R.attr.organizationId] == "ADMIN"
              - expr: >-
                  has(P.attr.orgRoles) && 
                  has(R.attr.organizationId) && 
                  P.attr.orgRoles[R.attr.organizationId] == "MANAGER"

    # Combined: User has any stakeholder role (OWNER, TENANT, BOARD_MEMBER)
    - name: org_stakeholder
      parentRoles: ["user"]
      condition:
        match:
          any:
            of:
              - expr: >-
                  has(P.attr.orgRoles) && 
                  has(R.attr.organizationId) && 
                  P.attr.orgRoles[R.attr.organizationId] == "OWNER"
              - expr: >-
                  has(P.attr.orgRoles) && 
                  has(R.attr.organizationId) && 
                  P.attr.orgRoles[R.attr.organizationId] == "TENANT"
              - expr: >-
                  has(P.attr.orgRoles) && 
                  has(R.attr.organizationId) && 
                  P.attr.orgRoles[R.attr.organizationId] == "BOARD_MEMBER"

    # User has MEMBER role in the resource's organization
    # General membership role for basic access
    - name: org_member
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "MEMBER"

    # User has AUDITOR role in the resource's organization
    # Auditors have read-only access to financial and audit data
    - name: org_auditor
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.orgRoles) && 
            has(R.attr.organizationId) && 
            P.attr.orgRoles[R.attr.organizationId] == "AUDITOR"

    # Phase 16: Hestami Staff roles
    # User is a Hestami platform staff member with PLATFORM_ADMIN role
    - name: hestami_platform_admin
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.staffRoles) && 
            "PLATFORM_ADMIN" in P.attr.staffRoles

    # User is a Hestami staff member (any staff role)
    - name: hestami_staff
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(P.attr.staffRoles) && 
            size(P.attr.staffRoles) > 0

    # User is viewing their own staff profile
    - name: own_staff_profile
      parentRoles: ["user"]
      condition:
        match:
          expr: >-
            has(R.attr.userId) && 
            P.id == R.attr.userId
