// Hestami AI OS - Prisma Schema
// https://pris.ly/d/prisma-schema

// =============================================================================
// Generators
// =============================================================================

generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

/// @description Technician employed/contracted by a service provider org
model Technician {
  id              String           @id @default(cuid())
  organizationId  String           @map("organization_id")

  // Identity
  firstName       String           @map("first_name")
  lastName        String           @map("last_name")
  email           String?          @db.Citext
  phone           String?
  employeeId      String?          @map("employee_id")

  // Status & employment
  isActive        Boolean          @default(true) @map("is_active")
  hireDate        DateTime?        @map("hire_date")
  terminationDate DateTime?        @map("termination_date")
  timezone        String           @default("America/New_York")

  // Location/branch
  branchId        String?          @map("branch_id")

  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  branch          ContractorBranch @relation(fields: [branchId], references: [id])
  skills          TechnicianSkill[]
  certifications  TechnicianCertification[]
  availability    TechnicianAvailability?
  timeOff         TechnicianTimeOff[]
  territories     TechnicianTerritory[]
  kpis            TechnicianKPI[]

  @@index([organizationId])
  @@index([branchId])
  @@index([isActive])
  @@map("technicians")
}

/// @description Technician skill tagging
model TechnicianSkill {
  id            String      @id @default(cuid())
  technicianId  String      @map("technician_id")
  trade         ContractorTradeType @map("trade")
  level         Int         @default(1) // 1-5 proficiency
  notes         String?     @db.Text

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  technician    Technician  @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([technicianId, trade])
  @@index([technicianId])
  @@map("technician_skills")
}

/// @description Technician certifications (licenses, safety cards)
model TechnicianCertification {
  id             String      @id @default(cuid())
  technicianId   String      @map("technician_id")
  name           String
  authority      String?
  certificationId String?    @map("certification_id")
  issuedAt       DateTime?   @map("issued_at")
  expiresAt      DateTime?   @map("expires_at")
  documentUrl    String?     @map("document_url")

  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  technician     Technician  @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([expiresAt])
  @@map("technician_certifications")
}

/// @description Technician recurring weekly availability by weekday
model TechnicianAvailability {
  id             String     @id @default(cuid())
  technicianId   String     @unique @map("technician_id")
  monday         Json?
  tuesday        Json?
  wednesday      Json?
  thursday       Json?
  friday         Json?
  saturday       Json?
  sunday         Json?

  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  technician     Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@map("technician_availability")
}

/// @description Technician time off / PTO
model TechnicianTimeOff {
  id             String     @id @default(cuid())
  technicianId   String     @map("technician_id")
  startsAt       DateTime   @map("starts_at")
  endsAt         DateTime   @map("ends_at")
  reason         String?    @db.Text

  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  technician     Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([startsAt])
  @@index([endsAt])
  @@map("technician_time_off")
}

/// @description Technician territory assignment (links to service areas)
model TechnicianTerritory {
  id               String      @id @default(cuid())
  technicianId     String      @map("technician_id")
  serviceAreaId    String      @map("service_area_id")
  isPrimary        Boolean     @default(false) @map("is_primary")

  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  technician       Technician  @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  serviceArea      ServiceArea @relation(fields: [serviceAreaId], references: [id], onDelete: Cascade)

  @@unique([technicianId, serviceAreaId])
  @@index([technicianId])
  @@index([serviceAreaId])
  @@map("technician_territories")
}

/// @description Technician KPI snapshot (periodic)
model TechnicianKPI {
  id              String     @id @default(cuid())
  technicianId    String     @map("technician_id")
  periodStart     DateTime   @map("period_start")
  periodEnd       DateTime   @map("period_end")
  jobsCompleted   Int        @default(0) @map("jobs_completed")
  onTimeRate      Float      @default(0) @map("on_time_rate")
  callbackRate    Float      @default(0) @map("callback_rate")
  revenue         Decimal    @default(0) @map("revenue") @db.Decimal(12, 2)
  laborHours      Float      @default(0) @map("labor_hours")

  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  technician      Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([periodStart, periodEnd])
  @@map("technician_kpis")
}
generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../generated/zod"
  useMultipleFiles                 = true
  createInputTypes                 = true
  createModelTypes                 = true
  addInputTypeValidation           = true
  addIncludeType                   = true
  addSelectType                    = true
  validateWhereUniqueInput         = true
  createOptionalDefaultValuesTypes = true
  createRelationValuesTypes        = true
  createPartialTypes               = true
  useDefaultValidators             = true
  coerceDate                       = true
  writeNullishInModelTypes         = true
}

// =============================================================================
// Datasource
// =============================================================================

// Extensions: postgis, uuid-ossp, citext, pgcrypto are required by app
// btree_gin, fuzzystrmatch, pg_trgm, postgis_tiger_geocoder, postgis_topology, unaccent, vector are from PostGIS image
datasource db {
  provider   = "postgresql"
  extensions = [postgis, uuidOssp(map: "uuid-ossp"), citext, pgcrypto, btree_gin, fuzzystrmatch, pg_trgm, postgis_tiger_geocoder, postgis_topology, unaccent, vector]
}

// =============================================================================
// ENUMS
// =============================================================================

enum OrganizationType {
  COMMUNITY_ASSOCIATION
  MANAGEMENT_COMPANY
  SERVICE_PROVIDER
  EXTERNAL_SERVICE_PROVIDER  // Phase 2: External (non-platform) service providers
  INDIVIDUAL_CONCIERGE
  COMMERCIAL_CLIENT
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum UserRole {
  OWNER       // Homeowner
  TENANT      // Renter
  MANAGER     // Community/Portfolio Manager
  VENDOR      // Service Provider Staff
  BOARD_MEMBER
  ADMIN
}

// -----------------------------------------------------------------------------
// Phase 4: Work Orders & Assets
// -----------------------------------------------------------------------------

enum AssetStatus {
  ACTIVE
  INACTIVE
  UNDER_REPAIR
  DISPOSED
}

enum AssetCategory {
  HVAC
  PLUMBING
  ELECTRICAL
  STRUCTURAL
  LANDSCAPING
  POOL_SPA
  ELEVATOR
  SECURITY
  FIRE_SAFETY
  COMMON_AREA
  EQUIPMENT
  VEHICLE
  OTHER
}

enum WorkOrderStatus {
  DRAFT           // Initial creation
  SUBMITTED       // Submitted by requestor
  TRIAGED         // Reviewed and categorized
  ASSIGNED        // Vendor assigned
  SCHEDULED       // Work date scheduled
  IN_PROGRESS     // Work started
  ON_HOLD         // Paused for some reason
  COMPLETED       // Work finished
  INVOICED        // Invoice received
  CLOSED          // Fully resolved
  CANCELLED       // Cancelled before completion
}

enum WorkOrderPriority {
  EMERGENCY       // Immediate attention required
  HIGH            // Within 24 hours
  MEDIUM          // Within 1 week
  LOW             // Routine maintenance
  SCHEDULED       // Planned maintenance
}

enum WorkOrderCategory {
  MAINTENANCE
  REPAIR
  INSPECTION
  INSTALLATION
  REPLACEMENT
  EMERGENCY
  PREVENTIVE
  LANDSCAPING
  CLEANING
  SECURITY
  OTHER
}

enum BidStatus {
  REQUESTED       // Bid requested from vendor
  PENDING         // Vendor is preparing bid
  SUBMITTED       // Bid submitted
  UNDER_REVIEW    // Being reviewed
  ACCEPTED        // Bid accepted
  REJECTED        // Bid rejected
  WITHDRAWN       // Vendor withdrew bid
  EXPIRED         // Bid expired
}

// -----------------------------------------------------------------------------
// Phase 5: Violations
// -----------------------------------------------------------------------------

enum ViolationStatus {
  DRAFT           // Initial creation
  OPEN            // Active violation
  NOTICE_SENT     // Notice has been sent
  CURE_PERIOD     // Waiting for cure
  CURED           // Violation corrected
  ESCALATED       // Escalated to next level
  HEARING_SCHEDULED // Hearing scheduled
  HEARING_HELD    // Hearing completed
  FINE_ASSESSED   // Fine has been assessed
  APPEALED        // Under appeal
  CLOSED          // Resolved/closed
  DISMISSED       // Dismissed without action
}

enum ViolationSeverity {
  MINOR           // Minor infraction
  MODERATE        // Moderate violation
  MAJOR           // Major violation
  CRITICAL        // Critical/safety issue
}

enum NoticeType {
  WARNING         // Informal warning
  FIRST_NOTICE    // First formal notice
  SECOND_NOTICE   // Second notice
  FINAL_NOTICE    // Final notice before fine
  FINE_NOTICE     // Fine assessment notice
  HEARING_NOTICE  // Hearing notification
  CURE_CONFIRMATION // Confirmation of cure
}

enum NoticeDeliveryMethod {
  EMAIL
  MAIL
  CERTIFIED_MAIL
  POSTED          // Posted on property
  HAND_DELIVERED
  PORTAL          // Via owner portal
}

enum HearingOutcome {
  PENDING         // Not yet held
  UPHELD          // Violation upheld
  MODIFIED        // Fine/penalty modified
  DISMISSED       // Violation dismissed
  CONTINUED       // Hearing continued
}

enum AppealStatus {
  PENDING         // Appeal filed, awaiting review
  SCHEDULED       // Appeal hearing scheduled
  UPHELD          // Original decision upheld
  MODIFIED        // Fine/penalty modified on appeal
  REVERSED        // Original decision reversed
  WITHDRAWN       // Appeal withdrawn by filer
}

// -----------------------------------------------------------------------------
// Phase 14: Cross-Tenant Features
// -----------------------------------------------------------------------------

enum ServiceProviderLinkStatus {
  PENDING         // Link requested, awaiting verification
  VERIFIED        // Link verified and active
  REJECTED        // Link request rejected
  REVOKED         // Link was active but has been revoked
}

// -----------------------------------------------------------------------------
// Phase 2: Contractor Operations
// -----------------------------------------------------------------------------

enum VendorApprovalStatus {
  PENDING         // Awaiting approval
  APPROVED        // Approved for work
  CONDITIONAL     // Approved with conditions
  SUSPENDED       // Temporarily suspended
  REJECTED        // Rejected
}

enum ContractorTradeType {
  PLUMBING
  ELECTRICAL
  HVAC
  ROOFING
  LANDSCAPING
  PAINTING
  FLOORING
  CARPENTRY
  MASONRY
  GENERAL_CONTRACTOR
  POOL_SPA
  PEST_CONTROL
  CLEANING
  SECURITY
  FIRE_SAFETY
  ELEVATOR
  APPLIANCE_REPAIR
  LOCKSMITH
  GLASS_WINDOW
  FENCING
  CONCRETE
  DEMOLITION
  EXCAVATION
  WATERPROOFING
  INSULATION
  DRYWALL
  SIDING
  GUTTERS
  GARAGE_DOOR
  OTHER
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  REVOKED
  PENDING_RENEWAL
}

enum InsuranceType {
  GENERAL_LIABILITY
  WORKERS_COMPENSATION
  PROFESSIONAL_LIABILITY
  AUTO_LIABILITY
  UMBRELLA
  BONDING
}

enum InsuranceStatus {
  ACTIVE
  EXPIRED
  PENDING_VERIFICATION
  CANCELLED
}

enum IndividualRequestStatus {
  SUBMITTED       // Request submitted by homeowner
  REVIEWING       // Being reviewed/quoted
  APPROVED        // Approved by homeowner
  SCHEDULED       // Work scheduled
  IN_PROGRESS     // Work in progress
  COMPLETED       // Work completed
  CANCELLED       // Request cancelled
}

// -----------------------------------------------------------------------------
// Phase 15: Reporting & Analytics
// -----------------------------------------------------------------------------

enum ReportCategory {
  FINANCIAL       // Balance sheet, income statement, etc.
  RECEIVABLES     // Aged receivables, delinquency
  PAYABLES        // AP aging, vendor payments
  OPERATIONAL     // Work orders, violations, ARC
  COMPLIANCE      // Compliance status, deadlines
  GOVERNANCE      // Board reports, meeting summaries
  CUSTOM          // User-defined reports
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  JSON
  HTML
}

enum ScheduleFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
  CUSTOM          // Uses cronExpression
}

enum ReportDeliveryMethod {
  EMAIL
  PORTAL          // Available in portal for download
  BOTH
}

enum ReportExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum WidgetType {
  CHART_BAR
  CHART_LINE
  CHART_PIE
  CHART_DONUT
  METRIC_CARD     // Single value with trend
  TABLE           // Data table
  LIST            // Simple list
  CALENDAR        // Calendar view
  MAP             // Geographic map
}

// -----------------------------------------------------------------------------
// Phase 6: ARC (Architectural Requests)
// -----------------------------------------------------------------------------

enum ARCCategory {
  FENCE
  ROOF
  PAINT
  ADDITION
  LANDSCAPING
  WINDOWS
  DOORS
  DRIVEWAY
  GARAGE
  SOLAR
  HVAC
  OTHER
}

enum ARCRequestStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  CHANGES_REQUESTED
  TABLED
  WITHDRAWN
  CANCELLED
  EXPIRED
}

enum ARCReviewAction {
  APPROVE
  DENY
  REQUEST_CHANGES
  TABLE
}

enum ARCDocumentType {
  PLANS
  SPECS
  PHOTO
  PERMIT
  RENDERING
  SURVEY
  OTHER
}

// =============================================================================
// PHASE 7: Governance
// =============================================================================

enum BoardRole {
  PRESIDENT
  VICE_PRESIDENT
  SECRETARY
  TREASURER
  DIRECTOR
  MEMBER_AT_LARGE
}

enum MeetingType {
  BOARD
  ANNUAL
  SPECIAL
}

enum MeetingStatus {
  SCHEDULED
  HELD
  CANCELLED
}

enum MeetingAttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
}

enum VoteMethod {
  IN_PERSON
  PROXY
  ELECTRONIC
}

enum VoteChoice {
  YES
  NO
  ABSTAIN
}

enum ResolutionStatus {
  PROPOSED
  ADOPTED
  SUPERSEDED
  ARCHIVED
}

enum PolicyStatus {
  DRAFT
  ACTIVE
  RETIRED
}

// =============================================================================
// PHASE 8: Communications
// =============================================================================

enum CommunicationTemplateType {
  EMAIL
  SMS
  LETTER
}

enum CommunicationChannel {
  EMAIL
  SMS
  LETTER
}

enum CommunicationStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
}

enum AnnouncementStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CalendarEventType {
  MEETING
  MAINTENANCE
  AMENITY_CLOSURE
  OTHER
}

enum TemplateVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// =============================================================================
// CORE MODELS - Organization (Tenant)
// =============================================================================

/// @description Primary tenant entity for multitenancy
model Organization {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  type        OrganizationType
  status      OrganizationStatus @default(ACTIVE)
  settings    Json               @default("{}")
  
  // Phase 2: External service provider contact info (for EXTERNAL_SERVICE_PROVIDER type)
  externalContactName   String?   @map("external_contact_name")
  externalContactEmail  String?   @map("external_contact_email") @db.Citext
  externalContactPhone  String?   @map("external_contact_phone")
  
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  deletedAt   DateTime?          @map("deleted_at")

  // Relations
  memberships         UserOrganization[]
  idempotencyKeys     IdempotencyKey[]
  associations        Association[]
  parties             Party[]
  managedAssociations ManagementContract[] // For management companies

  // Phase 12: Compliance
  complianceRequirements ComplianceRequirement[]

  // Phase 14: Cross-Tenant Features
  serviceAreas            ServiceArea[]                   @relation("ServiceProviderAreas")
  serviceProviderLinks    ServiceProviderLink[]           @relation("ServiceProviderLinks")
  individualProperties    IndividualProperty[]            @relation("IndividualProperties")
  vendorMaintenanceRequests IndividualMaintenanceRequest[] @relation("VendorMaintenanceRequests")

  // Phase 2: Contractor Operations
  contractorProfile       ContractorProfile?
  contractorBranches      ContractorBranch[]

  @@map("organizations")
}

// =============================================================================
// CORE MODELS - User & Authentication
// =============================================================================

/// @description Platform user account
model User {
  id            String    @id @default(cuid())
  email         String    @unique @db.Citext
  emailVerified Boolean   @default(false) @map("email_verified")
  name          String?
  image         String?
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  memberships         UserOrganization[]
  sessions            Session[]
  accounts            Account[]
  parties             Party[]   // Party records linked to this user
  managerAssignments  ManagerAssignment[]
  // Phase 6: ARC
  arcReviews          ARCReview[]

  @@map("users")
}

/// @description Junction table for user-organization membership with roles
model UserOrganization {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  organizationId String       @map("organization_id")
  role           UserRole     @default(OWNER)
  isDefault      Boolean      @default(false) @map("is_default")
  
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("user_organizations")
}

/// @description User session for authentication
model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  token        String   @unique
  expiresAt    DateTime @map("expires_at")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// @description OAuth account linking
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  accountId         String  @map("account_id")
  providerId        String  @map("provider_id")
  accessToken       String? @map("access_token")
  refreshToken      String? @map("refresh_token")
  accessTokenExpiresAt DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope             String?
  idToken           String? @map("id_token")
  password          String?
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

/// @description Email verification tokens
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verifications")
}

// =============================================================================
// CORE MODELS - Idempotency
// =============================================================================

/// @description Tracks idempotency keys for mutating operations
model IdempotencyKey {
  id             String       @id @default(cuid())
  key            String
  organizationId String       @map("organization_id")
  response       Json?
  statusCode     Int?         @map("status_code")
  
  createdAt      DateTime     @default(now()) @map("created_at")
  expiresAt      DateTime     @map("expires_at")

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([key, organizationId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// =============================================================================
// DOMAIN 1 - ENUMS
// =============================================================================

enum AssociationStatus {
  ACTIVE
  ONBOARDING
  SUSPENDED
  TERMINATED
}

enum PropertyType {
  SINGLE_FAMILY
  CONDOMINIUM
  TOWNHOUSE
  COOPERATIVE
  MIXED_USE
  COMMERCIAL
}

enum UnitType {
  SINGLE_FAMILY_HOME
  CONDO_UNIT
  TOWNHOUSE
  LOT
  COMMERCIAL_UNIT
}

enum AmenityType {
  POOL
  CLUBHOUSE
  GYM
  TENNIS_COURT
  PLAYGROUND
  PARK
  GATE
  PARKING
  OTHER
}

enum PartyType {
  INDIVIDUAL
  TRUST
  CORPORATION
  LLC
  PARTNERSHIP
  ESTATE
}

enum OwnershipType {
  FEE_SIMPLE
  JOINT_TENANCY
  TENANCY_IN_COMMON
  COMMUNITY_PROPERTY
  TRUST
}

// -----------------------------------------------------------------------------
// Phase 9: Owner Portal / CRM
// -----------------------------------------------------------------------------

enum ContactPreferenceChannel {
  EMAIL
  SMS
  PUSH
  MAIL
  PORTAL
}

enum NotificationCategory {
  GENERAL
  BILLING
  MAINTENANCE
  GOVERNANCE
  ARC
  VIOLATION
  COMMUNICATION
}

enum OwnerRequestStatus {
  DRAFT
  SUBMITTED
  IN_PROGRESS
  RESOLVED
  CLOSED
  CANCELLED
}

enum OwnerRequestCategory {
  GENERAL_INQUIRY
  MAINTENANCE
  BILLING
  ARCHITECTURAL
  VIOLATION
  GOVERNANCE
  AMENITY
  OTHER
}

enum PaymentMethodType {
  BANK_ACCOUNT
  CREDIT_CARD
  DEBIT_CARD
}

enum AutoPayFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
  ON_DUE_DATE
}

enum DocumentVisibility {
  PUBLIC           // All association members
  OWNERS_ONLY      // Only owners
  BOARD_ONLY       // Only board members
  STAFF_ONLY       // Only staff/managers
  PRIVATE          // Specific parties only
}

enum DocumentCategory {
  GOVERNING_DOCS   // CC&Rs, Bylaws, Rules
  FINANCIAL        // Budgets, audits, statements
  MEETING          // Minutes, agendas
  LEGAL            // Contracts, legal notices
  INSURANCE        // Policies, certificates
  MAINTENANCE      // Maintenance records, warranties
  ARCHITECTURAL    // ARC guidelines, approvals
  RESERVE_STUDY    // Reserve studies
  INSPECTION       // Inspection reports
  CONTRACT         // Vendor contracts
  GENERAL          // Other documents
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  SUPERSEDED
  ARCHIVED
}

enum StorageProvider {
  LOCAL
  S3
  AZURE_BLOB
  GCS
}

// -----------------------------------------------------------------------------
// Phase 11: Reserve Studies
// -----------------------------------------------------------------------------

enum ReserveComponentCategory {
  ROOFING
  PAVING
  PAINTING
  PLUMBING
  ELECTRICAL
  HVAC
  POOL_SPA
  LANDSCAPING
  FENCING
  STRUCTURAL
  ELEVATOR
  COMMON_AREA
  EQUIPMENT
  OTHER
}

enum ReserveStudyType {
  FULL              // Full on-site inspection
  UPDATE_WITH_SITE  // Update with site visit
  UPDATE_NO_SITE    // Update without site visit
}

enum FundingPlanType {
  BASELINE          // Maintain positive balance
  THRESHOLD         // Maintain minimum threshold
  FULL_FUNDING      // 100% funded target
  STATUTORY         // State-mandated minimum
}

// -----------------------------------------------------------------------------
// Phase 12: Compliance
// -----------------------------------------------------------------------------

enum ComplianceRequirementType {
  STATUTORY_DEADLINE    // State/local law deadlines
  NOTICE_REQUIREMENT    // Required notices to owners
  VOTING_RULE           // Election/voting requirements
  FINANCIAL_AUDIT       // Audit requirements
  RESALE_PACKET         // Resale disclosure requirements
  INSURANCE             // Insurance requirements
  MEETING               // Required meetings
  FILING                // Government filings
  RECORD_RETENTION      // Document retention rules
  OTHER
}

enum ComplianceStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  WAIVED
  NOT_APPLICABLE
}

enum RecurrencePattern {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

// =============================================================================
// DOMAIN 1 - Association / Property Model
// =============================================================================

/// @description Community Association (HOA/COA/POA)
model Association {
  id                  String                 @id @default(cuid())
  organizationId      String                 @map("organization_id")
  name                String
  legalName           String?                @map("legal_name")
  taxId               String?                @map("tax_id")
  status              AssociationStatus      @default(ONBOARDING)
  incorporationDate   DateTime?              @map("incorporation_date")
  fiscalYearEnd       Int                    @default(12) @map("fiscal_year_end") // Month (1-12)
  settings            Json                   @default("{}")
  deletedAt           DateTime?              @map("deleted_at")
  
  createdAt           DateTime               @default(now()) @map("created_at")
  updatedAt           DateTime               @updatedAt @map("updated_at")
  
  // Relations
  organization        Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  properties          Property[]
  managementContracts ManagementContract[]
  managerAssignments  ManagerAssignment[]
  
  // Accounting relations
  glAccounts          GLAccount[]
  journalEntries      JournalEntry[]
  bankAccounts        BankAccount[]
  assessmentTypes     AssessmentType[]
  assessmentCharges   AssessmentCharge[]
  payments            Payment[]
  vendors             Vendor[]
  apInvoices          APInvoice[]
  
  // Phase 4: Work Orders & Assets
  assets              Asset[]
  workOrders          WorkOrder[]
  serviceProviders    AssociationServiceProvider[]
  
  // Phase 5: Violations
  violationTypes      ViolationType[]
  violations          Violation[]

  // Phase 6: ARC
  arcCommittees       ARCCommittee[]
  arcRequests         ARCRequest[]

  // Phase 7: Governance
  boards              Board[]
  meetings            Meeting[]
  resolutions         Resolution[]
  policyDocuments     PolicyDocument[]
  communicationTemplates CommunicationTemplate[]
  massCommunications  MassCommunication[]
  announcements       Announcement[]
  calendarEvents      CalendarEvent[]
  calendarNotifications CalendarEventNotification[]

  // Phase 9: Owner Portal / CRM
  ownerRequests       OwnerRequest[]
  documents           AssociationDocument[]

  // Phase 11: Reserve Studies
  reserveComponents   ReserveComponent[]
  reserveStudies      ReserveStudy[]

  // Phase 12: Compliance
  complianceDeadlines ComplianceDeadline[]

  // Phase 5: Notice Templates
  noticeTemplates     NoticeTemplate[]

  // Phase 15: Reporting
  reportDefinitions   ReportDefinition[]
  reportSchedules     ReportSchedule[]
  reportExecutions    ReportExecution[]
  dashboardWidgets    DashboardWidget[]

  @@index([organizationId])
  @@map("associations")
}

/// @description Property/Community managed by an association
model Property {
  id              String       @id @default(cuid())
  associationId   String       @map("association_id")
  name            String
  propertyType    PropertyType @map("property_type")
  
  // Address
  addressLine1    String       @map("address_line_1")
  addressLine2    String?      @map("address_line_2")
  city            String
  state           String
  postalCode      String       @map("postal_code")
  country         String       @default("US")
  
  // Geo (PostGIS point)
  latitude        Float?
  longitude       Float?
  
  // Metadata
  yearBuilt       Int?         @map("year_built")
  totalUnits      Int          @default(0) @map("total_units")
  totalAcres      Float?       @map("total_acres")
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  // Relations
  association     Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  units           Unit[]
  commonAreas     CommonArea[]

  @@index([associationId])
  @@map("properties")
}

/// @description Individual unit/lot within a property
model Unit {
  id              String    @id @default(cuid())
  propertyId      String    @map("property_id")
  unitNumber      String    @map("unit_number")
  unitType        UnitType  @map("unit_type")
  
  // Address (if different from property)
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  
  // Unit details
  bedrooms        Int?
  bathrooms       Float?
  squareFeet      Int?      @map("square_feet")
  lotSquareFeet   Int?      @map("lot_square_feet")
  parkingSpaces   Int       @default(0) @map("parking_spaces")
  
  // Assessment info
  assessmentClass String?   @map("assessment_class")
  votingWeight    Float     @default(1) @map("voting_weight")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ownerships      Ownership[]
  tenancies       Tenancy[]
  
  // Accounting relations
  assessmentCharges AssessmentCharge[]
  payments          Payment[]
  
  // Phase 4: Work Orders & Assets
  assets            Asset[]
  workOrders        WorkOrder[]
  
  // Phase 5: Violations
  violations        Violation[]

  // Phase 6: ARC
  arcRequests       ARCRequest[]

  // Phase 9: Owner Portal / CRM
  ownerRequests     OwnerRequest[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@map("units")
}

/// @description Common area or amenity
model CommonArea {
  id              String      @id @default(cuid())
  propertyId      String      @map("property_id")
  name            String
  amenityType     AmenityType @map("amenity_type")
  description     String?
  
  // Location within property
  location        String?
  
  // Scheduling
  reservable      Boolean     @default(false)
  maxCapacity     Int?        @map("max_capacity")
  
  // Operating hours (JSON: { monday: { open: "09:00", close: "21:00" }, ... })
  operatingHours  Json?       @map("operating_hours")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  property        Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("common_areas")
}

// =============================================================================
// DOMAIN 1 - Party & Relationship Models
// =============================================================================

/// @description Person or entity that can own/rent property
model Party {
  id              String    @id @default(cuid())
  organizationId  String    @map("organization_id")
  partyType       PartyType @map("party_type")
  
  // For individuals
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  
  // For entities
  entityName      String?   @map("entity_name")
  
  // Contact
  email           String?   @db.Citext
  phone           String?
  
  // Address
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  country         String?   @default("US")
  
  // Link to platform user (if registered)
  userId          String?   @map("user_id")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  ownerships      Ownership[]
  tenancies       Tenancy[]
  
  // Accounting relations
  payments        Payment[]    // Payments made by this party
  
  // Phase 5: Violations
  violations      Violation[]  // Violations where this party is responsible

  // Phase 6: ARC
  arcRequests     ARCRequest[] @relation("PartyARCRequests") // Requests submitted by this party
  arcCommitteeMemberships ARCCommitteeMember[]
  
  // Phase 7: Governance
  boardMemberships   BoardMember[]
  meetingAttendance  MeetingAttendance[]
  voteBallots        VoteBallot[]
  announcementReads  AnnouncementRead[]

  // Phase 9: Owner Portal / CRM
  userProfile         UserProfile?
  contactPreferences  ContactPreference[]
  notificationSettings NotificationSetting[]
  ownerRequests       OwnerRequest[]
  storedPaymentMethods StoredPaymentMethod[]
  autoPaySettings     AutoPaySetting[]
  documentAccessGrants DocumentAccessGrant[]
  documentDownloadLogs DocumentDownloadLog[]

  @@index([organizationId])
  @@index([userId])
  @@index([email])
  @@map("parties")

}

/// @description User profile for portal/CRM
model UserProfile {
  id              String    @id @default(cuid())
  partyId         String    @map("party_id")
  preferredName   String?   @map("preferred_name")
  profilePhotoUrl String?   @map("profile_photo_url")
  language        String    @default("en") @map("language")
  timezone        String    @default("UTC") @map("timezone")
  mailingAddress  Json?     @map("mailing_address")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  party           Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId])
  @@map("user_profiles")
}

/// @description Contact channel preferences for a party
model ContactPreference {
  id                 String                   @id @default(cuid())
  partyId            String                   @map("party_id")
  channel            ContactPreferenceChannel
  isEnabled          Boolean                  @default(true) @map("is_enabled")
  allowTransactional Boolean                  @default(true) @map("allow_transactional")
  allowMarketing     Boolean                  @default(false) @map("allow_marketing")
  allowEmergency     Boolean                  @default(true) @map("allow_emergency")

  createdAt          DateTime                 @default(now()) @map("created_at")
  updatedAt          DateTime                 @updatedAt @map("updated_at")
  deletedAt          DateTime?                @map("deleted_at")

  // Relations
  party              Party                    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, channel])
  @@map("contact_preferences")
}

/// @description Notification preferences per category and channel
model NotificationSetting {
  id         String                   @id @default(cuid())
  partyId    String                   @map("party_id")
  category   NotificationCategory
  channel    ContactPreferenceChannel
  isEnabled  Boolean                  @default(true) @map("is_enabled")

  createdAt  DateTime                 @default(now()) @map("created_at")
  updatedAt  DateTime                 @updatedAt @map("updated_at")
  deletedAt  DateTime?                @map("deleted_at")

  // Relations
  party      Party                    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, category, channel])
  @@map("notification_settings")
}

/// @description Owner request / inquiry submitted via portal
model OwnerRequest {
  id              String               @id @default(cuid())
  associationId   String               @map("association_id")
  unitId          String?              @map("unit_id")
  partyId         String               @map("party_id")

  requestNumber   String               @map("request_number") // e.g., REQ-2024-000001
  category        OwnerRequestCategory
  status          OwnerRequestStatus   @default(DRAFT)

  subject         String
  description     String               @db.Text
  attachments     Json?                // Array of file URLs/metadata

  // Tracking
  submittedAt     DateTime?            @map("submitted_at")
  resolvedAt      DateTime?            @map("resolved_at")
  closedAt        DateTime?            @map("closed_at")

  // Assignment
  assignedToUserId String?             @map("assigned_to_user_id")

  // Resolution
  resolutionNotes String?              @map("resolution_notes") @db.Text

  // Conversion to work order
  workOrderId     String?              @map("work_order_id")

  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  deletedAt       DateTime?            @map("deleted_at")

  // Relations
  association     Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit?                @relation(fields: [unitId], references: [id])
  party           Party                @relation(fields: [partyId], references: [id])
  workOrder       WorkOrder?           @relation(fields: [workOrderId], references: [id])
  history         OwnerRequestHistory[]

  @@unique([associationId, requestNumber])
  @@index([partyId])
  @@index([unitId])
  @@index([status])
  @@index([category])
  @@map("owner_requests")
}

/// @description History/audit trail for owner requests
model OwnerRequestHistory {
  id              String       @id @default(cuid())
  requestId       String       @map("request_id")

  action          String       // e.g., "CREATED", "SUBMITTED", "ASSIGNED", "RESOLVED", "CLOSED"
  previousStatus  String?      @map("previous_status")
  newStatus       String?      @map("new_status")
  notes           String?      @db.Text
  performedBy     String       @map("performed_by") // User ID

  createdAt       DateTime     @default(now()) @map("created_at")

  // Relations
  request         OwnerRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("owner_request_history")
}

/// @description Stored payment method for a party (tokenized reference only)
model StoredPaymentMethod {
  id              String            @id @default(cuid())
  partyId         String            @map("party_id")

  methodType      PaymentMethodType @map("method_type")
  nickname        String?           // e.g., "My Checking Account"
  lastFour        String            @map("last_four") // Last 4 digits
  expirationMonth Int?              @map("expiration_month") // For cards
  expirationYear  Int?              @map("expiration_year")  // For cards
  bankName        String?           @map("bank_name")        // For bank accounts

  // Tokenized reference (from payment processor)
  processorToken  String            @map("processor_token")
  processorType   String            @map("processor_type") // e.g., "STRIPE", "PLAID"

  isDefault       Boolean           @default(false) @map("is_default")
  isVerified      Boolean           @default(false) @map("is_verified")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  deletedAt       DateTime?         @map("deleted_at")

  // Relations
  party           Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)
  autoPaySettings AutoPaySetting[]

  @@index([partyId])
  @@map("stored_payment_methods")
}

/// @description Auto-pay configuration for a party
model AutoPaySetting {
  id                    String            @id @default(cuid())
  partyId               String            @map("party_id")
  paymentMethodId       String            @map("payment_method_id")

  isEnabled             Boolean           @default(true) @map("is_enabled")
  frequency             AutoPayFrequency
  dayOfMonth            Int?              @map("day_of_month") // 1-28 for monthly
  maxAmount             Decimal?          @map("max_amount") @db.Decimal(10, 2)

  // Scope (optional - if null, applies to all charges)
  associationId         String?           @map("association_id")
  assessmentTypeId      String?           @map("assessment_type_id")

  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")
  deletedAt             DateTime?         @map("deleted_at")

  // Relations
  party                 Party             @relation(fields: [partyId], references: [id], onDelete: Cascade)
  paymentMethod         StoredPaymentMethod @relation(fields: [paymentMethodId], references: [id])

  @@unique([partyId, associationId, assessmentTypeId])
  @@index([partyId])
  @@index([paymentMethodId])
  @@map("auto_pay_settings")
}

/// @description Ownership record linking party to unit
model Ownership {
  id              String        @id @default(cuid())
  unitId          String        @map("unit_id")
  partyId         String        @map("party_id")
  ownershipType   OwnershipType @map("ownership_type")
  
  // Ownership percentage (for shared ownership)
  percentage      Float         @default(100)
  
  // Dates
  startDate       DateTime      @map("start_date")
  endDate         DateTime?     @map("end_date")
  
  // Primary contact for this unit
  isPrimary       Boolean       @default(false) @map("is_primary")
  
  // Mailing preferences
  mailingAddress  Json?         @map("mailing_address")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  // Relations
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  party           Party         @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([partyId])
  @@index([endDate])
  @@map("ownerships")
}

/// @description Tenancy record for renters
model Tenancy {
  id              String    @id @default(cuid())
  unitId          String    @map("unit_id")
  partyId         String    @map("party_id")
  
  // Lease dates
  leaseStart      DateTime  @map("lease_start")
  leaseEnd        DateTime? @map("lease_end")
  
  // Contact preferences
  isPrimary       Boolean   @default(false) @map("is_primary")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  unit            Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  party           Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([partyId])
  @@index([leaseEnd])
  @@map("tenancies")
}

/// @description Document stored for an association with visibility rules
model AssociationDocument {
  id              String             @id @default(cuid())
  associationId   String             @map("association_id")

  title           String
  description     String?
  category        DocumentCategory
  visibility      DocumentVisibility @default(PUBLIC)
  status          DocumentStatus     @default(ACTIVE)

  // File storage
  storageProvider StorageProvider    @default(LOCAL) @map("storage_provider")
  storagePath     String             @map("storage_path") // Path/key in storage
  fileUrl         String             @map("file_url")
  fileName        String             @map("file_name")
  fileSize        Int                @map("file_size") // bytes
  mimeType        String             @map("mime_type")
  checksum        String?            // MD5/SHA256 hash for integrity

  // Extracted metadata
  pageCount       Int?               @map("page_count")
  thumbnailUrl    String?            @map("thumbnail_url")
  extractedText   String?            @map("extracted_text") @db.Text
  metadata        Json?              // Additional extracted metadata

  // Versioning
  version         Int                @default(1)
  parentDocumentId String?           @map("parent_document_id")
  supersededById  String?            @map("superseded_by_id")

  // Effective dates (for governing docs)
  effectiveDate   DateTime?          @map("effective_date")
  expirationDate  DateTime?          @map("expiration_date")

  // Metadata
  uploadedBy      String             @map("uploaded_by") // User ID
  tags            String[]           @default([])

  // Archive info
  archivedAt      DateTime?          @map("archived_at")
  archivedBy      String?            @map("archived_by")
  archiveReason   String?            @map("archive_reason")

  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")
  deletedAt       DateTime?          @map("deleted_at")

  // Relations
  association     Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  parentDocument  AssociationDocument? @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  childVersions   AssociationDocument[] @relation("DocumentVersions")
  supersededBy    AssociationDocument? @relation("SupersededDocuments", fields: [supersededById], references: [id])
  supersedes      AssociationDocument[] @relation("SupersededDocuments")
  accessGrants    DocumentAccessGrant[]
  downloadLogs    DocumentDownloadLog[]

  @@index([associationId])
  @@index([category])
  @@index([visibility])
  @@index([status])
  @@map("association_documents")
}

/// @description Explicit access grant for private documents
model DocumentAccessGrant {
  id              String              @id @default(cuid())
  documentId      String              @map("document_id")
  partyId         String              @map("party_id")

  grantedBy       String              @map("granted_by") // User ID
  grantedAt       DateTime            @default(now()) @map("granted_at")
  expiresAt       DateTime?           @map("expires_at")
  revokedAt       DateTime?           @map("revoked_at")

  // Relations
  document        AssociationDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  party           Party               @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([documentId, partyId])
  @@index([partyId])
  @@map("document_access_grants")
}

/// @description Log of document downloads for auditing
model DocumentDownloadLog {
  id              String              @id @default(cuid())
  documentId      String              @map("document_id")
  partyId         String?             @map("party_id")
  userId          String              @map("user_id")

  downloadedAt    DateTime            @default(now()) @map("downloaded_at")
  ipAddress       String?             @map("ip_address")
  userAgent       String?             @map("user_agent")

  // Relations
  document        AssociationDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  party           Party?              @relation(fields: [partyId], references: [id])

  @@index([documentId])
  @@index([partyId])
  @@index([downloadedAt])
  @@map("document_download_logs")
}

// =============================================================================
// DOMAIN 11 - Reserve Studies
// =============================================================================

/// @description Reserve component tracked for an association
model ReserveComponent {
  id                  String                   @id @default(cuid())
  associationId       String                   @map("association_id")

  name                String
  description         String?
  category            ReserveComponentCategory
  location            String?                  // Where in the property

  // Lifecycle
  usefulLife          Int                      @map("useful_life") // Years
  remainingLife       Int                      @map("remaining_life") // Years
  placedInServiceDate DateTime?                @map("placed_in_service_date")

  // Costs
  currentReplacementCost Decimal              @map("current_replacement_cost") @db.Decimal(12, 2)
  futureReplacementCost  Decimal?             @map("future_replacement_cost") @db.Decimal(12, 2)
  inflationRate          Decimal              @default(3.0) @map("inflation_rate") @db.Decimal(5, 2)

  // Quantity
  quantity            Int                      @default(1)
  unitOfMeasure       String?                  @map("unit_of_measure")

  // Condition
  conditionRating     Int?                     @map("condition_rating") // 1-10 scale
  lastInspectionDate  DateTime?                @map("last_inspection_date")
  notes               String?                  @db.Text

  createdAt           DateTime                 @default(now()) @map("created_at")
  updatedAt           DateTime                 @updatedAt @map("updated_at")
  deletedAt           DateTime?                @map("deleted_at")

  // Relations
  association         Association              @relation(fields: [associationId], references: [id], onDelete: Cascade)
  studySnapshots      ReserveStudyComponent[]

  @@index([associationId])
  @@index([category])
  @@map("reserve_components")
}

/// @description Reserve study for an association
model ReserveStudy {
  id                  String           @id @default(cuid())
  associationId       String           @map("association_id")

  studyType           ReserveStudyType @map("study_type")
  studyDate           DateTime         @map("study_date")
  effectiveDate       DateTime         @map("effective_date")
  expirationDate      DateTime?        @map("expiration_date")

  // Preparer info
  preparerName        String           @map("preparer_name")
  preparerCompany     String?          @map("preparer_company")
  preparerCredentials String?          @map("preparer_credentials")

  // Financial snapshot at study time
  reserveBalance      Decimal          @map("reserve_balance") @db.Decimal(12, 2)
  percentFunded       Decimal          @map("percent_funded") @db.Decimal(5, 2)
  fullyFundedBalance  Decimal          @map("fully_funded_balance") @db.Decimal(12, 2)

  // Recommendations
  recommendedContribution Decimal      @map("recommended_contribution") @db.Decimal(12, 2)
  fundingPlanType     FundingPlanType  @map("funding_plan_type")

  // Document reference
  documentId          String?          @map("document_id")

  notes               String?          @db.Text

  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  deletedAt           DateTime?        @map("deleted_at")

  // Relations
  association         Association      @relation(fields: [associationId], references: [id], onDelete: Cascade)
  components          ReserveStudyComponent[]
  fundingSchedule     ReserveFundingSchedule[]

  @@index([associationId])
  @@index([studyDate])
  @@map("reserve_studies")
}

/// @description Snapshot of a component at the time of a study
model ReserveStudyComponent {
  id                  String           @id @default(cuid())
  studyId             String           @map("study_id")
  componentId         String           @map("component_id")

  // Snapshot values at study time
  usefulLife          Int              @map("useful_life")
  remainingLife       Int              @map("remaining_life")
  currentCost         Decimal          @map("current_cost") @db.Decimal(12, 2)
  futureCost          Decimal          @map("future_cost") @db.Decimal(12, 2)
  conditionRating     Int?             @map("condition_rating")

  // Funding allocation
  fundedAmount        Decimal          @map("funded_amount") @db.Decimal(12, 2)
  percentFunded       Decimal          @map("percent_funded") @db.Decimal(5, 2)

  createdAt           DateTime         @default(now()) @map("created_at")

  // Relations
  study               ReserveStudy     @relation(fields: [studyId], references: [id], onDelete: Cascade)
  component           ReserveComponent @relation(fields: [componentId], references: [id])

  @@unique([studyId, componentId])
  @@index([componentId])
  @@map("reserve_study_components")
}

/// @description Projected funding schedule from a reserve study
model ReserveFundingSchedule {
  id                  String       @id @default(cuid())
  studyId             String       @map("study_id")

  fiscalYear          Int          @map("fiscal_year")
  projectedBalance    Decimal      @map("projected_balance") @db.Decimal(12, 2)
  recommendedContribution Decimal  @map("recommended_contribution") @db.Decimal(12, 2)
  projectedExpenditures Decimal    @map("projected_expenditures") @db.Decimal(12, 2)
  percentFunded       Decimal      @map("percent_funded") @db.Decimal(5, 2)

  createdAt           DateTime     @default(now()) @map("created_at")

  // Relations
  study               ReserveStudy @relation(fields: [studyId], references: [id], onDelete: Cascade)

  @@unique([studyId, fiscalYear])
  @@index([studyId])
  @@map("reserve_funding_schedules")
}

// =============================================================================
// DOMAIN 12 - Compliance
// =============================================================================

/// @description Compliance requirement template (jurisdiction-based)
model ComplianceRequirement {
  id                  String                    @id @default(cuid())
  organizationId      String                    @map("organization_id")

  name                String
  description         String?                   @db.Text
  type                ComplianceRequirementType
  jurisdiction        String?                   // State/county/city code

  // Timing
  recurrence          RecurrencePattern         @default(ANNUAL)
  defaultDueDayOfYear Int?                      @map("default_due_day_of_year") // 1-365
  defaultLeadDays     Int                       @default(30) @map("default_lead_days")

  // Requirements
  requiresEvidence    Boolean                   @default(false) @map("requires_evidence")
  evidenceTypes       String[]                  @default([]) @map("evidence_types")
  statutoryReference  String?                   @map("statutory_reference")
  penaltyDescription  String?                   @map("penalty_description") @db.Text

  // Template checklist items
  checklistTemplate   Json?                     @map("checklist_template")

  isActive            Boolean                   @default(true) @map("is_active")

  createdAt           DateTime                  @default(now()) @map("created_at")
  updatedAt           DateTime                  @updatedAt @map("updated_at")
  deletedAt           DateTime?                 @map("deleted_at")

  // Relations
  organization        Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deadlines           ComplianceDeadline[]

  @@index([organizationId])
  @@index([type])
  @@index([jurisdiction])
  @@map("compliance_requirements")
}

/// @description Compliance deadline instance for an association
model ComplianceDeadline {
  id                  String              @id @default(cuid())
  associationId       String              @map("association_id")
  requirementId       String              @map("requirement_id")

  // Deadline info
  title               String
  description         String?             @db.Text
  dueDate             DateTime            @map("due_date")
  reminderDate        DateTime?           @map("reminder_date")

  // Status
  status              ComplianceStatus    @default(NOT_STARTED)
  completedAt         DateTime?           @map("completed_at")
  completedBy         String?             @map("completed_by")

  // Evidence
  evidenceDocumentIds String[]            @default([]) @map("evidence_document_ids")
  notes               String?             @db.Text

  // Recurrence tracking
  fiscalYear          Int?                @map("fiscal_year")
  recurrenceIndex     Int?                @map("recurrence_index")

  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  association         Association         @relation(fields: [associationId], references: [id], onDelete: Cascade)
  requirement         ComplianceRequirement @relation(fields: [requirementId], references: [id])
  checklistItems      ComplianceChecklistItem[]

  @@index([associationId])
  @@index([requirementId])
  @@index([dueDate])
  @@index([status])
  @@map("compliance_deadlines")
}

/// @description Checklist item for a compliance deadline
model ComplianceChecklistItem {
  id                  String              @id @default(cuid())
  deadlineId          String              @map("deadline_id")

  title               String
  description         String?
  sortOrder           Int                 @default(0) @map("sort_order")

  // Status
  isCompleted         Boolean             @default(false) @map("is_completed")
  completedAt         DateTime?           @map("completed_at")
  completedBy         String?             @map("completed_by")

  // Evidence
  evidenceDocumentId  String?             @map("evidence_document_id")
  notes               String?

  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  deadline            ComplianceDeadline  @relation(fields: [deadlineId], references: [id], onDelete: Cascade)

  @@index([deadlineId])
  @@map("compliance_checklist_items")
}

// =============================================================================
// DOMAIN 1 - Management Relationships
// =============================================================================

/// @description Contract between management company and association
model ManagementContract {
  id                  String       @id @default(cuid())
  associationId       String       @map("association_id")
  managementCompanyId String       @map("management_company_id")
  
  // Contract details
  contractNumber      String?      @map("contract_number")
  startDate           DateTime     @map("start_date")
  endDate             DateTime?    @map("end_date")
  autoRenew           Boolean      @default(false) @map("auto_renew")
  
  // Terms
  monthlyFee          Decimal?     @map("monthly_fee") @db.Decimal(10, 2)
  terms               Json?
  
  // Service levels
  serviceLevels       Json?        @map("service_levels") // { tier: "premium", sla: {...} }
  
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  association         Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  managementCompany   Organization @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([managementCompanyId])
  @@map("management_contracts")
}

// =============================================================================
// DOMAIN 1 - Manager Assignments
// =============================================================================

enum ManagerAssignmentType {
  COMMUNITY_MANAGER
  PORTFOLIO_MANAGER
  ASSISTANT_MANAGER
}

/// @description Manager assignment to associations
model ManagerAssignment {
  id              String               @id @default(cuid())
  userId          String               @map("user_id")
  associationId   String               @map("association_id")
  assignmentType  ManagerAssignmentType @map("assignment_type")
  
  // Assignment details
  isPrimary       Boolean              @default(false) @map("is_primary")
  startDate       DateTime             @map("start_date")
  endDate         DateTime?            @map("end_date")
  
  // Workload tracking
  maxUnits        Int?                 @map("max_units") // Max units this manager can handle
  notes           String?
  
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  association     Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@unique([userId, associationId, assignmentType])
  @@index([userId])
  @@index([associationId])
  @@index([endDate])
  @@map("manager_assignments")
}

// =============================================================================
// DOMAIN 3 - ACCOUNTING ENUMS
// =============================================================================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountCategory {
  // Asset categories
  CASH
  ACCOUNTS_RECEIVABLE
  PREPAID
  FIXED_ASSET
  OTHER_ASSET
  
  // Liability categories
  ACCOUNTS_PAYABLE
  ACCRUED_LIABILITY
  DEFERRED_REVENUE
  LONG_TERM_LIABILITY
  OTHER_LIABILITY
  
  // Equity categories
  RETAINED_EARNINGS
  FUND_BALANCE
  RESERVE_FUND
  
  // Revenue categories
  ASSESSMENT_INCOME
  LATE_FEE_INCOME
  INTEREST_INCOME
  OTHER_INCOME
  
  // Expense categories
  ADMINISTRATIVE
  UTILITIES
  MAINTENANCE
  INSURANCE
  PROFESSIONAL_FEES
  RESERVE_CONTRIBUTION
  OTHER_EXPENSE
}

enum FundType {
  OPERATING
  RESERVE
  SPECIAL
}

enum JournalEntryStatus {
  DRAFT
  PENDING_APPROVAL
  POSTED
  REVERSED
}

enum AssessmentFrequency {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  ONE_TIME
}

enum ChargeStatus {
  PENDING
  BILLED
  PARTIALLY_PAID
  PAID
  WRITTEN_OFF
  CREDITED
}

enum PaymentMethod {
  CHECK
  ACH
  CREDIT_CARD
  CASH
  WIRE
  OTHER
}

enum PaymentStatus {
  PENDING
  CLEARED
  BOUNCED
  REFUNDED
  VOIDED
}

enum InvoiceStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PARTIALLY_PAID
  PAID
  VOIDED
}

// =============================================================================
// DOMAIN 3 - CHART OF ACCOUNTS
// =============================================================================

/// @description General Ledger Account
model GLAccount {
  id              String          @id @default(cuid())
  associationId   String          @map("association_id")
  
  // Account identification
  accountNumber   String          @map("account_number")
  name            String
  description     String?
  
  // Classification
  accountType     AccountType     @map("account_type")
  category        AccountCategory
  fundType        FundType        @default(OPERATING) @map("fund_type")
  
  // Hierarchy
  parentId        String?         @map("parent_id")
  
  // Status
  isActive        Boolean         @default(true) @map("is_active")
  isSystemAccount Boolean         @default(false) @map("is_system_account") // Cannot be deleted
  
  // Normal balance (true = debit, false = credit)
  normalDebit     Boolean         @default(true) @map("normal_debit")
  
  // Current balance (denormalized for performance)
  currentBalance  Decimal         @default(0) @map("current_balance") @db.Decimal(15, 2)
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  deletedAt       DateTime?       @map("deleted_at")

  // Relations
  association     Association     @relation(fields: [associationId], references: [id], onDelete: Cascade)
  parent          GLAccount?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        GLAccount[]     @relation("AccountHierarchy")
  journalLines    JournalEntryLine[]
  bankAccounts    BankAccount[]
  assessmentTypes AssessmentType[] @relation("AssessmentRevenueAccount")
  lateFeeAccount  AssessmentType[] @relation("LateFeeAccount")

  @@unique([associationId, accountNumber])
  @@index([associationId])
  @@index([parentId])
  @@index([accountType])
  @@map("gl_accounts")
}

// =============================================================================
// DOMAIN 3 - JOURNAL ENTRIES
// =============================================================================

/// @description Journal Entry header
model JournalEntry {
  id              String             @id @default(cuid())
  associationId   String             @map("association_id")
  
  // Entry identification
  entryNumber     String             @map("entry_number")
  entryDate       DateTime           @map("entry_date") @db.Date
  
  // Description
  description     String
  memo            String?
  
  // Status
  status          JournalEntryStatus @default(DRAFT)
  
  // Source reference (for auto-generated entries)
  sourceType      String?            @map("source_type") // "ASSESSMENT", "PAYMENT", "INVOICE", etc.
  sourceId        String?            @map("source_id")
  
  // Reversal tracking
  isReversal      Boolean            @default(false) @map("is_reversal")
  reversedEntryId String?            @unique @map("reversed_entry_id")
  
  // Approval
  approvedBy      String?            @map("approved_by")
  approvedAt      DateTime?          @map("approved_at")
  
  // Audit
  createdBy       String             @map("created_by")
  postedAt        DateTime?          @map("posted_at")
  
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  association     Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  lines           JournalEntryLine[]
  reversedEntry   JournalEntry?      @relation("ReversalPair", fields: [reversedEntryId], references: [id])
  reversalEntry   JournalEntry?      @relation("ReversalPair")

  @@unique([associationId, entryNumber])
  @@index([associationId])
  @@index([entryDate])
  @@index([status])
  @@index([sourceType, sourceId])
  @@map("journal_entries")
}

/// @description Journal Entry line (debit or credit)
model JournalEntryLine {
  id              String       @id @default(cuid())
  journalEntryId  String       @map("journal_entry_id")
  accountId       String       @map("account_id")
  
  // Amount (positive for debit, negative for credit)
  debitAmount     Decimal?     @map("debit_amount") @db.Decimal(15, 2)
  creditAmount    Decimal?     @map("credit_amount") @db.Decimal(15, 2)
  
  // Line description
  description     String?
  
  // Reference (unit, vendor, etc.)
  referenceType   String?      @map("reference_type")
  referenceId     String?      @map("reference_id")
  
  // Line order
  lineNumber      Int          @map("line_number")
  
  createdAt       DateTime     @default(now()) @map("created_at")

  // Relations
  journalEntry    JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account         GLAccount    @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@index([referenceType, referenceId])
  @@map("journal_entry_lines")
}

// =============================================================================
// DOMAIN 3 - BANK ACCOUNTS
// =============================================================================

/// @description Bank Account linked to GL
model BankAccount {
  id              String    @id @default(cuid())
  associationId   String    @map("association_id")
  glAccountId     String    @map("gl_account_id")
  
  // Bank details
  bankName        String    @map("bank_name")
  accountName     String    @map("account_name")
  accountNumber   String    @map("account_number") // Last 4 digits only for display
  routingNumber   String?   @map("routing_number") // Encrypted or last 4
  accountType     String    @map("account_type") // "CHECKING", "SAVINGS", "MONEY_MARKET"
  
  // Fund designation
  fundType        FundType  @default(OPERATING) @map("fund_type")
  
  // Balances
  bookBalance     Decimal   @default(0) @map("book_balance") @db.Decimal(15, 2)
  bankBalance     Decimal   @default(0) @map("bank_balance") @db.Decimal(15, 2)
  lastReconciled  DateTime? @map("last_reconciled")
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  isPrimary       Boolean   @default(false) @map("is_primary")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  glAccount       GLAccount   @relation(fields: [glAccountId], references: [id])
  payments        Payment[]

  @@index([associationId])
  @@index([glAccountId])
  @@map("bank_accounts")
}

// =============================================================================
// DOMAIN 3 - ASSESSMENTS
// =============================================================================

/// @description Assessment type configuration
model AssessmentType {
  id                  String              @id @default(cuid())
  associationId       String              @map("association_id")
  
  // Type details
  name                String
  description         String?
  code                String              // Short code like "REG", "SPEC", "LATE"
  
  // Frequency
  frequency           AssessmentFrequency
  
  // Default amount (can be overridden per unit)
  defaultAmount       Decimal             @map("default_amount") @db.Decimal(10, 2)
  
  // GL mapping
  revenueAccountId    String              @map("revenue_account_id")
  lateFeeAccountId    String?             @map("late_fee_account_id")
  
  // Late fee configuration
  lateFeeAmount       Decimal?            @map("late_fee_amount") @db.Decimal(10, 2)
  lateFeePercent      Decimal?            @map("late_fee_percent") @db.Decimal(5, 2)
  gracePeriodDays     Int                 @default(15) @map("grace_period_days")
  
  // Pro-ration
  prorateOnTransfer   Boolean             @default(true) @map("prorate_on_transfer")
  
  // Status
  isActive            Boolean             @default(true) @map("is_active")
  
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  association         Association         @relation(fields: [associationId], references: [id], onDelete: Cascade)
  revenueAccount      GLAccount           @relation("AssessmentRevenueAccount", fields: [revenueAccountId], references: [id])
  lateFeeAccount      GLAccount?          @relation("LateFeeAccount", fields: [lateFeeAccountId], references: [id])
  charges             AssessmentCharge[]

  @@unique([associationId, code])
  @@index([associationId])
  @@map("assessment_types")
}

/// @description Assessment charge against a unit
model AssessmentCharge {
  id                  String       @id @default(cuid())
  associationId       String       @map("association_id")
  unitId              String       @map("unit_id")
  assessmentTypeId    String       @map("assessment_type_id")
  
  // Charge details
  chargeDate          DateTime     @map("charge_date") @db.Date
  dueDate             DateTime     @map("due_date") @db.Date
  periodStart         DateTime?    @map("period_start") @db.Date
  periodEnd           DateTime?    @map("period_end") @db.Date
  
  // Amounts
  amount              Decimal      @db.Decimal(10, 2)
  lateFeeAmount       Decimal      @default(0) @map("late_fee_amount") @db.Decimal(10, 2)
  totalAmount         Decimal      @map("total_amount") @db.Decimal(10, 2) // amount + lateFeeAmount
  paidAmount          Decimal      @default(0) @map("paid_amount") @db.Decimal(10, 2)
  balanceDue          Decimal      @map("balance_due") @db.Decimal(10, 2) // totalAmount - paidAmount
  
  // Status
  status              ChargeStatus @default(PENDING)
  
  // Late fee tracking
  lateFeeApplied      Boolean      @default(false) @map("late_fee_applied")
  lateFeeDate         DateTime?    @map("late_fee_date")
  
  // GL posting
  journalEntryId      String?      @map("journal_entry_id")
  
  // Notes
  description         String?
  
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  association         Association      @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit                Unit             @relation(fields: [unitId], references: [id])
  assessmentType      AssessmentType   @relation(fields: [assessmentTypeId], references: [id])
  paymentApplications PaymentApplication[]

  @@index([associationId])
  @@index([unitId])
  @@index([assessmentTypeId])
  @@index([dueDate])
  @@index([status])
  @@map("assessment_charges")
}

// =============================================================================
// DOMAIN 3 - PAYMENTS (AR)
// =============================================================================

/// @description Payment received from owner/tenant
model Payment {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  unitId          String        @map("unit_id")
  
  // Payment details
  paymentDate     DateTime      @map("payment_date") @db.Date
  amount          Decimal       @db.Decimal(10, 2)
  
  // Method
  paymentMethod   PaymentMethod @map("payment_method")
  referenceNumber String?       @map("reference_number") // Check number, transaction ID
  
  // Bank account (where deposited)
  bankAccountId   String?       @map("bank_account_id")
  
  // Payer info
  payerName       String?       @map("payer_name")
  payerPartyId    String?       @map("payer_party_id")
  
  // Status
  status          PaymentStatus @default(PENDING)
  
  // Application tracking
  appliedAmount   Decimal       @default(0) @map("applied_amount") @db.Decimal(10, 2)
  unappliedAmount Decimal       @map("unapplied_amount") @db.Decimal(10, 2) // amount - appliedAmount
  
  // GL posting
  journalEntryId  String?       @map("journal_entry_id")
  
  // Notes
  memo            String?
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit          @relation(fields: [unitId], references: [id])
  bankAccount     BankAccount?  @relation(fields: [bankAccountId], references: [id])
  payerParty      Party?        @relation(fields: [payerPartyId], references: [id])
  applications    PaymentApplication[]

  @@index([associationId])
  @@index([unitId])
  @@index([paymentDate])
  @@index([status])
  @@map("payments")
}

/// @description Payment application to charges
model PaymentApplication {
  id              String           @id @default(cuid())
  paymentId       String           @map("payment_id")
  chargeId        String           @map("charge_id")
  
  // Amount applied
  amount          Decimal          @db.Decimal(10, 2)
  
  // Application date
  appliedAt       DateTime         @default(now()) @map("applied_at")
  
  createdAt       DateTime         @default(now()) @map("created_at")

  // Relations
  payment         Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  charge          AssessmentCharge @relation(fields: [chargeId], references: [id])

  @@index([paymentId])
  @@index([chargeId])
  @@map("payment_applications")
}

// =============================================================================
// DOMAIN 3 - ACCOUNTS PAYABLE
// =============================================================================

/// @description Vendor (service provider for AP)
model Vendor {
  id              String    @id @default(cuid())
  associationId   String    @map("association_id")
  
  // Vendor details
  name            String
  dba             String?   // Doing business as
  
  // Contact
  contactName     String?   @map("contact_name")
  email           String?   @db.Citext
  phone           String?
  
  // Address
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  
  // Tax info
  taxId           String?   @map("tax_id") // EIN or SSN (encrypted)
  w9OnFile        Boolean   @default(false) @map("w9_on_file")
  is1099Eligible  Boolean   @default(false) @map("is_1099_eligible")
  
  // Payment info
  paymentTerms    Int       @default(30) @map("payment_terms") // Net days
  defaultGLAccountId String? @map("default_gl_account_id")
  
  // Link to service provider organization (if on platform)
  serviceProviderOrgId String? @map("service_provider_org_id")
  
  // Phase 2: Compliance fields
  approvalStatus        VendorApprovalStatus @default(PENDING) @map("approval_status")
  approvedAt            DateTime?   @map("approved_at")
  approvedBy            String?     @map("approved_by")
  insuranceVerified     Boolean     @default(false) @map("insurance_verified")
  insuranceExpiresAt    DateTime?   @map("insurance_expires_at")
  licenseVerified       Boolean     @default(false) @map("license_verified")
  licenseExpiresAt      DateTime?   @map("license_expires_at")
  complianceNotes       String?     @map("compliance_notes") @db.Text
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  invoices        APInvoice[]
  
  // Phase 4: Work Orders
  workOrders      WorkOrder[]
  bids            WorkOrderBid[]

  // Phase 14: Service Provider Links
  serviceProviderLinks ServiceProviderLink[]

  @@index([associationId])
  @@index([email])
  @@index([approvalStatus])
  @@map("vendors")
}

/// @description Accounts Payable Invoice
model APInvoice {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  vendorId        String        @map("vendor_id")
  
  // Invoice details
  invoiceNumber   String        @map("invoice_number")
  invoiceDate     DateTime      @map("invoice_date") @db.Date
  dueDate         DateTime      @map("due_date") @db.Date
  
  // Amounts
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount     Decimal       @map("total_amount") @db.Decimal(10, 2)
  paidAmount      Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  balanceDue      Decimal       @map("balance_due") @db.Decimal(10, 2)
  
  // Status
  status          InvoiceStatus @default(DRAFT)
  
  // Approval workflow
  approvedBy      String?       @map("approved_by")
  approvedAt      DateTime?     @map("approved_at")
  
  // GL posting
  journalEntryId  String?       @map("journal_entry_id")
  
  // Reference
  description     String?
  memo            String?
  
  // Work order link (if applicable)
  workOrderId     String?       @map("work_order_id")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  lineItems       APInvoiceLine[]

  @@unique([associationId, vendorId, invoiceNumber])
  @@index([associationId])
  @@index([vendorId])
  @@index([dueDate])
  @@index([status])
  @@map("ap_invoices")
}

/// @description AP Invoice line item
model APInvoiceLine {
  id              String    @id @default(cuid())
  invoiceId       String    @map("invoice_id")
  
  // Line details
  description     String
  quantity        Decimal   @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal   @map("unit_price") @db.Decimal(10, 2)
  amount          Decimal   @db.Decimal(10, 2)
  
  // GL account
  glAccountId     String    @map("gl_account_id")
  
  // Line order
  lineNumber      Int       @map("line_number")
  
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  invoice         APInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("ap_invoice_lines")
}

// =============================================================================
// PHASE 4: WORK ORDERS & ASSET MANAGEMENT
// =============================================================================

/// @description Physical asset (equipment, systems, common area items)
model Asset {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  
  // Asset identification
  assetNumber     String        @map("asset_number")
  name            String
  description     String?
  
  // Classification
  category        AssetCategory
  status          AssetStatus   @default(ACTIVE)
  
  // Location - either unit or common area
  unitId          String?       @map("unit_id")
  commonAreaName  String?       @map("common_area_name") // e.g., "Pool House", "Clubhouse"
  locationDetails String?       @map("location_details") // Specific location within
  
  // Asset details
  manufacturer    String?
  model           String?
  serialNumber    String?       @map("serial_number")
  
  // Dates
  purchaseDate    DateTime?     @map("purchase_date") @db.Date
  installDate     DateTime?     @map("install_date") @db.Date
  
  // Warranty
  warrantyExpires DateTime?     @map("warranty_expires") @db.Date
  warrantyDetails String?       @map("warranty_details")
  
  // Financial
  purchaseCost    Decimal?      @map("purchase_cost") @db.Decimal(10, 2)
  currentValue    Decimal?      @map("current_value") @db.Decimal(10, 2)
  
  // Maintenance schedule
  maintenanceFrequencyDays Int? @map("maintenance_frequency_days")
  lastMaintenanceDate DateTime? @map("last_maintenance_date") @db.Date
  nextMaintenanceDate DateTime? @map("next_maintenance_date") @db.Date
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit?         @relation(fields: [unitId], references: [id])
  workOrders      WorkOrder[]
  maintenanceHistory AssetMaintenanceLog[]

  @@unique([associationId, assetNumber])
  @@index([associationId])
  @@index([unitId])
  @@index([category])
  @@index([status])
  @@map("assets")
}

/// @description Asset maintenance history log
model AssetMaintenanceLog {
  id              String    @id @default(cuid())
  assetId         String    @map("asset_id")
  
  // Maintenance details
  maintenanceDate DateTime  @map("maintenance_date") @db.Date
  maintenanceType String    @map("maintenance_type") // Routine, Repair, Inspection, etc.
  description     String
  performedBy     String?   @map("performed_by") // Vendor name or internal
  
  // Cost
  cost            Decimal?  @db.Decimal(10, 2)
  
  // Work order reference
  workOrderId     String?   @map("work_order_id")
  
  // Notes
  notes           String?
  
  createdAt       DateTime  @default(now()) @map("created_at")
  createdBy       String    @map("created_by")

  // Relations
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  workOrder       WorkOrder? @relation(fields: [workOrderId], references: [id])

  @@index([assetId])
  @@index([maintenanceDate])
  @@map("asset_maintenance_logs")
}

/// @description Service provider capabilities and service areas
model ServiceProviderProfile {
  id                    String    @id @default(cuid())
  organizationId        String    @unique @map("organization_id") // Links to SERVICE_PROVIDER org
  
  // Business info
  businessName          String    @map("business_name")
  description           String?
  
  // Service categories (what they do)
  serviceCategories     String[]  @map("service_categories") // Array of AssetCategory values
  
  // Service area (where they work)
  serviceAreaRadius     Int?      @map("service_area_radius") // Miles from base
  serviceZipCodes       String[]  @map("service_zip_codes")
  
  // Compliance
  insuranceExpires      DateTime? @map("insurance_expires") @db.Date
  insuranceAmount       Decimal?  @map("insurance_amount") @db.Decimal(12, 2)
  licenseNumber         String?   @map("license_number")
  licenseExpires        DateTime? @map("license_expires") @db.Date
  bondedAmount          Decimal?  @map("bonded_amount") @db.Decimal(12, 2)
  
  // Ratings
  averageRating         Decimal?  @map("average_rating") @db.Decimal(2, 1)
  totalReviews          Int       @default(0) @map("total_reviews")
  
  // Status
  isVerified            Boolean   @default(false) @map("is_verified")
  isActive              Boolean   @default(true) @map("is_active")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  associationRelationships AssociationServiceProvider[]

  @@index([serviceCategories])
  @@map("service_provider_profiles")
}

/// @description Association-to-Service Provider relationship
model AssociationServiceProvider {
  id                    String    @id @default(cuid())
  associationId         String    @map("association_id")
  serviceProviderId     String    @map("service_provider_id")
  
  // Relationship status
  isPreferred           Boolean   @default(false) @map("is_preferred")
  isApproved            Boolean   @default(true) @map("is_approved")
  isBlocked             Boolean   @default(false) @map("is_blocked")
  
  // Contract info
  contractStartDate     DateTime? @map("contract_start_date") @db.Date
  contractEndDate       DateTime? @map("contract_end_date") @db.Date
  
  // Notes
  notes                 String?
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  association           Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  serviceProvider       ServiceProviderProfile @relation(fields: [serviceProviderId], references: [id])

  @@unique([associationId, serviceProviderId])
  @@index([associationId])
  @@index([serviceProviderId])
  @@map("association_service_providers")
}

/// @description Work order for maintenance, repairs, and services
model WorkOrder {
  id              String            @id @default(cuid())
  associationId   String            @map("association_id")
  
  // Work order identification
  workOrderNumber String            @map("work_order_number")
  
  // Classification
  category        WorkOrderCategory
  priority        WorkOrderPriority @default(MEDIUM)
  status          WorkOrderStatus   @default(DRAFT)
  
  // Request details
  title           String
  description     String
  
  // Location - unit, common area, or asset
  unitId          String?           @map("unit_id")
  commonAreaName  String?           @map("common_area_name")
  assetId         String?           @map("asset_id")
  locationDetails String?           @map("location_details")
  
  // Requestor
  requestedBy     String            @map("requested_by") // User ID
  requestedAt     DateTime          @default(now()) @map("requested_at")
  
  // Assignment
  assignedVendorId String?          @map("assigned_vendor_id")
  assignedAt      DateTime?         @map("assigned_at")
  assignedBy      String?           @map("assigned_by")
  
  // Scheduling
  scheduledStart  DateTime?         @map("scheduled_start")
  scheduledEnd    DateTime?         @map("scheduled_end")
  
  // Execution
  startedAt       DateTime?         @map("started_at")
  completedAt     DateTime?         @map("completed_at")
  
  // Closure
  closedAt        DateTime?         @map("closed_at")
  closedBy        String?           @map("closed_by")
  
  // Estimated vs actual
  estimatedCost   Decimal?          @map("estimated_cost") @db.Decimal(10, 2)
  actualCost      Decimal?          @map("actual_cost") @db.Decimal(10, 2)
  estimatedHours  Decimal?          @map("estimated_hours") @db.Decimal(5, 2)
  actualHours     Decimal?          @map("actual_hours") @db.Decimal(5, 2)
  
  // Resolution
  resolutionNotes String?           @map("resolution_notes")
  
  // AP Integration
  invoiceId       String?           @map("invoice_id")
  
  // SLA tracking
  slaDeadline     DateTime?         @map("sla_deadline")
  slaMet          Boolean?          @map("sla_met")
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  association     Association       @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit?             @relation(fields: [unitId], references: [id])
  asset           Asset?            @relation(fields: [assetId], references: [id])
  assignedVendor  Vendor?           @relation(fields: [assignedVendorId], references: [id])
  statusHistory   WorkOrderStatusHistory[]
  comments        WorkOrderComment[]
  attachments     WorkOrderAttachment[]
  bids            WorkOrderBid[]
  maintenanceLogs AssetMaintenanceLog[]

  // Phase 9: Owner Portal / CRM
  ownerRequests   OwnerRequest[]

  @@unique([associationId, workOrderNumber])
  @@index([associationId])
  @@index([unitId])
  @@index([assetId])
  @@index([assignedVendorId])
  @@index([status])
  @@index([priority])
  @@index([requestedAt])
  @@map("work_orders")
}

/// @description Work order status change history
model WorkOrderStatusHistory {
  id              String          @id @default(cuid())
  workOrderId     String          @map("work_order_id")
  
  // Status change
  fromStatus      WorkOrderStatus? @map("from_status")
  toStatus        WorkOrderStatus @map("to_status")
  
  // Who and when
  changedBy       String          @map("changed_by")
  changedAt       DateTime        @default(now()) @map("changed_at")
  
  // Notes
  notes           String?

  // Relations
  workOrder       WorkOrder       @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([changedAt])
  @@map("work_order_status_history")
}

/// @description Work order comments/notes
model WorkOrderComment {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  
  // Comment
  comment         String
  isInternal      Boolean   @default(false) @map("is_internal") // Internal vs visible to all
  
  // Author
  authorId        String    @map("author_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_comments")
}

/// @description Work order attachments (photos, documents)
model WorkOrderAttachment {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  
  // File info
  fileName        String    @map("file_name")
  fileType        String    @map("file_type") // MIME type
  fileSize        Int       @map("file_size") // Bytes
  fileUrl         String    @map("file_url")
  
  // Metadata
  description     String?
  uploadedBy      String    @map("uploaded_by")
  uploadedAt      DateTime  @default(now()) @map("uploaded_at")
  
  // Type
  attachmentType  String    @map("attachment_type") // PHOTO, DOCUMENT, INVOICE, etc.

  // Relations
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_attachments")
}

/// @description Vendor bid for a work order
model WorkOrderBid {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  vendorId        String    @map("vendor_id")
  
  // Bid details
  status          BidStatus @default(REQUESTED)
  
  // Pricing
  laborCost       Decimal?  @map("labor_cost") @db.Decimal(10, 2)
  materialsCost   Decimal?  @map("materials_cost") @db.Decimal(10, 2)
  totalAmount     Decimal?  @map("total_amount") @db.Decimal(10, 2)
  
  // Timeline
  estimatedHours  Decimal?  @map("estimated_hours") @db.Decimal(5, 2)
  proposedStartDate DateTime? @map("proposed_start_date")
  proposedEndDate DateTime? @map("proposed_end_date")
  
  // Bid validity
  validUntil      DateTime? @map("valid_until")
  
  // Notes
  notes           String?
  
  // Timestamps
  requestedAt     DateTime  @default(now()) @map("requested_at")
  submittedAt     DateTime? @map("submitted_at")
  respondedAt     DateTime? @map("responded_at") // When accepted/rejected
  respondedBy     String?   @map("responded_by")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  vendor          Vendor    @relation(fields: [vendorId], references: [id])

  @@unique([workOrderId, vendorId])
  @@index([workOrderId])
  @@index([vendorId])
  @@index([status])
  @@map("work_order_bids")
}

// =============================================================================
// PHASE 5: VIOLATIONS
// =============================================================================

/// @description Notice template for violation notices
model NoticeTemplate {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")
  
  // Template details
  name            String
  noticeType      NoticeType  @map("notice_type")
  subject         String
  bodyTemplate    String      @map("body_template") @db.Text // Supports {{variable}} placeholders
  
  // Settings
  defaultCurePeriodDays Int?  @map("default_cure_period_days")
  isActive        Boolean     @default(true) @map("is_active")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  sequenceSteps   NoticeSequenceStep[]

  @@unique([associationId, name])
  @@index([associationId])
  @@index([noticeType])
  @@map("notice_templates")
}

/// @description Notice sequence configuration per violation type
model NoticeSequenceConfig {
  id              String      @id @default(cuid())
  violationTypeId String      @map("violation_type_id")
  
  // Sequence details
  name            String      // e.g., "Standard Escalation"
  description     String?
  isDefault       Boolean     @default(false) @map("is_default")
  isActive        Boolean     @default(true) @map("is_active")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violationType   ViolationType @relation(fields: [violationTypeId], references: [id], onDelete: Cascade)
  steps           NoticeSequenceStep[]

  @@index([violationTypeId])
  @@map("notice_sequence_configs")
}

/// @description Steps in a notice sequence
model NoticeSequenceStep {
  id              String      @id @default(cuid())
  sequenceId      String      @map("sequence_id")
  templateId      String      @map("template_id")
  
  // Step configuration
  stepOrder       Int         @map("step_order")
  daysAfterPrevious Int       @default(0) @map("days_after_previous") // Days to wait after previous step
  requiresCure    Boolean     @default(true) @map("requires_cure") // If true, skip if cured
  autoSend        Boolean     @default(false) @map("auto_send") // If true, send automatically
  
  // Fine escalation
  assessFine      Boolean     @default(false) @map("assess_fine")
  fineAmount      Decimal?    @db.Decimal(10, 2) @map("fine_amount")
  
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  sequence        NoticeSequenceConfig @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  template        NoticeTemplate @relation(fields: [templateId], references: [id])

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
  @@map("notice_sequence_steps")
}

/// @description Appeal filed against a hearing decision
model ViolationAppeal {
  id              String      @id @default(cuid())
  hearingId       String      @map("hearing_id")
  
  // Appeal details
  filedDate       DateTime    @map("filed_date")
  filedBy         String      @map("filed_by") // Party ID
  reason          String      @db.Text
  
  // Supporting documents
  documentsJson   String?     @map("documents_json") @db.Text // JSON array of document URLs
  
  // Appeal hearing
  appealHearingDate DateTime? @map("appeal_hearing_date")
  appealHearingLocation String? @map("appeal_hearing_location")
  
  // Outcome
  status          AppealStatus @default(PENDING)
  decisionDate    DateTime?   @map("decision_date")
  decisionBy      String?     @map("decision_by")
  decisionNotes   String?     @map("decision_notes") @db.Text
  
  // If fine modified
  originalFineAmount Decimal? @db.Decimal(10, 2) @map("original_fine_amount")
  revisedFineAmount  Decimal? @db.Decimal(10, 2) @map("revised_fine_amount")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  hearing         ViolationHearing @relation(fields: [hearingId], references: [id], onDelete: Cascade)

  @@index([hearingId])
  @@index([status])
  @@map("violation_appeals")
}

/// @description Violation type configuration per association
model ViolationType {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")
  
  // Type details
  code            String      // e.g., "PARKING-001"
  name            String      // e.g., "Unauthorized Parking"
  description     String?
  category        String      // e.g., "Parking", "Landscaping", "Noise"
  
  // CC&R reference
  ccnrSection     String?     @map("ccnr_section") // Reference to governing docs
  ruleReference   String?     @map("rule_reference")
  
  // Default settings
  defaultSeverity ViolationSeverity @default(MODERATE) @map("default_severity")
  defaultCurePeriodDays Int   @default(14) @map("default_cure_period_days")
  
  // Fine schedule (can be overridden per violation)
  firstFineAmount   Decimal?  @db.Decimal(10, 2) @map("first_fine_amount")
  secondFineAmount  Decimal?  @db.Decimal(10, 2) @map("second_fine_amount")
  subsequentFineAmount Decimal? @db.Decimal(10, 2) @map("subsequent_fine_amount")
  maxFineAmount     Decimal?  @db.Decimal(10, 2) @map("max_fine_amount")
  
  // Notice template references
  warningTemplateId String?   @map("warning_template_id")
  noticeTemplateId  String?   @map("notice_template_id")
  
  isActive        Boolean     @default(true) @map("is_active")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  violations      Violation[]
  noticeSequences NoticeSequenceConfig[]

  @@unique([associationId, code])
  @@index([associationId])
  @@index([category])
  @@map("violation_types")
}

/// @description Individual violation instance
model Violation {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")
  
  // Violation identification
  violationNumber String      @map("violation_number") // e.g., "VIO-2024-000001"
  violationTypeId String      @map("violation_type_id")
  
  // Location
  unitId          String?     @map("unit_id")
  commonAreaName  String?     @map("common_area_name")
  locationDetails String?     @map("location_details")
  
  // Violation details
  title           String
  description     String      @db.Text
  severity        ViolationSeverity
  status          ViolationStatus @default(DRAFT)
  
  // Dates
  observedDate    DateTime    @map("observed_date")
  reportedDate    DateTime    @default(now()) @map("reported_date")
  curePeriodEnds  DateTime?   @map("cure_period_ends")
  curedDate       DateTime?   @map("cured_date")
  closedDate      DateTime?   @map("closed_date")
  
  // Responsible party
  responsiblePartyId String?  @map("responsible_party_id") // Party ID (owner)
  
  // Reporter
  reportedBy      String      @map("reported_by") // User ID
  reporterType    String?     @map("reporter_type") // "STAFF", "RESIDENT", "ANONYMOUS"
  
  // Fine tracking
  totalFinesAssessed Decimal  @default(0) @db.Decimal(10, 2) @map("total_fines_assessed")
  totalFinesPaid     Decimal  @default(0) @db.Decimal(10, 2) @map("total_fines_paid")
  totalFinesWaived   Decimal  @default(0) @db.Decimal(10, 2) @map("total_fines_waived")
  
  // Notice tracking
  noticeCount     Int         @default(0) @map("notice_count")
  lastNoticeDate  DateTime?   @map("last_notice_date")
  lastNoticeType  NoticeType? @map("last_notice_type")
  
  // Resolution
  resolutionNotes String?     @map("resolution_notes") @db.Text
  closedBy        String?     @map("closed_by")
  
  // Soft delete
  deletedAt       DateTime?   @map("deleted_at")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  violationType   ViolationType @relation(fields: [violationTypeId], references: [id])
  unit            Unit?       @relation(fields: [unitId], references: [id])
  responsibleParty Party?     @relation(fields: [responsiblePartyId], references: [id])
  
  evidence        ViolationEvidence[]
  notices         ViolationNotice[]
  hearings        ViolationHearing[]
  fines           ViolationFine[]
  statusHistory   ViolationStatusHistory[]

  @@index([associationId])
  @@index([violationTypeId])
  @@index([unitId])
  @@index([status])
  @@index([observedDate])
  @@index([responsiblePartyId])
  @@map("violations")
}

/// @description Evidence attached to a violation
model ViolationEvidence {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Evidence details
  evidenceType    String      // "PHOTO", "VIDEO", "DOCUMENT", "AUDIO"
  fileName        String      @map("file_name")
  fileUrl         String      @map("file_url")
  fileSize        Int?        @map("file_size")
  mimeType        String?     @map("mime_type")
  
  // Metadata
  description     String?
  capturedAt      DateTime?   @map("captured_at")
  capturedBy      String?     @map("captured_by") // User ID
  gpsLatitude     Decimal?    @db.Decimal(10, 8) @map("gps_latitude")
  gpsLongitude    Decimal?    @db.Decimal(11, 8) @map("gps_longitude")
  
  // Chain of custody
  uploadedBy      String      @map("uploaded_by")
  uploadedAt      DateTime    @default(now()) @map("uploaded_at")
  
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@map("violation_evidence")
}

/// @description Notices sent for a violation
model ViolationNotice {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Notice details
  noticeType      NoticeType  @map("notice_type")
  noticeNumber    Int         @map("notice_number") // Sequence number for this violation
  
  // Content
  subject         String
  body            String      @db.Text
  
  // Delivery
  deliveryMethod  NoticeDeliveryMethod @map("delivery_method")
  recipientName   String      @map("recipient_name")
  recipientAddress String?    @map("recipient_address")
  recipientEmail  String?     @map("recipient_email")
  
  // Dates
  sentDate        DateTime    @map("sent_date")
  deliveredDate   DateTime?   @map("delivered_date")
  curePeriodDays  Int?        @map("cure_period_days")
  curePeriodEnds  DateTime?   @map("cure_period_ends")
  
  // Tracking
  trackingNumber  String?     @map("tracking_number") // For certified mail
  deliveryConfirmed Boolean   @default(false) @map("delivery_confirmed")
  
  // Sender
  sentBy          String      @map("sent_by")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([noticeType])
  @@map("violation_notices")
}

/// @description Hearings scheduled for violations
model ViolationHearing {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Hearing details
  hearingDate     DateTime    @map("hearing_date")
  hearingTime     String?     @map("hearing_time")
  location        String?
  
  // Participants
  hearingOfficer  String?     @map("hearing_officer")
  attendees       String?     @db.Text // JSON array of attendee names
  
  // Outcome
  outcome         HearingOutcome @default(PENDING)
  outcomeNotes    String?     @map("outcome_notes") @db.Text
  fineAssessed    Decimal?    @db.Decimal(10, 2) @map("fine_assessed")
  fineWaived      Decimal?    @db.Decimal(10, 2) @map("fine_waived")
  
  // Appeal
  appealDeadline  DateTime?   @map("appeal_deadline")
  appealFiled     Boolean     @default(false) @map("appeal_filed")
  appealDate      DateTime?   @map("appeal_date")
  
  // Recording
  recordedBy      String?     @map("recorded_by")
  recordedAt      DateTime?   @map("recorded_at")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)
  appeals         ViolationAppeal[]

  @@index([violationId])
  @@index([hearingDate])
  @@map("violation_hearings")
}

/// @description Fines assessed for violations
model ViolationFine {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Fine details
  fineNumber      Int         @map("fine_number") // Sequence for this violation
  amount          Decimal     @db.Decimal(10, 2)
  reason          String?
  
  // Status
  assessedDate    DateTime    @map("assessed_date")
  dueDate         DateTime    @map("due_date")
  paidAmount      Decimal     @default(0) @db.Decimal(10, 2) @map("paid_amount")
  waivedAmount    Decimal     @default(0) @db.Decimal(10, 2) @map("waived_amount")
  balanceDue      Decimal     @db.Decimal(10, 2) @map("balance_due")
  
  // Waiver
  waivedBy        String?     @map("waived_by")
  waivedDate      DateTime?   @map("waived_date")
  waiverReason    String?     @map("waiver_reason")
  
  // GL Integration
  assessmentChargeId String?  @map("assessment_charge_id") // Link to AssessmentCharge
  glPosted        Boolean     @default(false) @map("gl_posted")
  
  // Assessed by
  assessedBy      String      @map("assessed_by")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([assessedDate])
  @@map("violation_fines")
}

/// @description Status history for violations
model ViolationStatusHistory {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  fromStatus      ViolationStatus? @map("from_status")
  toStatus        ViolationStatus  @map("to_status")
  changedBy       String      @map("changed_by")
  changedAt       DateTime    @default(now()) @map("changed_at")
  notes           String?
  
  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@map("violation_status_history")
}

// =============================================================================
// PHASE 6: ARC (Architectural Requests)
// =============================================================================

/// @description Architectural change request
model ARCRequest {
  id              String            @id @default(cuid())
  associationId   String            @map("association_id")
  committeeId     String?           @map("committee_id")
  unitId          String?           @map("unit_id")
  requesterPartyId String           @map("requester_party_id")

  // Identification
  requestNumber   String            @map("request_number")

  // Details
  title           String
  description     String            @db.Text
  category        ARCCategory
  status          ARCRequestStatus  @default(DRAFT)
  estimatedCost   Decimal?          @db.Decimal(12, 2) @map("estimated_cost")
  proposedStartDate DateTime?       @map("proposed_start_date")
  proposedEndDate DateTime?         @map("proposed_end_date")
  conditions      String?           @db.Text // Conditions of approval

  // Timeline
  submittedAt     DateTime?         @map("submitted_at")
  reviewedAt      DateTime?         @map("reviewed_at")
  decisionDate    DateTime?         @map("decision_date")
  expiresAt       DateTime?         @map("expires_at")
  withdrawnAt     DateTime?         @map("withdrawn_at")
  cancellationReason String?        @map("cancellation_reason")

  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  association     Association       @relation(fields: [associationId], references: [id], onDelete: Cascade)
  committee       ARCCommittee?     @relation(fields: [committeeId], references: [id])
  unit            Unit?             @relation(fields: [unitId], references: [id])
  requesterParty  Party             @relation("PartyARCRequests", fields: [requesterPartyId], references: [id])
  documents       ARCDocument[]
  reviews         ARCReview[]

  @@unique([associationId, requestNumber])
  @@index([associationId])
  @@index([committeeId])
  @@index([unitId])
  @@index([requesterPartyId])
  @@index([status])
  @@map("arc_requests")
}

/// @description Documents attached to an ARC request
model ARCDocument {
  id              String          @id @default(cuid())
  requestId       String          @map("request_id")

  documentType    ARCDocumentType @map("document_type")
  fileName        String          @map("file_name")
  fileUrl         String          @map("file_url")
  fileSize        Int?            @map("file_size")
  mimeType        String?         @map("mime_type")
  description     String?
  version         String?         // Optional version label

  uploadedBy      String          @map("uploaded_by") // User ID
  uploadedAt      DateTime        @default(now()) @map("uploaded_at")

  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  request         ARCRequest      @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("arc_documents")
}

/// @description ARC committee configuration
model ARCCommittee {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")

  name            String
  description     String?
  approvalThreshold Decimal   @db.Decimal(5, 2) @map("approval_threshold") // e.g., 50.00 for majority
  quorum          Int?
  isActive        Boolean     @default(true) @map("is_active")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  members         ARCCommitteeMember[]
  requests        ARCRequest[]

  @@index([associationId])
  @@map("arc_committees")
}

/// @description Members of an ARC committee
model ARCCommitteeMember {
  id              String      @id @default(cuid())
  committeeId     String      @map("committee_id")
  partyId         String      @map("party_id")

  role            String?
  isChair         Boolean     @default(false) @map("is_chair")
  joinedAt        DateTime    @default(now()) @map("joined_at")
  leftAt          DateTime?   @map("left_at")

  // Relations
  committee       ARCCommittee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  party           Party        @relation(fields: [partyId], references: [id])

  @@unique([committeeId, partyId])
  @@index([partyId])
  @@map("arc_committee_members")
}

/// @description Reviews/decisions recorded for an ARC request
model ARCReview {
  id              String          @id @default(cuid())
  requestId       String          @map("request_id")
  reviewerId      String          @map("reviewer_id") // User ID
  action          ARCReviewAction
  notes           String?         @db.Text
  conditions      String?         @db.Text
  expiresAt       DateTime?       @map("expires_at") // For conditional approvals
  decidedAt       DateTime        @default(now()) @map("decided_at")
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  request         ARCRequest      @relation(fields: [requestId], references: [id], onDelete: Cascade)
  reviewer        User            @relation(fields: [reviewerId], references: [id])

  @@index([requestId])
  @@index([reviewerId])
  @@map("arc_reviews")
}

// =============================================================================
// PHASE 7: Governance
// =============================================================================

/// @description Board for an association
model Board {
  id            String      @id @default(cuid())
  associationId String      @map("association_id")

  name          String
  description   String?

  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  association   Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  members       BoardMember[]
  meetings      Meeting[]
  resolutions   Resolution[]
  history       BoardHistory[]

  @@index([associationId])
  @@map("boards")
}

/// @description Board membership with roles and terms
model BoardMember {
  id         String      @id @default(cuid())
  boardId    String      @map("board_id")
  partyId    String      @map("party_id")

  role       BoardRole
  termStart  DateTime    @map("term_start")
  termEnd    DateTime?   @map("term_end")
  isActive   Boolean     @default(true) @map("is_active")

  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  // Relations
  board      Board       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  party      Party       @relation(fields: [partyId], references: [id])

  @@unique([boardId, partyId, termStart])
  @@index([partyId])
  @@map("board_members")
}

/// @description Meetings for governance (board, annual, special)
model Meeting {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  boardId         String?       @map("board_id")

  type            MeetingType
  status          MeetingStatus @default(SCHEDULED)
  title           String
  description     String?       @db.Text
  scheduledFor    DateTime      @map("scheduled_for")
  location        String?

  createdBy       String        @map("created_by") // User ID
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  board           Board?        @relation(fields: [boardId], references: [id])
  agendaItems     MeetingAgendaItem[]
  minutes         MeetingMinutes?
  attendance      MeetingAttendance[]
  votes           Vote[]

  @@index([associationId])
  @@index([boardId])
  @@index([scheduledFor])
  @@map("meetings")
}

/// @description Agenda items for a meeting
model MeetingAgendaItem {
  id          String    @id @default(cuid())
  meetingId   String    @map("meeting_id")

  title       String
  description String?   @db.Text
  order       Int       @default(0)

  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  meeting     Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  votes       Vote[]

  @@index([meetingId])
  @@map("meeting_agenda_items")
}

/// @description Minutes recorded for a meeting
model MeetingMinutes {
  id           String    @id @default(cuid())
  meetingId    String    @unique @map("meeting_id")
  recordedBy   String    @map("recorded_by") // User ID
  content      String    @db.Text

  recordedAt   DateTime  @default(now()) @map("recorded_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  meeting      Meeting   @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("meeting_minutes")
}

/// @description Attendance records for a meeting
model MeetingAttendance {
  id             String                   @id @default(cuid())
  meetingId      String                   @map("meeting_id")
  partyId        String                   @map("party_id")
  status         MeetingAttendanceStatus  @default(PRESENT)
  proxyForPartyId String?                 @map("proxy_for_party_id")
  checkedInAt    DateTime?                @map("checked_in_at")

  createdAt      DateTime                 @default(now()) @map("created_at")

  // Relations
  meeting        Meeting                  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  party          Party                    @relation(fields: [partyId], references: [id])

  @@unique([meetingId, partyId])
  @@index([proxyForPartyId])
  @@map("meeting_attendance")
}

/// @description Vote session within a meeting
model Vote {
  id             String       @id @default(cuid())
  meetingId      String       @map("meeting_id")
  agendaItemId   String?      @map("agenda_item_id")

  question       String
  method         VoteMethod   @default(IN_PERSON)
  createdBy      String       @map("created_by") // User ID
  quorumRequired Int?         @map("quorum_required")
  closedAt       DateTime?    @map("closed_at")

  createdAt      DateTime     @default(now()) @map("created_at")

  // Relations
  meeting        Meeting      @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  agendaItem     MeetingAgendaItem? @relation(fields: [agendaItemId], references: [id])
  ballots        VoteBallot[]

  @@index([meetingId])
  @@index([agendaItemId])
  @@map("votes")
}

/// @description Ballots cast for a vote
model VoteBallot {
  id           String      @id @default(cuid())
  voteId       String      @map("vote_id")
  voterPartyId String      @map("voter_party_id")
  choice       VoteChoice
  castAt       DateTime    @default(now()) @map("cast_at")

  // Relations
  vote         Vote        @relation(fields: [voteId], references: [id], onDelete: Cascade)
  voterParty   Party       @relation(fields: [voterPartyId], references: [id])

  @@unique([voteId, voterPartyId])
  @@index([voterPartyId])
  @@map("vote_ballots")
}

/// @description Audit trail for board changes
model BoardHistory {
  id         String    @id @default(cuid())
  boardId    String    @map("board_id")
  changeType String
  detail     Json?
  changedBy  String?   @map("changed_by") // User ID

  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  board      Board     @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@map("board_history")
}

/// @description Formal resolutions adopted by an association
model Resolution {
  id             String            @id @default(cuid())
  associationId  String            @map("association_id")
  boardId        String?           @map("board_id")
  title          String
  summary        String?           @db.Text
  status         ResolutionStatus  @default(PROPOSED)
  effectiveDate  DateTime?         @map("effective_date")
  supersededById String?           @map("superseded_by_id")

  adoptedAt      DateTime?         @map("adopted_at")
  proposedBy     String?           @map("proposed_by") // User ID
  adoptedBy      String?           @map("adopted_by")  // User ID

  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  // Relations
  association    Association       @relation(fields: [associationId], references: [id], onDelete: Cascade)
  board          Board?            @relation(fields: [boardId], references: [id])
  supersededBy   Resolution?       @relation("ResolutionSupersede", fields: [supersededById], references: [id])
  supersedes     Resolution[]      @relation("ResolutionSupersede")

  policyDocuments PolicyDocument[]

  @@index([associationId])
  @@index([boardId])
  @@index([status])
  @@map("resolutions")
}

/// @description Policy documents with version history
model PolicyDocument {
  id             String        @id @default(cuid())
  associationId  String        @map("association_id")
  resolutionId   String?       @map("resolution_id")
  title          String
  description    String?       @db.Text
  currentVersion String?       @map("current_version")
  status         PolicyStatus  @default(DRAFT)

  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  association    Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  resolution     Resolution?   @relation(fields: [resolutionId], references: [id])
  versions       PolicyVersion[]

  @@index([associationId])
  @@index([resolutionId])
  @@index([status])
  @@map("policy_documents")
}

/// @description Versioned content for a policy document
model PolicyVersion {
  id               String       @id @default(cuid())
  policyDocumentId String       @map("policy_document_id")
  version          String
  content          String       @db.Text
  status           PolicyStatus @default(DRAFT)
  approvedAt       DateTime?    @map("approved_at")
  approvedBy       String?      @map("approved_by") // User ID

  createdAt        DateTime     @default(now()) @map("created_at")

  // Relations
  policyDocument   PolicyDocument @relation(fields: [policyDocumentId], references: [id], onDelete: Cascade)

  @@unique([policyDocumentId, version])
  @@index([policyDocumentId])
  @@index([status])
  @@map("policy_versions")
}

// =============================================================================
// PHASE 8: Communications
// =============================================================================

/// @description Templates for communications
model CommunicationTemplate {
  id             String                     @id @default(cuid())
  associationId  String                     @map("association_id")
  name           String
  type           CommunicationTemplateType
  channel        CommunicationChannel
  subject        String?
  body           String                     @db.Text
  variables      Json?
  currentVersion String?                    @map("current_version")

  createdBy      String?                    @map("created_by") // User ID
  createdAt      DateTime                   @default(now()) @map("created_at")
  updatedAt      DateTime                   @updatedAt @map("updated_at")

  // Relations
  association    Association                @relation(fields: [associationId], references: [id], onDelete: Cascade)
  massCommunications MassCommunication[]
  versions       CommunicationTemplateVersion[]

  @@index([associationId])
  @@map("communication_templates")
}

/// @description Versioned content for communication templates
model CommunicationTemplateVersion {
  id           String                 @id @default(cuid())
  templateId   String                 @map("template_id")
  version      String
  subject      String?
  body         String                 @db.Text
  variables    Json?
  status       TemplateVersionStatus  @default(DRAFT)
  createdBy    String?                @map("created_by") // User ID
  createdAt    DateTime               @default(now()) @map("created_at")

  // Relations
  template     CommunicationTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
  @@index([status])
  @@map("communication_template_versions")
}

/// @description Mass communications (scheduled or sent)
model MassCommunication {
  id             String                @id @default(cuid())
  associationId  String                @map("association_id")
  templateId     String?               @map("template_id")

  subject        String?
  body           String                @db.Text
  channel        CommunicationChannel
  status         CommunicationStatus   @default(DRAFT)
  scheduledFor   DateTime?             @map("scheduled_for")
  sentAt         DateTime?             @map("sent_at")
  targetFilter   Json?                 @map("target_filter") // e.g., audience selection

  createdBy      String?               @map("created_by") // User ID
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")

  // Relations
  association    Association           @relation(fields: [associationId], references: [id], onDelete: Cascade)
  template       CommunicationTemplate? @relation(fields: [templateId], references: [id])
  deliveries     MassCommunicationDelivery[]

  @@index([associationId])
  @@index([templateId])
  @@index([status])
  @@map("mass_communications")
}

/// @description Delivery log entries for mass communications
model MassCommunicationDelivery {
  id                   String          @id @default(cuid())
  massCommunicationId  String          @map("mass_communication_id")
  recipient            String
  channel              CommunicationChannel
  status               DeliveryStatus  @default(PENDING)
  sentAt               DateTime?       @map("sent_at")
  errorMessage         String?         @map("error_message")

  createdAt            DateTime        @default(now()) @map("created_at")

  // Relations
  massCommunication    MassCommunication @relation(fields: [massCommunicationId], references: [id], onDelete: Cascade)

  @@index([massCommunicationId])
  @@index([status])
  @@map("mass_communication_deliveries")
}

/// @description Announcements for portal or broadcasts
model Announcement {
  id             String               @id @default(cuid())
  associationId  String               @map("association_id")
  title          String
  content        String               @db.Text
  status         AnnouncementStatus   @default(DRAFT)
  publishedAt    DateTime?            @map("published_at")
  expiresAt      DateTime?            @map("expires_at")
  audience       Json?

  createdBy      String?              @map("created_by") // User ID
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")

  // Relations
  association    Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)
  reads          AnnouncementRead[]

  @@index([associationId])
  @@index([status])
  @@map("announcements")
}

/// @description Read receipts for announcements
model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String       @map("announcement_id")
  partyId        String       @map("party_id")
  readAt         DateTime     @default(now()) @map("read_at")

  // Relations
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  party          Party        @relation(fields: [partyId], references: [id])

  @@unique([announcementId, partyId])
  @@index([partyId])
  @@map("announcement_reads")
}

/// @description Calendar events (meetings, maintenance, closures)
model CalendarEvent {
  id             String             @id @default(cuid())
  associationId  String             @map("association_id")
  type           CalendarEventType
  title          String
  description    String?            @db.Text
  startsAt       DateTime           @map("starts_at")
  endsAt         DateTime?          @map("ends_at")
  location       String?
  metadata       Json?
  recurrenceRule String?            @map("recurrence_rule")
  notifyAt       DateTime?          @map("notify_at")

  createdBy      String?            @map("created_by") // User ID
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  association    Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  notifications  CalendarEventNotification[]

  @@index([associationId])
  @@index([startsAt])
  @@map("calendar_events")
}

/// @description Notification entries for calendar events
model CalendarEventNotification {
  id             String             @id @default(cuid())
  associationId  String             @map("association_id")
  eventId        String             @map("event_id")
  notifyAt       DateTime           @map("notify_at")
  status         NotificationStatus @default(PENDING)
  channel        CommunicationChannel?
  payload        Json?
  sentAt         DateTime?          @map("sent_at")
  errorMessage   String?            @map("error_message")

  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")

  // Relations
  association    Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  event          CalendarEvent      @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([eventId])
  @@index([status])
  @@map("calendar_event_notifications")
}

// =============================================================================
// PHASE 14: CROSS-TENANT FEATURES
// =============================================================================

/// @description Service area coverage for service providers
model ServiceArea {
  id                  String      @id @default(cuid())
  serviceProviderOrgId String     @map("service_provider_org_id")
  
  // Geographic coverage
  name                String      // e.g., "Greater Denver Metro"
  zipCodes            String[]    @map("zip_codes") // Array of covered zip codes
  radius              Int?        // Radius in miles from center point
  centerLat           Float?      @map("center_lat")
  centerLng           Float?      @map("center_lng")
  
  // Service categories offered in this area
  serviceCategories   String[]    @map("service_categories") // e.g., ["PLUMBING", "HVAC", "ELECTRICAL"]
  
  isActive            Boolean     @default(true) @map("is_active")
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  serviceProviderOrg  Organization @relation("ServiceProviderAreas", fields: [serviceProviderOrgId], references: [id], onDelete: Cascade)

  @@index([serviceProviderOrgId])
  @@map("service_areas")
}

/// @description Links service provider org to vendor records across associations
model ServiceProviderLink {
  id                  String      @id @default(cuid())
  serviceProviderOrgId String     @map("service_provider_org_id")
  vendorId            String      @map("vendor_id")
  
  // Link status
  status              ServiceProviderLinkStatus @default(PENDING)
  linkedAt            DateTime?   @map("linked_at")
  linkedBy            String?     @map("linked_by") // User who approved the link
  
  // Verification
  verificationCode    String?     @map("verification_code")
  verificationExpires DateTime?   @map("verification_expires")
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  serviceProviderOrg  Organization @relation("ServiceProviderLinks", fields: [serviceProviderOrgId], references: [id], onDelete: Cascade)
  vendor              Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([serviceProviderOrgId, vendorId])
  @@index([serviceProviderOrgId])
  @@index([vendorId])
  @@map("service_provider_links")
}

/// @description Individual homeowner property (non-HOA)
model IndividualProperty {
  id                  String      @id @default(cuid())
  ownerOrgId          String      @map("owner_org_id") // INDIVIDUAL_CONCIERGE org
  
  // Property details
  name                String      // e.g., "Main Residence", "Vacation Home"
  propertyType        PropertyType @map("property_type")
  
  // Address
  addressLine1        String      @map("address_line_1")
  addressLine2        String?     @map("address_line_2")
  city                String
  state               String
  postalCode          String      @map("postal_code")
  country             String      @default("US")
  
  // Property info
  yearBuilt           Int?        @map("year_built")
  squareFeet          Int?        @map("square_feet")
  lotSquareFeet       Int?        @map("lot_square_feet")
  bedrooms            Int?
  bathrooms           Float?
  
  // Status
  isActive            Boolean     @default(true) @map("is_active")
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  ownerOrg            Organization @relation("IndividualProperties", fields: [ownerOrgId], references: [id], onDelete: Cascade)
  maintenanceRequests IndividualMaintenanceRequest[]
  assets              IndividualAsset[]

  @@index([ownerOrgId])
  @@map("individual_properties")
}

/// @description Assets for individual properties
model IndividualAsset {
  id                  String      @id @default(cuid())
  propertyId          String      @map("property_id")
  
  // Asset details
  name                String
  category            String      // e.g., "HVAC", "Appliance", "Roof"
  manufacturer        String?
  model               String?
  serialNumber        String?     @map("serial_number")
  
  // Dates
  installDate         DateTime?   @map("install_date")
  warrantyExpires     DateTime?   @map("warranty_expires")
  lastServiceDate     DateTime?   @map("last_service_date")
  
  // Status
  condition           String?     // e.g., "Good", "Fair", "Needs Attention"
  notes               String?     @db.Text
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  property            IndividualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("individual_assets")
}

/// @description Maintenance requests for individual homeowners
model IndividualMaintenanceRequest {
  id                  String      @id @default(cuid())
  propertyId          String      @map("property_id")
  
  // Request details
  requestNumber       String      @map("request_number")
  title               String
  description         String      @db.Text
  category            String      // e.g., "PLUMBING", "HVAC", "ELECTRICAL"
  priority            String      @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  
  // Status
  status              IndividualRequestStatus @default(SUBMITTED)
  
  // Scheduling
  preferredDate       DateTime?   @map("preferred_date")
  scheduledDate       DateTime?   @map("scheduled_date")
  completedDate       DateTime?   @map("completed_date")
  
  // Vendor assignment
  assignedVendorOrgId String?     @map("assigned_vendor_org_id")
  
  // Cost tracking
  estimatedCost       Decimal?    @db.Decimal(10, 2) @map("estimated_cost")
  actualCost          Decimal?    @db.Decimal(10, 2) @map("actual_cost")
  
  // Notes
  notes               String?     @db.Text
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  property            IndividualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  assignedVendorOrg   Organization?      @relation("VendorMaintenanceRequests", fields: [assignedVendorOrgId], references: [id])

  @@unique([propertyId, requestNumber])
  @@index([propertyId])
  @@index([status])
  @@index([assignedVendorOrgId])
  @@map("individual_maintenance_requests")
}

// =============================================================================
// PHASE 15: REPORTING & ANALYTICS
// =============================================================================

/// @description Report definition/template
model ReportDefinition {
  id              String      @id @default(cuid())
  associationId   String?     @map("association_id") // Null for system-wide reports
  
  // Report identification
  code            String      // e.g., "BALANCE_SHEET", "AGED_RECEIVABLES"
  name            String
  description     String?
  category        ReportCategory
  
  // Report configuration
  queryTemplate   String      @map("query_template") @db.Text // SQL or query builder JSON
  parametersJson  String?     @map("parameters_json") @db.Text // JSON schema for parameters
  columnsJson     String?     @map("columns_json") @db.Text // Column definitions
  
  // Output options
  defaultFormat   ReportFormat @default(PDF) @map("default_format")
  allowedFormats  ReportFormat[] @map("allowed_formats")
  
  // Access control
  isSystemReport  Boolean     @default(false) @map("is_system_report")
  isActive        Boolean     @default(true) @map("is_active")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association? @relation(fields: [associationId], references: [id], onDelete: Cascade)
  executions      ReportExecution[]
  schedules       ReportSchedule[]

  @@unique([associationId, code])
  @@index([associationId])
  @@index([category])
  @@map("report_definitions")
}

/// @description Scheduled report execution
model ReportSchedule {
  id              String      @id @default(cuid())
  reportId        String      @map("report_id")
  associationId   String      @map("association_id")
  
  // Schedule configuration
  name            String
  frequency       ScheduleFrequency
  cronExpression  String?     @map("cron_expression") // For custom schedules
  
  // Parameters for this schedule
  parametersJson  String?     @map("parameters_json") @db.Text
  
  // Output configuration
  format          ReportFormat @default(PDF)
  
  // Delivery
  deliveryMethod  ReportDeliveryMethod @default(EMAIL) @map("delivery_method")
  recipientsJson  String?     @map("recipients_json") @db.Text // JSON array of email addresses
  
  // Status
  isActive        Boolean     @default(true) @map("is_active")
  lastRunAt       DateTime?   @map("last_run_at")
  nextRunAt       DateTime?   @map("next_run_at")
  
  createdBy       String      @map("created_by")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  report          ReportDefinition @relation(fields: [reportId], references: [id], onDelete: Cascade)
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  executions      ReportExecution[]

  @@index([reportId])
  @@index([associationId])
  @@index([nextRunAt])
  @@map("report_schedules")
}

/// @description Report execution history
model ReportExecution {
  id              String      @id @default(cuid())
  reportId        String      @map("report_id")
  scheduleId      String?     @map("schedule_id") // Null if ad-hoc
  associationId   String      @map("association_id")
  
  // Execution details
  status          ReportExecutionStatus @default(PENDING)
  parametersJson  String?     @map("parameters_json") @db.Text
  format          ReportFormat
  
  // Timing
  startedAt       DateTime?   @map("started_at")
  completedAt     DateTime?   @map("completed_at")
  
  // Output
  outputUrl       String?     @map("output_url") // S3/storage URL
  outputSize      Int?        @map("output_size") // Bytes
  rowCount        Int?        @map("row_count")
  
  // Error handling
  errorMessage    String?     @map("error_message") @db.Text
  
  // Who ran it
  executedBy      String?     @map("executed_by") // Null for scheduled
  
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  report          ReportDefinition @relation(fields: [reportId], references: [id], onDelete: Cascade)
  schedule        ReportSchedule?  @relation(fields: [scheduleId], references: [id])
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([scheduleId])
  @@index([associationId])
  @@index([status])
  @@index([createdAt])
  @@map("report_executions")
}

/// @description Dashboard widget configuration
model DashboardWidget {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")
  userId          String?     @map("user_id") // Null for association-wide
  
  // Widget configuration
  widgetType      WidgetType  @map("widget_type")
  title           String
  configJson      String?     @map("config_json") @db.Text // Widget-specific config
  
  // Layout
  position        Int         @default(0) // Order in dashboard
  width           Int         @default(1) // Grid units
  height          Int         @default(1)
  
  isActive        Boolean     @default(true) @map("is_active")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([userId])
  @@map("dashboard_widgets")
}

// =============================================================================
// PHASE 2: CONTRACTOR OPERATIONS
// =============================================================================

/// @description Contractor profile for SERVICE_PROVIDER organizations
model ContractorProfile {
  id                  String      @id @default(cuid())
  organizationId      String      @unique @map("organization_id")
  
  // Business info
  legalName           String      @map("legal_name")
  dba                 String?     // Doing business as
  taxId               String?     @map("tax_id") // EIN (encrypted)
  
  // Contact
  primaryContactName  String?     @map("primary_contact_name")
  primaryContactEmail String?     @map("primary_contact_email") @db.Citext
  primaryContactPhone String?     @map("primary_contact_phone")
  
  // Address (headquarters)
  addressLine1        String?     @map("address_line_1")
  addressLine2        String?     @map("address_line_2")
  city                String?
  state               String?
  postalCode          String?     @map("postal_code")
  country             String      @default("US")
  
  // Operating hours (JSON: { "monday": { "open": "08:00", "close": "17:00" }, ... })
  operatingHoursJson  String?     @map("operating_hours_json") @db.Text
  timezone            String      @default("America/New_York")
  
  // Capabilities
  maxTechnicians      Int?        @map("max_technicians")
  maxServiceRadius    Int?        @map("max_service_radius") // Miles
  
  // Compliance summary (computed/cached)
  complianceScore     Int?        @map("compliance_score") // 0-100
  lastComplianceCheck DateTime?   @map("last_compliance_check")
  
  // Status
  isActive            Boolean     @default(true) @map("is_active")
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trades              ContractorTrade[]
  licenses            ContractorLicense[]
  insurances          ContractorInsurance[]

  @@index([organizationId])
  @@map("contractor_profiles")
}

/// @description Branch office for a contractor organization
model ContractorBranch {
  id                  String      @id @default(cuid())
  organizationId      String      @map("organization_id")
  
  // Branch info
  name                String      // e.g., "North Region Office"
  code                String?     // Internal branch code
  
  // Contact
  contactName         String?     @map("contact_name")
  contactEmail        String?     @map("contact_email") @db.Citext
  contactPhone        String?     @map("contact_phone")
  
  // Address
  addressLine1        String      @map("address_line_1")
  addressLine2        String?     @map("address_line_2")
  city                String
  state               String
  postalCode          String      @map("postal_code")
  country             String      @default("US")
  
  // Operating hours (JSON)
  operatingHoursJson  String?     @map("operating_hours_json") @db.Text
  timezone            String      @default("America/New_York")
  
  // Service area (can override org-level)
  serviceRadiusMiles  Int?        @map("service_radius_miles")
  
  // Status
  isActive            Boolean     @default(true) @map("is_active")
  isPrimary           Boolean     @default(false) @map("is_primary")
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("contractor_branches")
}

/// @description Trade/service category a contractor is qualified for
model ContractorTrade {
  id                  String      @id @default(cuid())
  contractorProfileId String      @map("contractor_profile_id")
  
  tradeType           ContractorTradeType @map("trade_type")
  isPrimary           Boolean     @default(false) @map("is_primary")
  yearsExperience     Int?        @map("years_experience")
  notes               String?     @db.Text
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  contractorProfile   ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)

  @@unique([contractorProfileId, tradeType])
  @@index([contractorProfileId])
  @@index([tradeType])
  @@map("contractor_trades")
}

/// @description Contractor license record
model ContractorLicense {
  id                  String      @id @default(cuid())
  contractorProfileId String      @map("contractor_profile_id")
  
  // License details
  licenseType         String      @map("license_type") // e.g., "General Contractor", "Electrician"
  licenseNumber       String      @map("license_number")
  issuingAuthority    String      @map("issuing_authority") // e.g., "State of California"
  issuingState        String?     @map("issuing_state")
  
  // Dates
  issueDate           DateTime?   @map("issue_date")
  expirationDate      DateTime?   @map("expiration_date")
  
  // Status
  status              LicenseStatus @default(ACTIVE)
  verifiedAt          DateTime?   @map("verified_at")
  verifiedBy          String?     @map("verified_by")
  
  // Document reference
  documentUrl         String?     @map("document_url")
  
  notes               String?     @db.Text
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  contractorProfile   ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)

  @@index([contractorProfileId])
  @@index([expirationDate])
  @@index([status])
  @@map("contractor_licenses")
}

/// @description Contractor insurance policy record
model ContractorInsurance {
  id                  String      @id @default(cuid())
  contractorProfileId String      @map("contractor_profile_id")
  
  // Insurance details
  insuranceType       InsuranceType @map("insurance_type")
  policyNumber        String      @map("policy_number")
  carrier             String      // Insurance company name
  
  // Coverage
  coverageAmount      Decimal     @map("coverage_amount") @db.Decimal(12, 2)
  deductible          Decimal?    @db.Decimal(10, 2)
  
  // Dates
  effectiveDate       DateTime    @map("effective_date")
  expirationDate      DateTime    @map("expiration_date")
  
  // Status
  status              InsuranceStatus @default(ACTIVE)
  verifiedAt          DateTime?   @map("verified_at")
  verifiedBy          String?     @map("verified_by")
  
  // Certificate of Insurance
  coiDocumentUrl      String?     @map("coi_document_url")
  
  // Additional insured (HOAs may require this)
  additionalInsuredJson String?   @map("additional_insured_json") @db.Text
  
  notes               String?     @db.Text
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  // Relations
  contractorProfile   ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)

  @@index([contractorProfileId])
  @@index([expirationDate])
  @@index([status])
  @@map("contractor_insurances")
}

/// @description Contractor compliance status (computed/cached per association)
model ContractorComplianceStatus {
  id                  String      @id @default(cuid())
  vendorId            String      @map("vendor_id") // Links to Vendor (association-specific view)
  
  // Overall compliance
  isCompliant         Boolean     @default(false) @map("is_compliant")
  complianceScore     Int         @default(0) @map("compliance_score") // 0-100
  
  // Individual checks
  hasValidLicense     Boolean     @default(false) @map("has_valid_license")
  hasValidInsurance   Boolean     @default(false) @map("has_valid_insurance")
  hasW9OnFile         Boolean     @default(false) @map("has_w9_on_file")
  meetsMinCoverage    Boolean     @default(false) @map("meets_min_coverage")
  
  // Expiration tracking
  earliestLicenseExpiry   DateTime? @map("earliest_license_expiry")
  earliestInsuranceExpiry DateTime? @map("earliest_insurance_expiry")
  
  // Blocking
  isBlocked           Boolean     @default(false) @map("is_blocked")
  blockReason         String?     @map("block_reason") @db.Text
  blockedAt           DateTime?   @map("blocked_at")
  blockedBy           String?     @map("blocked_by")
  
  // Last check
  lastCheckedAt       DateTime    @default(now()) @map("last_checked_at")
  
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  @@unique([vendorId])
  @@index([isCompliant])
  @@index([isBlocked])
  @@index([earliestLicenseExpiry])
  @@index([earliestInsuranceExpiry])
  @@map("contractor_compliance_statuses")
}
