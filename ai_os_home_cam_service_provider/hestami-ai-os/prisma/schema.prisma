// Hestami AI OS - Prisma Schema
// https://pris.ly/d/prisma-schema

// =============================================================================
// Generators
// =============================================================================

generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../generated/zod"
  useMultipleFiles                 = true
  createInputTypes                 = true
  createModelTypes                 = true
  addInputTypeValidation           = true
  addIncludeType                   = true
  addSelectType                    = true
  validateWhereUniqueInput         = true
  createOptionalDefaultValuesTypes = true
  createRelationValuesTypes        = true
  createPartialTypes               = true
  useDefaultValidators             = true
  coerceDate                       = true
  writeNullishInModelTypes         = true
}

// =============================================================================
// Datasource
// =============================================================================

// Extensions: postgis, uuid-ossp, citext, pgcrypto are required by app
// btree_gin, fuzzystrmatch, pg_trgm, postgis_tiger_geocoder, postgis_topology, unaccent, vector are from PostGIS image
datasource db {
  provider   = "postgresql"
  extensions = [postgis, uuidOssp(map: "uuid-ossp"), citext, pgcrypto, btree_gin, fuzzystrmatch, pg_trgm, postgis_tiger_geocoder, postgis_topology, unaccent, vector]
}

// =============================================================================
// ENUMS
// =============================================================================

enum OrganizationType {
  COMMUNITY_ASSOCIATION
  MANAGEMENT_COMPANY
  SERVICE_PROVIDER
  INDIVIDUAL_CONCIERGE
  COMMERCIAL_CLIENT
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum UserRole {
  OWNER       // Homeowner
  TENANT      // Renter
  MANAGER     // Community/Portfolio Manager
  VENDOR      // Service Provider Staff
  BOARD_MEMBER
  ADMIN
}

// -----------------------------------------------------------------------------
// Phase 4: Work Orders & Assets
// -----------------------------------------------------------------------------

enum AssetStatus {
  ACTIVE
  INACTIVE
  UNDER_REPAIR
  DISPOSED
}

enum AssetCategory {
  HVAC
  PLUMBING
  ELECTRICAL
  STRUCTURAL
  LANDSCAPING
  POOL_SPA
  ELEVATOR
  SECURITY
  FIRE_SAFETY
  COMMON_AREA
  EQUIPMENT
  VEHICLE
  OTHER
}

enum WorkOrderStatus {
  DRAFT           // Initial creation
  SUBMITTED       // Submitted by requestor
  TRIAGED         // Reviewed and categorized
  ASSIGNED        // Vendor assigned
  SCHEDULED       // Work date scheduled
  IN_PROGRESS     // Work started
  ON_HOLD         // Paused for some reason
  COMPLETED       // Work finished
  INVOICED        // Invoice received
  CLOSED          // Fully resolved
  CANCELLED       // Cancelled before completion
}

enum WorkOrderPriority {
  EMERGENCY       // Immediate attention required
  HIGH            // Within 24 hours
  MEDIUM          // Within 1 week
  LOW             // Routine maintenance
  SCHEDULED       // Planned maintenance
}

enum WorkOrderCategory {
  MAINTENANCE
  REPAIR
  INSPECTION
  INSTALLATION
  REPLACEMENT
  EMERGENCY
  PREVENTIVE
  LANDSCAPING
  CLEANING
  SECURITY
  OTHER
}

enum BidStatus {
  REQUESTED       // Bid requested from vendor
  PENDING         // Vendor is preparing bid
  SUBMITTED       // Bid submitted
  UNDER_REVIEW    // Being reviewed
  ACCEPTED        // Bid accepted
  REJECTED        // Bid rejected
  WITHDRAWN       // Vendor withdrew bid
  EXPIRED         // Bid expired
}

// -----------------------------------------------------------------------------
// Phase 5: Violations
// -----------------------------------------------------------------------------

enum ViolationStatus {
  DRAFT           // Initial creation
  OPEN            // Active violation
  NOTICE_SENT     // Notice has been sent
  CURE_PERIOD     // Waiting for cure
  CURED           // Violation corrected
  ESCALATED       // Escalated to next level
  HEARING_SCHEDULED // Hearing scheduled
  HEARING_HELD    // Hearing completed
  FINE_ASSESSED   // Fine has been assessed
  APPEALED        // Under appeal
  CLOSED          // Resolved/closed
  DISMISSED       // Dismissed without action
}

enum ViolationSeverity {
  MINOR           // Minor infraction
  MODERATE        // Moderate violation
  MAJOR           // Major violation
  CRITICAL        // Critical/safety issue
}

enum NoticeType {
  WARNING         // Informal warning
  FIRST_NOTICE    // First formal notice
  SECOND_NOTICE   // Second notice
  FINAL_NOTICE    // Final notice before fine
  FINE_NOTICE     // Fine assessment notice
  HEARING_NOTICE  // Hearing notification
  CURE_CONFIRMATION // Confirmation of cure
}

enum NoticeDeliveryMethod {
  EMAIL
  MAIL
  CERTIFIED_MAIL
  POSTED          // Posted on property
  HAND_DELIVERED
  PORTAL          // Via owner portal
}

enum HearingOutcome {
  PENDING         // Not yet held
  UPHELD          // Violation upheld
  MODIFIED        // Fine/penalty modified
  DISMISSED       // Violation dismissed
  CONTINUED       // Hearing continued
}

// =============================================================================
// CORE MODELS - Organization (Tenant)
// =============================================================================

/// @description Primary tenant entity for multitenancy
model Organization {
  id          String             @id @default(cuid())
  name        String
  slug        String             @unique
  type        OrganizationType
  status      OrganizationStatus @default(ACTIVE)
  settings    Json               @default("{}")
  
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  deletedAt   DateTime?          @map("deleted_at")

  // Relations
  memberships         UserOrganization[]
  idempotencyKeys     IdempotencyKey[]
  associations        Association[]
  parties             Party[]
  managedAssociations ManagementContract[] // For management companies

  @@map("organizations")
}

// =============================================================================
// CORE MODELS - User & Authentication
// =============================================================================

/// @description Platform user account
model User {
  id            String    @id @default(cuid())
  email         String    @unique @db.Citext
  emailVerified Boolean   @default(false) @map("email_verified")
  name          String?
  image         String?
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  memberships         UserOrganization[]
  sessions            Session[]
  accounts            Account[]
  parties             Party[]   // Party records linked to this user
  managerAssignments  ManagerAssignment[]

  @@map("users")
}

/// @description Junction table for user-organization membership with roles
model UserOrganization {
  id             String       @id @default(cuid())
  userId         String       @map("user_id")
  organizationId String       @map("organization_id")
  role           UserRole     @default(OWNER)
  isDefault      Boolean      @default(false) @map("is_default")
  
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("user_organizations")
}

/// @description User session for authentication
model Session {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  token        String   @unique
  expiresAt    DateTime @map("expires_at")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// @description OAuth account linking
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  accountId         String  @map("account_id")
  providerId        String  @map("provider_id")
  accessToken       String? @map("access_token")
  refreshToken      String? @map("refresh_token")
  accessTokenExpiresAt DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope             String?
  idToken           String? @map("id_token")
  password          String?
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

/// @description Email verification tokens
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("verifications")
}

// =============================================================================
// CORE MODELS - Idempotency
// =============================================================================

/// @description Tracks idempotency keys for mutating operations
model IdempotencyKey {
  id             String       @id @default(cuid())
  key            String
  organizationId String       @map("organization_id")
  response       Json?
  statusCode     Int?         @map("status_code")
  
  createdAt      DateTime     @default(now()) @map("created_at")
  expiresAt      DateTime     @map("expires_at")

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([key, organizationId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// =============================================================================
// DOMAIN 1 - ENUMS
// =============================================================================

enum AssociationStatus {
  ACTIVE
  ONBOARDING
  SUSPENDED
  TERMINATED
}

enum PropertyType {
  SINGLE_FAMILY
  CONDOMINIUM
  TOWNHOUSE
  COOPERATIVE
  MIXED_USE
  COMMERCIAL
}

enum UnitType {
  SINGLE_FAMILY_HOME
  CONDO_UNIT
  TOWNHOUSE
  LOT
  COMMERCIAL_UNIT
}

enum AmenityType {
  POOL
  CLUBHOUSE
  GYM
  TENNIS_COURT
  PLAYGROUND
  PARK
  GATE
  PARKING
  OTHER
}

enum PartyType {
  INDIVIDUAL
  TRUST
  CORPORATION
  LLC
  PARTNERSHIP
  ESTATE
}

enum OwnershipType {
  FEE_SIMPLE
  JOINT_TENANCY
  TENANCY_IN_COMMON
  COMMUNITY_PROPERTY
  TRUST
}

// =============================================================================
// DOMAIN 1 - Association / Property Model
// =============================================================================

/// @description Community Association (HOA/COA/POA)
model Association {
  id               String            @id @default(cuid())
  organizationId   String            @map("organization_id")
  name             String
  legalName        String?           @map("legal_name")
  taxId            String?           @map("tax_id")
  status           AssociationStatus @default(ONBOARDING)
  incorporationDate DateTime?        @map("incorporation_date")
  fiscalYearEnd    Int               @default(12) @map("fiscal_year_end") // Month (1-12)
  settings         Json              @default("{}")
  
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  deletedAt        DateTime?         @map("deleted_at")

  // Relations
  organization        Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  properties          Property[]
  managementContracts ManagementContract[]
  managerAssignments  ManagerAssignment[]
  
  // Accounting relations
  glAccounts          GLAccount[]
  journalEntries      JournalEntry[]
  bankAccounts        BankAccount[]
  assessmentTypes     AssessmentType[]
  assessmentCharges   AssessmentCharge[]
  payments            Payment[]
  vendors             Vendor[]
  apInvoices          APInvoice[]
  
  // Phase 4: Work Orders & Assets
  assets              Asset[]
  workOrders          WorkOrder[]
  serviceProviders    AssociationServiceProvider[]
  
  // Phase 5: Violations
  violationTypes      ViolationType[]
  violations          Violation[]

  @@index([organizationId])
  @@map("associations")
}

/// @description Property/Community managed by an association
model Property {
  id              String       @id @default(cuid())
  associationId   String       @map("association_id")
  name            String
  propertyType    PropertyType @map("property_type")
  
  // Address
  addressLine1    String       @map("address_line_1")
  addressLine2    String?      @map("address_line_2")
  city            String
  state           String
  postalCode      String       @map("postal_code")
  country         String       @default("US")
  
  // Geo (PostGIS point)
  latitude        Float?
  longitude       Float?
  
  // Metadata
  yearBuilt       Int?         @map("year_built")
  totalUnits      Int          @default(0) @map("total_units")
  totalAcres      Float?       @map("total_acres")
  
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  deletedAt       DateTime?    @map("deleted_at")

  // Relations
  association     Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  units           Unit[]
  commonAreas     CommonArea[]

  @@index([associationId])
  @@map("properties")
}

/// @description Individual unit/lot within a property
model Unit {
  id              String    @id @default(cuid())
  propertyId      String    @map("property_id")
  unitNumber      String    @map("unit_number")
  unitType        UnitType  @map("unit_type")
  
  // Address (if different from property)
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  
  // Unit details
  bedrooms        Int?
  bathrooms       Float?
  squareFeet      Int?      @map("square_feet")
  lotSquareFeet   Int?      @map("lot_square_feet")
  parkingSpaces   Int       @default(0) @map("parking_spaces")
  
  // Assessment info
  assessmentClass String?   @map("assessment_class")
  votingWeight    Float     @default(1) @map("voting_weight")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  property        Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ownerships      Ownership[]
  tenancies       Tenancy[]
  
  // Accounting relations
  assessmentCharges AssessmentCharge[]
  payments          Payment[]
  
  // Phase 4: Work Orders & Assets
  assets            Asset[]
  workOrders        WorkOrder[]
  
  // Phase 5: Violations
  violations        Violation[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@map("units")
}

/// @description Common area or amenity
model CommonArea {
  id              String      @id @default(cuid())
  propertyId      String      @map("property_id")
  name            String
  amenityType     AmenityType @map("amenity_type")
  description     String?
  
  // Location within property
  location        String?
  
  // Scheduling
  reservable      Boolean     @default(false)
  maxCapacity     Int?        @map("max_capacity")
  
  // Operating hours (JSON: { monday: { open: "09:00", close: "21:00" }, ... })
  operatingHours  Json?       @map("operating_hours")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  property        Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("common_areas")
}

// =============================================================================
// DOMAIN 1 - Party & Relationship Models
// =============================================================================

/// @description Person or entity that can own/rent property
model Party {
  id              String    @id @default(cuid())
  organizationId  String    @map("organization_id")
  partyType       PartyType @map("party_type")
  
  // For individuals
  firstName       String?   @map("first_name")
  lastName        String?   @map("last_name")
  
  // For entities
  entityName      String?   @map("entity_name")
  
  // Contact
  email           String?   @db.Citext
  phone           String?
  
  // Address
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  country         String?   @default("US")
  
  // Link to platform user (if registered)
  userId          String?   @map("user_id")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  ownerships      Ownership[]
  tenancies       Tenancy[]
  
  // Accounting relations
  payments        Payment[]    // Payments made by this party
  
  // Phase 5: Violations
  violations      Violation[]  // Violations where this party is responsible

  @@index([organizationId])
  @@index([userId])
  @@index([email])
  @@map("parties")
}

/// @description Ownership record linking party to unit
model Ownership {
  id              String        @id @default(cuid())
  unitId          String        @map("unit_id")
  partyId         String        @map("party_id")
  ownershipType   OwnershipType @map("ownership_type")
  
  // Ownership percentage (for shared ownership)
  percentage      Float         @default(100)
  
  // Dates
  startDate       DateTime      @map("start_date")
  endDate         DateTime?     @map("end_date")
  
  // Primary contact for this unit
  isPrimary       Boolean       @default(false) @map("is_primary")
  
  // Mailing preferences
  mailingAddress  Json?         @map("mailing_address")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  // Relations
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  party           Party         @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([partyId])
  @@index([endDate])
  @@map("ownerships")
}

/// @description Tenancy record for renters
model Tenancy {
  id              String    @id @default(cuid())
  unitId          String    @map("unit_id")
  partyId         String    @map("party_id")
  
  // Lease dates
  leaseStart      DateTime  @map("lease_start")
  leaseEnd        DateTime? @map("lease_end")
  
  // Contact preferences
  isPrimary       Boolean   @default(false) @map("is_primary")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  unit            Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  party           Party     @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([partyId])
  @@index([leaseEnd])
  @@map("tenancies")
}

// =============================================================================
// DOMAIN 1 - Management Relationships
// =============================================================================

/// @description Contract between management company and association
model ManagementContract {
  id                  String       @id @default(cuid())
  associationId       String       @map("association_id")
  managementCompanyId String       @map("management_company_id")
  
  // Contract details
  contractNumber      String?      @map("contract_number")
  startDate           DateTime     @map("start_date")
  endDate             DateTime?    @map("end_date")
  autoRenew           Boolean      @default(false) @map("auto_renew")
  
  // Terms
  monthlyFee          Decimal?     @map("monthly_fee") @db.Decimal(10, 2)
  terms               Json?
  
  // Service levels
  serviceLevels       Json?        @map("service_levels") // { tier: "premium", sla: {...} }
  
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  association         Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  managementCompany   Organization @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([managementCompanyId])
  @@map("management_contracts")
}

// =============================================================================
// DOMAIN 1 - Manager Assignments
// =============================================================================

enum ManagerAssignmentType {
  COMMUNITY_MANAGER
  PORTFOLIO_MANAGER
  ASSISTANT_MANAGER
}

/// @description Manager assignment to associations
model ManagerAssignment {
  id              String               @id @default(cuid())
  userId          String               @map("user_id")
  associationId   String               @map("association_id")
  assignmentType  ManagerAssignmentType @map("assignment_type")
  
  // Assignment details
  isPrimary       Boolean              @default(false) @map("is_primary")
  startDate       DateTime             @map("start_date")
  endDate         DateTime?            @map("end_date")
  
  // Workload tracking
  maxUnits        Int?                 @map("max_units") // Max units this manager can handle
  notes           String?
  
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")

  // Relations
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  association     Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@unique([userId, associationId, assignmentType])
  @@index([userId])
  @@index([associationId])
  @@index([endDate])
  @@map("manager_assignments")
}

// =============================================================================
// DOMAIN 3 - ACCOUNTING ENUMS
// =============================================================================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountCategory {
  // Asset categories
  CASH
  ACCOUNTS_RECEIVABLE
  PREPAID
  FIXED_ASSET
  OTHER_ASSET
  
  // Liability categories
  ACCOUNTS_PAYABLE
  ACCRUED_LIABILITY
  DEFERRED_REVENUE
  LONG_TERM_LIABILITY
  OTHER_LIABILITY
  
  // Equity categories
  RETAINED_EARNINGS
  FUND_BALANCE
  RESERVE_FUND
  
  // Revenue categories
  ASSESSMENT_INCOME
  LATE_FEE_INCOME
  INTEREST_INCOME
  OTHER_INCOME
  
  // Expense categories
  ADMINISTRATIVE
  UTILITIES
  MAINTENANCE
  INSURANCE
  PROFESSIONAL_FEES
  RESERVE_CONTRIBUTION
  OTHER_EXPENSE
}

enum FundType {
  OPERATING
  RESERVE
  SPECIAL
}

enum JournalEntryStatus {
  DRAFT
  PENDING_APPROVAL
  POSTED
  REVERSED
}

enum AssessmentFrequency {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  ONE_TIME
}

enum ChargeStatus {
  PENDING
  BILLED
  PARTIALLY_PAID
  PAID
  WRITTEN_OFF
  CREDITED
}

enum PaymentMethod {
  CHECK
  ACH
  CREDIT_CARD
  CASH
  WIRE
  OTHER
}

enum PaymentStatus {
  PENDING
  CLEARED
  BOUNCED
  REFUNDED
  VOIDED
}

enum InvoiceStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PARTIALLY_PAID
  PAID
  VOIDED
}

// =============================================================================
// DOMAIN 3 - CHART OF ACCOUNTS
// =============================================================================

/// @description General Ledger Account
model GLAccount {
  id              String          @id @default(cuid())
  associationId   String          @map("association_id")
  
  // Account identification
  accountNumber   String          @map("account_number")
  name            String
  description     String?
  
  // Classification
  accountType     AccountType     @map("account_type")
  category        AccountCategory
  fundType        FundType        @default(OPERATING) @map("fund_type")
  
  // Hierarchy
  parentId        String?         @map("parent_id")
  
  // Status
  isActive        Boolean         @default(true) @map("is_active")
  isSystemAccount Boolean         @default(false) @map("is_system_account") // Cannot be deleted
  
  // Normal balance (true = debit, false = credit)
  normalDebit     Boolean         @default(true) @map("normal_debit")
  
  // Current balance (denormalized for performance)
  currentBalance  Decimal         @default(0) @map("current_balance") @db.Decimal(15, 2)
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  deletedAt       DateTime?       @map("deleted_at")

  // Relations
  association     Association     @relation(fields: [associationId], references: [id], onDelete: Cascade)
  parent          GLAccount?      @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        GLAccount[]     @relation("AccountHierarchy")
  journalLines    JournalEntryLine[]
  bankAccounts    BankAccount[]
  assessmentTypes AssessmentType[] @relation("AssessmentRevenueAccount")
  lateFeeAccount  AssessmentType[] @relation("LateFeeAccount")

  @@unique([associationId, accountNumber])
  @@index([associationId])
  @@index([parentId])
  @@index([accountType])
  @@map("gl_accounts")
}

// =============================================================================
// DOMAIN 3 - JOURNAL ENTRIES
// =============================================================================

/// @description Journal Entry header
model JournalEntry {
  id              String             @id @default(cuid())
  associationId   String             @map("association_id")
  
  // Entry identification
  entryNumber     String             @map("entry_number")
  entryDate       DateTime           @map("entry_date") @db.Date
  
  // Description
  description     String
  memo            String?
  
  // Status
  status          JournalEntryStatus @default(DRAFT)
  
  // Source reference (for auto-generated entries)
  sourceType      String?            @map("source_type") // "ASSESSMENT", "PAYMENT", "INVOICE", etc.
  sourceId        String?            @map("source_id")
  
  // Reversal tracking
  isReversal      Boolean            @default(false) @map("is_reversal")
  reversedEntryId String?            @unique @map("reversed_entry_id")
  
  // Approval
  approvedBy      String?            @map("approved_by")
  approvedAt      DateTime?          @map("approved_at")
  
  // Audit
  createdBy       String             @map("created_by")
  postedAt        DateTime?          @map("posted_at")
  
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  association     Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  lines           JournalEntryLine[]
  reversedEntry   JournalEntry?      @relation("ReversalPair", fields: [reversedEntryId], references: [id])
  reversalEntry   JournalEntry?      @relation("ReversalPair")

  @@unique([associationId, entryNumber])
  @@index([associationId])
  @@index([entryDate])
  @@index([status])
  @@index([sourceType, sourceId])
  @@map("journal_entries")
}

/// @description Journal Entry line (debit or credit)
model JournalEntryLine {
  id              String       @id @default(cuid())
  journalEntryId  String       @map("journal_entry_id")
  accountId       String       @map("account_id")
  
  // Amount (positive for debit, negative for credit)
  debitAmount     Decimal?     @map("debit_amount") @db.Decimal(15, 2)
  creditAmount    Decimal?     @map("credit_amount") @db.Decimal(15, 2)
  
  // Line description
  description     String?
  
  // Reference (unit, vendor, etc.)
  referenceType   String?      @map("reference_type")
  referenceId     String?      @map("reference_id")
  
  // Line order
  lineNumber      Int          @map("line_number")
  
  createdAt       DateTime     @default(now()) @map("created_at")

  // Relations
  journalEntry    JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account         GLAccount    @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@index([referenceType, referenceId])
  @@map("journal_entry_lines")
}

// =============================================================================
// DOMAIN 3 - BANK ACCOUNTS
// =============================================================================

/// @description Bank Account linked to GL
model BankAccount {
  id              String    @id @default(cuid())
  associationId   String    @map("association_id")
  glAccountId     String    @map("gl_account_id")
  
  // Bank details
  bankName        String    @map("bank_name")
  accountName     String    @map("account_name")
  accountNumber   String    @map("account_number") // Last 4 digits only for display
  routingNumber   String?   @map("routing_number") // Encrypted or last 4
  accountType     String    @map("account_type") // "CHECKING", "SAVINGS", "MONEY_MARKET"
  
  // Fund designation
  fundType        FundType  @default(OPERATING) @map("fund_type")
  
  // Balances
  bookBalance     Decimal   @default(0) @map("book_balance") @db.Decimal(15, 2)
  bankBalance     Decimal   @default(0) @map("bank_balance") @db.Decimal(15, 2)
  lastReconciled  DateTime? @map("last_reconciled")
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  isPrimary       Boolean   @default(false) @map("is_primary")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  glAccount       GLAccount   @relation(fields: [glAccountId], references: [id])
  payments        Payment[]

  @@index([associationId])
  @@index([glAccountId])
  @@map("bank_accounts")
}

// =============================================================================
// DOMAIN 3 - ASSESSMENTS
// =============================================================================

/// @description Assessment type configuration
model AssessmentType {
  id                  String              @id @default(cuid())
  associationId       String              @map("association_id")
  
  // Type details
  name                String
  description         String?
  code                String              // Short code like "REG", "SPEC", "LATE"
  
  // Frequency
  frequency           AssessmentFrequency
  
  // Default amount (can be overridden per unit)
  defaultAmount       Decimal             @map("default_amount") @db.Decimal(10, 2)
  
  // GL mapping
  revenueAccountId    String              @map("revenue_account_id")
  lateFeeAccountId    String?             @map("late_fee_account_id")
  
  // Late fee configuration
  lateFeeAmount       Decimal?            @map("late_fee_amount") @db.Decimal(10, 2)
  lateFeePercent      Decimal?            @map("late_fee_percent") @db.Decimal(5, 2)
  gracePeriodDays     Int                 @default(15) @map("grace_period_days")
  
  // Pro-ration
  prorateOnTransfer   Boolean             @default(true) @map("prorate_on_transfer")
  
  // Status
  isActive            Boolean             @default(true) @map("is_active")
  
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  association         Association         @relation(fields: [associationId], references: [id], onDelete: Cascade)
  revenueAccount      GLAccount           @relation("AssessmentRevenueAccount", fields: [revenueAccountId], references: [id])
  lateFeeAccount      GLAccount?          @relation("LateFeeAccount", fields: [lateFeeAccountId], references: [id])
  charges             AssessmentCharge[]

  @@unique([associationId, code])
  @@index([associationId])
  @@map("assessment_types")
}

/// @description Assessment charge against a unit
model AssessmentCharge {
  id                  String       @id @default(cuid())
  associationId       String       @map("association_id")
  unitId              String       @map("unit_id")
  assessmentTypeId    String       @map("assessment_type_id")
  
  // Charge details
  chargeDate          DateTime     @map("charge_date") @db.Date
  dueDate             DateTime     @map("due_date") @db.Date
  periodStart         DateTime?    @map("period_start") @db.Date
  periodEnd           DateTime?    @map("period_end") @db.Date
  
  // Amounts
  amount              Decimal      @db.Decimal(10, 2)
  lateFeeAmount       Decimal      @default(0) @map("late_fee_amount") @db.Decimal(10, 2)
  totalAmount         Decimal      @map("total_amount") @db.Decimal(10, 2) // amount + lateFeeAmount
  paidAmount          Decimal      @default(0) @map("paid_amount") @db.Decimal(10, 2)
  balanceDue          Decimal      @map("balance_due") @db.Decimal(10, 2) // totalAmount - paidAmount
  
  // Status
  status              ChargeStatus @default(PENDING)
  
  // Late fee tracking
  lateFeeApplied      Boolean      @default(false) @map("late_fee_applied")
  lateFeeDate         DateTime?    @map("late_fee_date")
  
  // GL posting
  journalEntryId      String?      @map("journal_entry_id")
  
  // Notes
  description         String?
  
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")

  // Relations
  association         Association      @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit                Unit             @relation(fields: [unitId], references: [id])
  assessmentType      AssessmentType   @relation(fields: [assessmentTypeId], references: [id])
  paymentApplications PaymentApplication[]

  @@index([associationId])
  @@index([unitId])
  @@index([assessmentTypeId])
  @@index([dueDate])
  @@index([status])
  @@map("assessment_charges")
}

// =============================================================================
// DOMAIN 3 - PAYMENTS (AR)
// =============================================================================

/// @description Payment received from owner/tenant
model Payment {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  unitId          String        @map("unit_id")
  
  // Payment details
  paymentDate     DateTime      @map("payment_date") @db.Date
  amount          Decimal       @db.Decimal(10, 2)
  
  // Method
  paymentMethod   PaymentMethod @map("payment_method")
  referenceNumber String?       @map("reference_number") // Check number, transaction ID
  
  // Bank account (where deposited)
  bankAccountId   String?       @map("bank_account_id")
  
  // Payer info
  payerName       String?       @map("payer_name")
  payerPartyId    String?       @map("payer_party_id")
  
  // Status
  status          PaymentStatus @default(PENDING)
  
  // Application tracking
  appliedAmount   Decimal       @default(0) @map("applied_amount") @db.Decimal(10, 2)
  unappliedAmount Decimal       @map("unapplied_amount") @db.Decimal(10, 2) // amount - appliedAmount
  
  // GL posting
  journalEntryId  String?       @map("journal_entry_id")
  
  // Notes
  memo            String?
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit          @relation(fields: [unitId], references: [id])
  bankAccount     BankAccount?  @relation(fields: [bankAccountId], references: [id])
  payerParty      Party?        @relation(fields: [payerPartyId], references: [id])
  applications    PaymentApplication[]

  @@index([associationId])
  @@index([unitId])
  @@index([paymentDate])
  @@index([status])
  @@map("payments")
}

/// @description Payment application to charges
model PaymentApplication {
  id              String           @id @default(cuid())
  paymentId       String           @map("payment_id")
  chargeId        String           @map("charge_id")
  
  // Amount applied
  amount          Decimal          @db.Decimal(10, 2)
  
  // Application date
  appliedAt       DateTime         @default(now()) @map("applied_at")
  
  createdAt       DateTime         @default(now()) @map("created_at")

  // Relations
  payment         Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  charge          AssessmentCharge @relation(fields: [chargeId], references: [id])

  @@index([paymentId])
  @@index([chargeId])
  @@map("payment_applications")
}

// =============================================================================
// DOMAIN 3 - ACCOUNTS PAYABLE
// =============================================================================

/// @description Vendor (service provider for AP)
model Vendor {
  id              String    @id @default(cuid())
  associationId   String    @map("association_id")
  
  // Vendor details
  name            String
  dba             String?   // Doing business as
  
  // Contact
  contactName     String?   @map("contact_name")
  email           String?   @db.Citext
  phone           String?
  
  // Address
  addressLine1    String?   @map("address_line_1")
  addressLine2    String?   @map("address_line_2")
  city            String?
  state           String?
  postalCode      String?   @map("postal_code")
  
  // Tax info
  taxId           String?   @map("tax_id") // EIN or SSN (encrypted)
  w9OnFile        Boolean   @default(false) @map("w9_on_file")
  is1099Eligible  Boolean   @default(false) @map("is_1099_eligible")
  
  // Payment info
  paymentTerms    Int       @default(30) @map("payment_terms") // Net days
  defaultGLAccountId String? @map("default_gl_account_id")
  
  // Link to service provider organization (if on platform)
  serviceProviderOrgId String? @map("service_provider_org_id")
  
  // Status
  isActive        Boolean   @default(true) @map("is_active")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  invoices        APInvoice[]
  
  // Phase 4: Work Orders
  workOrders      WorkOrder[]
  bids            WorkOrderBid[]

  @@index([associationId])
  @@index([email])
  @@map("vendors")
}

/// @description Accounts Payable Invoice
model APInvoice {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  vendorId        String        @map("vendor_id")
  
  // Invoice details
  invoiceNumber   String        @map("invoice_number")
  invoiceDate     DateTime      @map("invoice_date") @db.Date
  dueDate         DateTime      @map("due_date") @db.Date
  
  // Amounts
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount     Decimal       @map("total_amount") @db.Decimal(10, 2)
  paidAmount      Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  balanceDue      Decimal       @map("balance_due") @db.Decimal(10, 2)
  
  // Status
  status          InvoiceStatus @default(DRAFT)
  
  // Approval workflow
  approvedBy      String?       @map("approved_by")
  approvedAt      DateTime?     @map("approved_at")
  
  // GL posting
  journalEntryId  String?       @map("journal_entry_id")
  
  // Reference
  description     String?
  memo            String?
  
  // Work order link (if applicable)
  workOrderId     String?       @map("work_order_id")
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  vendor          Vendor        @relation(fields: [vendorId], references: [id])
  lineItems       APInvoiceLine[]

  @@unique([associationId, vendorId, invoiceNumber])
  @@index([associationId])
  @@index([vendorId])
  @@index([dueDate])
  @@index([status])
  @@map("ap_invoices")
}

/// @description AP Invoice line item
model APInvoiceLine {
  id              String    @id @default(cuid())
  invoiceId       String    @map("invoice_id")
  
  // Line details
  description     String
  quantity        Decimal   @default(1) @db.Decimal(10, 2)
  unitPrice       Decimal   @map("unit_price") @db.Decimal(10, 2)
  amount          Decimal   @db.Decimal(10, 2)
  
  // GL account
  glAccountId     String    @map("gl_account_id")
  
  // Line order
  lineNumber      Int       @map("line_number")
  
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  invoice         APInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("ap_invoice_lines")
}

// =============================================================================
// PHASE 4: WORK ORDERS & ASSET MANAGEMENT
// =============================================================================

/// @description Physical asset (equipment, systems, common area items)
model Asset {
  id              String        @id @default(cuid())
  associationId   String        @map("association_id")
  
  // Asset identification
  assetNumber     String        @map("asset_number")
  name            String
  description     String?
  
  // Classification
  category        AssetCategory
  status          AssetStatus   @default(ACTIVE)
  
  // Location - either unit or common area
  unitId          String?       @map("unit_id")
  commonAreaName  String?       @map("common_area_name") // e.g., "Pool House", "Clubhouse"
  locationDetails String?       @map("location_details") // Specific location within
  
  // Asset details
  manufacturer    String?
  model           String?
  serialNumber    String?       @map("serial_number")
  
  // Dates
  purchaseDate    DateTime?     @map("purchase_date") @db.Date
  installDate     DateTime?     @map("install_date") @db.Date
  
  // Warranty
  warrantyExpires DateTime?     @map("warranty_expires") @db.Date
  warrantyDetails String?       @map("warranty_details")
  
  // Financial
  purchaseCost    Decimal?      @map("purchase_cost") @db.Decimal(10, 2)
  currentValue    Decimal?      @map("current_value") @db.Decimal(10, 2)
  
  // Maintenance schedule
  maintenanceFrequencyDays Int? @map("maintenance_frequency_days")
  lastMaintenanceDate DateTime? @map("last_maintenance_date") @db.Date
  nextMaintenanceDate DateTime? @map("next_maintenance_date") @db.Date
  
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  deletedAt       DateTime?     @map("deleted_at")

  // Relations
  association     Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit?         @relation(fields: [unitId], references: [id])
  workOrders      WorkOrder[]
  maintenanceHistory AssetMaintenanceLog[]

  @@unique([associationId, assetNumber])
  @@index([associationId])
  @@index([unitId])
  @@index([category])
  @@index([status])
  @@map("assets")
}

/// @description Asset maintenance history log
model AssetMaintenanceLog {
  id              String    @id @default(cuid())
  assetId         String    @map("asset_id")
  
  // Maintenance details
  maintenanceDate DateTime  @map("maintenance_date") @db.Date
  maintenanceType String    @map("maintenance_type") // Routine, Repair, Inspection, etc.
  description     String
  performedBy     String?   @map("performed_by") // Vendor name or internal
  
  // Cost
  cost            Decimal?  @db.Decimal(10, 2)
  
  // Work order reference
  workOrderId     String?   @map("work_order_id")
  
  // Notes
  notes           String?
  
  createdAt       DateTime  @default(now()) @map("created_at")
  createdBy       String    @map("created_by")

  // Relations
  asset           Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  workOrder       WorkOrder? @relation(fields: [workOrderId], references: [id])

  @@index([assetId])
  @@index([maintenanceDate])
  @@map("asset_maintenance_logs")
}

/// @description Service provider capabilities and service areas
model ServiceProviderProfile {
  id                    String    @id @default(cuid())
  organizationId        String    @unique @map("organization_id") // Links to SERVICE_PROVIDER org
  
  // Business info
  businessName          String    @map("business_name")
  description           String?
  
  // Service categories (what they do)
  serviceCategories     String[]  @map("service_categories") // Array of AssetCategory values
  
  // Service area (where they work)
  serviceAreaRadius     Int?      @map("service_area_radius") // Miles from base
  serviceZipCodes       String[]  @map("service_zip_codes")
  
  // Compliance
  insuranceExpires      DateTime? @map("insurance_expires") @db.Date
  insuranceAmount       Decimal?  @map("insurance_amount") @db.Decimal(12, 2)
  licenseNumber         String?   @map("license_number")
  licenseExpires        DateTime? @map("license_expires") @db.Date
  bondedAmount          Decimal?  @map("bonded_amount") @db.Decimal(12, 2)
  
  // Ratings
  averageRating         Decimal?  @map("average_rating") @db.Decimal(2, 1)
  totalReviews          Int       @default(0) @map("total_reviews")
  
  // Status
  isVerified            Boolean   @default(false) @map("is_verified")
  isActive              Boolean   @default(true) @map("is_active")
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  associationRelationships AssociationServiceProvider[]

  @@index([serviceCategories])
  @@map("service_provider_profiles")
}

/// @description Association-to-Service Provider relationship
model AssociationServiceProvider {
  id                    String    @id @default(cuid())
  associationId         String    @map("association_id")
  serviceProviderId     String    @map("service_provider_id")
  
  // Relationship status
  isPreferred           Boolean   @default(false) @map("is_preferred")
  isApproved            Boolean   @default(true) @map("is_approved")
  isBlocked             Boolean   @default(false) @map("is_blocked")
  
  // Contract info
  contractStartDate     DateTime? @map("contract_start_date") @db.Date
  contractEndDate       DateTime? @map("contract_end_date") @db.Date
  
  // Notes
  notes                 String?
  
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  association           Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  serviceProvider       ServiceProviderProfile @relation(fields: [serviceProviderId], references: [id])

  @@unique([associationId, serviceProviderId])
  @@index([associationId])
  @@index([serviceProviderId])
  @@map("association_service_providers")
}

/// @description Work order for maintenance, repairs, and services
model WorkOrder {
  id              String            @id @default(cuid())
  associationId   String            @map("association_id")
  
  // Work order identification
  workOrderNumber String            @map("work_order_number")
  
  // Classification
  category        WorkOrderCategory
  priority        WorkOrderPriority @default(MEDIUM)
  status          WorkOrderStatus   @default(DRAFT)
  
  // Request details
  title           String
  description     String
  
  // Location - unit, common area, or asset
  unitId          String?           @map("unit_id")
  commonAreaName  String?           @map("common_area_name")
  assetId         String?           @map("asset_id")
  locationDetails String?           @map("location_details")
  
  // Requestor
  requestedBy     String            @map("requested_by") // User ID
  requestedAt     DateTime          @default(now()) @map("requested_at")
  
  // Assignment
  assignedVendorId String?          @map("assigned_vendor_id")
  assignedAt      DateTime?         @map("assigned_at")
  assignedBy      String?           @map("assigned_by")
  
  // Scheduling
  scheduledStart  DateTime?         @map("scheduled_start")
  scheduledEnd    DateTime?         @map("scheduled_end")
  
  // Execution
  startedAt       DateTime?         @map("started_at")
  completedAt     DateTime?         @map("completed_at")
  
  // Closure
  closedAt        DateTime?         @map("closed_at")
  closedBy        String?           @map("closed_by")
  
  // Estimated vs actual
  estimatedCost   Decimal?          @map("estimated_cost") @db.Decimal(10, 2)
  actualCost      Decimal?          @map("actual_cost") @db.Decimal(10, 2)
  estimatedHours  Decimal?          @map("estimated_hours") @db.Decimal(5, 2)
  actualHours     Decimal?          @map("actual_hours") @db.Decimal(5, 2)
  
  // Resolution
  resolutionNotes String?           @map("resolution_notes")
  
  // AP Integration
  invoiceId       String?           @map("invoice_id")
  
  // SLA tracking
  slaDeadline     DateTime?         @map("sla_deadline")
  slaMet          Boolean?          @map("sla_met")
  
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  association     Association       @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit            Unit?             @relation(fields: [unitId], references: [id])
  asset           Asset?            @relation(fields: [assetId], references: [id])
  assignedVendor  Vendor?           @relation(fields: [assignedVendorId], references: [id])
  statusHistory   WorkOrderStatusHistory[]
  comments        WorkOrderComment[]
  attachments     WorkOrderAttachment[]
  bids            WorkOrderBid[]
  maintenanceLogs AssetMaintenanceLog[]

  @@unique([associationId, workOrderNumber])
  @@index([associationId])
  @@index([unitId])
  @@index([assetId])
  @@index([assignedVendorId])
  @@index([status])
  @@index([priority])
  @@index([requestedAt])
  @@map("work_orders")
}

/// @description Work order status change history
model WorkOrderStatusHistory {
  id              String          @id @default(cuid())
  workOrderId     String          @map("work_order_id")
  
  // Status change
  fromStatus      WorkOrderStatus? @map("from_status")
  toStatus        WorkOrderStatus @map("to_status")
  
  // Who and when
  changedBy       String          @map("changed_by")
  changedAt       DateTime        @default(now()) @map("changed_at")
  
  // Notes
  notes           String?

  // Relations
  workOrder       WorkOrder       @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([changedAt])
  @@map("work_order_status_history")
}

/// @description Work order comments/notes
model WorkOrderComment {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  
  // Comment
  comment         String
  isInternal      Boolean   @default(false) @map("is_internal") // Internal vs visible to all
  
  // Author
  authorId        String    @map("author_id")
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_comments")
}

/// @description Work order attachments (photos, documents)
model WorkOrderAttachment {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  
  // File info
  fileName        String    @map("file_name")
  fileType        String    @map("file_type") // MIME type
  fileSize        Int       @map("file_size") // Bytes
  fileUrl         String    @map("file_url")
  
  // Metadata
  description     String?
  uploadedBy      String    @map("uploaded_by")
  uploadedAt      DateTime  @default(now()) @map("uploaded_at")
  
  // Type
  attachmentType  String    @map("attachment_type") // PHOTO, DOCUMENT, INVOICE, etc.

  // Relations
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_attachments")
}

/// @description Vendor bid for a work order
model WorkOrderBid {
  id              String    @id @default(cuid())
  workOrderId     String    @map("work_order_id")
  vendorId        String    @map("vendor_id")
  
  // Bid details
  status          BidStatus @default(REQUESTED)
  
  // Pricing
  laborCost       Decimal?  @map("labor_cost") @db.Decimal(10, 2)
  materialsCost   Decimal?  @map("materials_cost") @db.Decimal(10, 2)
  totalAmount     Decimal?  @map("total_amount") @db.Decimal(10, 2)
  
  // Timeline
  estimatedHours  Decimal?  @map("estimated_hours") @db.Decimal(5, 2)
  proposedStartDate DateTime? @map("proposed_start_date")
  proposedEndDate DateTime? @map("proposed_end_date")
  
  // Bid validity
  validUntil      DateTime? @map("valid_until")
  
  // Notes
  notes           String?
  
  // Timestamps
  requestedAt     DateTime  @default(now()) @map("requested_at")
  submittedAt     DateTime? @map("submitted_at")
  respondedAt     DateTime? @map("responded_at") // When accepted/rejected
  respondedBy     String?   @map("responded_by")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  vendor          Vendor    @relation(fields: [vendorId], references: [id])

  @@unique([workOrderId, vendorId])
  @@index([workOrderId])
  @@index([vendorId])
  @@index([status])
  @@map("work_order_bids")
}

// =============================================================================
// PHASE 5: VIOLATIONS
// =============================================================================

/// @description Violation type configuration per association
model ViolationType {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")
  
  // Type details
  code            String      // e.g., "PARKING-001"
  name            String      // e.g., "Unauthorized Parking"
  description     String?
  category        String      // e.g., "Parking", "Landscaping", "Noise"
  
  // CC&R reference
  ccnrSection     String?     @map("ccnr_section") // Reference to governing docs
  ruleReference   String?     @map("rule_reference")
  
  // Default settings
  defaultSeverity ViolationSeverity @default(MODERATE) @map("default_severity")
  defaultCurePeriodDays Int   @default(14) @map("default_cure_period_days")
  
  // Fine schedule (can be overridden per violation)
  firstFineAmount   Decimal?  @db.Decimal(10, 2) @map("first_fine_amount")
  secondFineAmount  Decimal?  @db.Decimal(10, 2) @map("second_fine_amount")
  subsequentFineAmount Decimal? @db.Decimal(10, 2) @map("subsequent_fine_amount")
  maxFineAmount     Decimal?  @db.Decimal(10, 2) @map("max_fine_amount")
  
  // Notice template references
  warningTemplateId String?   @map("warning_template_id")
  noticeTemplateId  String?   @map("notice_template_id")
  
  isActive        Boolean     @default(true) @map("is_active")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  violations      Violation[]

  @@unique([associationId, code])
  @@index([associationId])
  @@index([category])
  @@map("violation_types")
}

/// @description Individual violation instance
model Violation {
  id              String      @id @default(cuid())
  associationId   String      @map("association_id")
  
  // Violation identification
  violationNumber String      @map("violation_number") // e.g., "VIO-2024-000001"
  violationTypeId String      @map("violation_type_id")
  
  // Location
  unitId          String?     @map("unit_id")
  commonAreaName  String?     @map("common_area_name")
  locationDetails String?     @map("location_details")
  
  // Violation details
  title           String
  description     String      @db.Text
  severity        ViolationSeverity
  status          ViolationStatus @default(DRAFT)
  
  // Dates
  observedDate    DateTime    @map("observed_date")
  reportedDate    DateTime    @default(now()) @map("reported_date")
  curePeriodEnds  DateTime?   @map("cure_period_ends")
  curedDate       DateTime?   @map("cured_date")
  closedDate      DateTime?   @map("closed_date")
  
  // Responsible party
  responsiblePartyId String?  @map("responsible_party_id") // Party ID (owner)
  
  // Reporter
  reportedBy      String      @map("reported_by") // User ID
  reporterType    String?     @map("reporter_type") // "STAFF", "RESIDENT", "ANONYMOUS"
  
  // Fine tracking
  totalFinesAssessed Decimal  @default(0) @db.Decimal(10, 2) @map("total_fines_assessed")
  totalFinesPaid     Decimal  @default(0) @db.Decimal(10, 2) @map("total_fines_paid")
  totalFinesWaived   Decimal  @default(0) @db.Decimal(10, 2) @map("total_fines_waived")
  
  // Notice tracking
  noticeCount     Int         @default(0) @map("notice_count")
  lastNoticeDate  DateTime?   @map("last_notice_date")
  lastNoticeType  NoticeType? @map("last_notice_type")
  
  // Resolution
  resolutionNotes String?     @map("resolution_notes") @db.Text
  closedBy        String?     @map("closed_by")
  
  // Soft delete
  deletedAt       DateTime?   @map("deleted_at")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  violationType   ViolationType @relation(fields: [violationTypeId], references: [id])
  unit            Unit?       @relation(fields: [unitId], references: [id])
  responsibleParty Party?     @relation(fields: [responsiblePartyId], references: [id])
  
  evidence        ViolationEvidence[]
  notices         ViolationNotice[]
  hearings        ViolationHearing[]
  fines           ViolationFine[]
  statusHistory   ViolationStatusHistory[]

  @@index([associationId])
  @@index([violationTypeId])
  @@index([unitId])
  @@index([status])
  @@index([observedDate])
  @@index([responsiblePartyId])
  @@map("violations")
}

/// @description Evidence attached to a violation
model ViolationEvidence {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Evidence details
  evidenceType    String      // "PHOTO", "VIDEO", "DOCUMENT", "AUDIO"
  fileName        String      @map("file_name")
  fileUrl         String      @map("file_url")
  fileSize        Int?        @map("file_size")
  mimeType        String?     @map("mime_type")
  
  // Metadata
  description     String?
  capturedAt      DateTime?   @map("captured_at")
  capturedBy      String?     @map("captured_by") // User ID
  gpsLatitude     Decimal?    @db.Decimal(10, 8) @map("gps_latitude")
  gpsLongitude    Decimal?    @db.Decimal(11, 8) @map("gps_longitude")
  
  // Chain of custody
  uploadedBy      String      @map("uploaded_by")
  uploadedAt      DateTime    @default(now()) @map("uploaded_at")
  
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@map("violation_evidence")
}

/// @description Notices sent for a violation
model ViolationNotice {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Notice details
  noticeType      NoticeType  @map("notice_type")
  noticeNumber    Int         @map("notice_number") // Sequence number for this violation
  
  // Content
  subject         String
  body            String      @db.Text
  
  // Delivery
  deliveryMethod  NoticeDeliveryMethod @map("delivery_method")
  recipientName   String      @map("recipient_name")
  recipientAddress String?    @map("recipient_address")
  recipientEmail  String?     @map("recipient_email")
  
  // Dates
  sentDate        DateTime    @map("sent_date")
  deliveredDate   DateTime?   @map("delivered_date")
  curePeriodDays  Int?        @map("cure_period_days")
  curePeriodEnds  DateTime?   @map("cure_period_ends")
  
  // Tracking
  trackingNumber  String?     @map("tracking_number") // For certified mail
  deliveryConfirmed Boolean   @default(false) @map("delivery_confirmed")
  
  // Sender
  sentBy          String      @map("sent_by")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([noticeType])
  @@map("violation_notices")
}

/// @description Hearings scheduled for violations
model ViolationHearing {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Hearing details
  hearingDate     DateTime    @map("hearing_date")
  hearingTime     String?     @map("hearing_time")
  location        String?
  
  // Participants
  hearingOfficer  String?     @map("hearing_officer")
  attendees       String?     @db.Text // JSON array of attendee names
  
  // Outcome
  outcome         HearingOutcome @default(PENDING)
  outcomeNotes    String?     @map("outcome_notes") @db.Text
  fineAssessed    Decimal?    @db.Decimal(10, 2) @map("fine_assessed")
  fineWaived      Decimal?    @db.Decimal(10, 2) @map("fine_waived")
  
  // Appeal
  appealDeadline  DateTime?   @map("appeal_deadline")
  appealFiled     Boolean     @default(false) @map("appeal_filed")
  appealDate      DateTime?   @map("appeal_date")
  
  // Recording
  recordedBy      String?     @map("recorded_by")
  recordedAt      DateTime?   @map("recorded_at")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([hearingDate])
  @@map("violation_hearings")
}

/// @description Fines assessed for violations
model ViolationFine {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  // Fine details
  fineNumber      Int         @map("fine_number") // Sequence for this violation
  amount          Decimal     @db.Decimal(10, 2)
  reason          String?
  
  // Status
  assessedDate    DateTime    @map("assessed_date")
  dueDate         DateTime    @map("due_date")
  paidAmount      Decimal     @default(0) @db.Decimal(10, 2) @map("paid_amount")
  waivedAmount    Decimal     @default(0) @db.Decimal(10, 2) @map("waived_amount")
  balanceDue      Decimal     @db.Decimal(10, 2) @map("balance_due")
  
  // Waiver
  waivedBy        String?     @map("waived_by")
  waivedDate      DateTime?   @map("waived_date")
  waiverReason    String?     @map("waiver_reason")
  
  // GL Integration
  assessmentChargeId String?  @map("assessment_charge_id") // Link to AssessmentCharge
  glPosted        Boolean     @default(false) @map("gl_posted")
  
  // Assessed by
  assessedBy      String      @map("assessed_by")
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([assessedDate])
  @@map("violation_fines")
}

/// @description Status history for violations
model ViolationStatusHistory {
  id              String      @id @default(cuid())
  violationId     String      @map("violation_id")
  
  fromStatus      ViolationStatus? @map("from_status")
  toStatus        ViolationStatus  @map("to_status")
  changedBy       String      @map("changed_by")
  changedAt       DateTime    @default(now()) @map("changed_at")
  notes           String?
  
  // Relations
  violation       Violation   @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@map("violation_status_history")
}
