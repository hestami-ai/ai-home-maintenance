// Hestami AI OS - Prisma Schema
// https://pris.ly/d/prisma-schema

// =============================================================================
// Generators
// =============================================================================

generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

/// @description Technician employed/contracted by a service provider org
model Technician {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // Identity
  firstName  String  @map("first_name")
  lastName   String  @map("last_name")
  email      String? @db.Citext
  phone      String?
  employeeId String? @map("employee_id")

  // Status & employment
  isActive        Boolean   @default(true) @map("is_active")
  hireDate        DateTime? @map("hire_date")
  terminationDate DateTime? @map("termination_date")
  timezone        String    @default("America/New_York")

  // Location/branch
  branchId String? @map("branch_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization   Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  branch         ContractorBranch?         @relation(fields: [branchId], references: [id])
  skills         TechnicianSkill[]
  certifications TechnicianCertification[]
  availability   TechnicianAvailability?
  timeOff        TechnicianTimeOff[]
  territories    TechnicianTerritory[]
  kpis           TechnicianKPI[]
  workOrders     WorkOrder[]
  jobs           Job[]
  jobVisits      JobVisit[]

  // Dispatch & Scheduling
  dispatchAssignments DispatchAssignment[]
  scheduleSlots       ScheduleSlot[]
  routePlans          RoutePlan[]

  // Field Technician Mobile
  jobTimeEntries   JobTimeEntry[]
  offlineSyncQueue OfflineSyncQueue[]

  // Inventory
  inventoryLocations InventoryLocation[]

  // Maintenance Contracts
  serviceContracts   ServiceContract[]    @relation("PrimaryTechnician")
  scheduledVisits    ScheduledVisit[]     @relation("ScheduledVisitTechnician")

  @@index([organizationId])
  @@index([branchId])
  @@index([isActive])
  @@map("technicians")
}

/// @description Technician skill tagging
model TechnicianSkill {
  id           String              @id @default(cuid())
  technicianId String              @map("technician_id")
  trade        ContractorTradeType @map("trade")
  level        Int                 @default(1) // 1-5 proficiency
  notes        String?             @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  technician Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([technicianId, trade])
  @@index([technicianId])
  @@map("technician_skills")
}

/// @description Technician certifications (licenses, safety cards)
model TechnicianCertification {
  id              String    @id @default(cuid())
  technicianId    String    @map("technician_id")
  name            String
  authority       String?
  certificationId String?   @map("certification_id")
  issuedAt        DateTime? @map("issued_at")
  expiresAt       DateTime? @map("expires_at")
  documentUrl     String?   @map("document_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  technician Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([expiresAt])
  @@map("technician_certifications")
}

/// @description Technician recurring weekly availability by weekday
model TechnicianAvailability {
  id           String @id @default(cuid())
  technicianId String @unique @map("technician_id")
  monday       Json?
  tuesday      Json?
  wednesday    Json?
  thursday     Json?
  friday       Json?
  saturday     Json?
  sunday       Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  technician Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@map("technician_availability")
}

/// @description Technician time off / PTO
model TechnicianTimeOff {
  id           String   @id @default(cuid())
  technicianId String   @map("technician_id")
  startsAt     DateTime @map("starts_at")
  endsAt       DateTime @map("ends_at")
  reason       String?  @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  technician Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([startsAt])
  @@index([endsAt])
  @@map("technician_time_off")
}

/// @description Technician territory assignment (links to service areas)
model TechnicianTerritory {
  id            String  @id @default(cuid())
  technicianId  String  @map("technician_id")
  serviceAreaId String  @map("service_area_id")
  isPrimary     Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  technician  Technician  @relation(fields: [technicianId], references: [id], onDelete: Cascade)
  serviceArea ServiceArea @relation(fields: [serviceAreaId], references: [id], onDelete: Cascade)

  @@unique([technicianId, serviceAreaId])
  @@index([technicianId])
  @@index([serviceAreaId])
  @@map("technician_territories")
}

/// @description Technician KPI snapshot (periodic)
model TechnicianKPI {
  id            String   @id @default(cuid())
  technicianId  String   @map("technician_id")
  periodStart   DateTime @map("period_start")
  periodEnd     DateTime @map("period_end")
  jobsCompleted Int      @default(0) @map("jobs_completed")
  onTimeRate    Float    @default(0) @map("on_time_rate")
  callbackRate  Float    @default(0) @map("callback_rate")
  revenue       Decimal  @default(0) @map("revenue") @db.Decimal(12, 2)
  laborHours    Float    @default(0) @map("labor_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  technician Technician @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([technicianId])
  @@index([periodStart, periodEnd])
  @@map("technician_kpis")
}

generator zod {
  provider                         = "zod-prisma-types"
  output                           = "../generated/zod"
  useMultipleFiles                 = true
  createInputTypes                 = false // Disabled - causes TS OOM with large schemas
  createModelTypes                 = true
  addInputTypeValidation           = false // Disabled - requires input types
  addIncludeType                   = false // Disabled - causes type explosion
  addSelectType                    = false // Disabled - causes type explosion
  validateWhereUniqueInput         = false // Disabled - requires input types
  createOptionalDefaultValuesTypes = true
  createRelationValuesTypes        = false // Disabled - causes type explosion
  createPartialTypes               = true
  useDefaultValidators             = true
  coerceDate                       = true
  writeNullishInModelTypes         = true
  prismaClientPath                 = "../prisma" // Custom Prisma client path
}

// =============================================================================
// Datasource
// =============================================================================

// Extensions: postgis, uuid-ossp, citext, pgcrypto are required by app
// btree_gin, fuzzystrmatch, pg_trgm, postgis_tiger_geocoder, postgis_topology, unaccent, vector are from PostGIS image
datasource db {
  provider   = "postgresql"
  extensions = [postgis, uuidOssp(map: "uuid-ossp"), citext, pgcrypto, btree_gin, fuzzystrmatch, pg_trgm, postgis_tiger_geocoder, postgis_topology, unaccent, vector]
}

// =============================================================================
// ENUMS
// =============================================================================

enum OrganizationType {
  COMMUNITY_ASSOCIATION
  MANAGEMENT_COMPANY
  SERVICE_PROVIDER
  EXTERNAL_SERVICE_PROVIDER // Phase 2: External (non-platform) service providers
  COMMERCIAL_CLIENT
  INDIVIDUAL_PROPERTY_OWNER // Phase 3: Property owner (individual person)
  TRUST_OR_LLC              // Phase 3: Property owner (trust, LLC, or other entity)
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum UserRole {
  OWNER // Homeowner
  TENANT // Renter
  MANAGER // Community/Portfolio Manager
  VENDOR // Service Provider Staff
  BOARD_MEMBER
  ADMIN
}

// -----------------------------------------------------------------------------
// Phase 4: Work Orders & Assets
// -----------------------------------------------------------------------------

enum AssetStatus {
  ACTIVE
  INACTIVE
  UNDER_REPAIR
  DISPOSED
}

enum AssetCategory {
  HVAC
  PLUMBING
  ELECTRICAL
  STRUCTURAL
  LANDSCAPING
  POOL_SPA
  ELEVATOR
  SECURITY
  FIRE_SAFETY
  COMMON_AREA
  EQUIPMENT
  VEHICLE
  OTHER
}

enum WorkOrderStatus {
  DRAFT // Initial creation
  SUBMITTED // Submitted by requestor
  TRIAGED // Reviewed and categorized
  AUTHORIZED // Explicitly authorized (manager or board) - Phase 9
  ASSIGNED // Vendor assigned
  SCHEDULED // Work date scheduled
  IN_PROGRESS // Work started
  ON_HOLD // Paused for some reason
  COMPLETED // Work finished
  REVIEW_REQUIRED // Needs review before closure - Phase 9
  INVOICED // Invoice received
  CLOSED // Fully resolved
  CANCELLED // Cancelled before completion
}

enum WorkOrderPriority {
  EMERGENCY // Immediate attention required
  HIGH // Within 24 hours
  MEDIUM // Within 1 week
  LOW // Routine maintenance
  SCHEDULED // Planned maintenance
}

enum WorkOrderCategory {
  MAINTENANCE
  REPAIR
  INSPECTION
  INSTALLATION
  REPLACEMENT
  EMERGENCY
  PREVENTIVE
  LANDSCAPING
  CLEANING
  SECURITY
  OTHER
}

enum BidStatus {
  REQUESTED // Bid requested from vendor
  PENDING // Vendor is preparing bid
  SUBMITTED // Bid submitted
  UNDER_REVIEW // Being reviewed
  ACCEPTED // Bid accepted
  REJECTED // Bid rejected
  WITHDRAWN // Vendor withdrew bid
  EXPIRED // Bid expired
}

// Phase 9: Work Order Origin Types (CAM Oversight)
enum WorkOrderOriginType {
  VIOLATION_REMEDIATION // Created from violation cure requirement
  ARC_APPROVAL // Created from approved ARC request
  PREVENTIVE_MAINTENANCE // Scheduled maintenance
  BOARD_DIRECTIVE // Created from board resolution
  EMERGENCY_ACTION // Emergency work
  MANUAL // Direct creation without origin
}

// Phase 9: Board Approval Status for Work Orders
enum BoardApprovalStatus {
  PENDING // Awaiting board vote
  APPROVED // Board approved
  DENIED // Board denied
}

// -----------------------------------------------------------------------------
// Phase 5: Violations
// -----------------------------------------------------------------------------

enum ViolationStatus {
  DRAFT // Initial creation
  OPEN // Active violation
  NOTICE_SENT // Notice has been sent
  CURE_PERIOD // Waiting for cure
  CURED // Violation corrected
  ESCALATED // Escalated to next level
  HEARING_SCHEDULED // Hearing scheduled
  HEARING_HELD // Hearing completed
  FINE_ASSESSED // Fine has been assessed
  APPEALED // Under appeal
  CLOSED // Resolved/closed
  DISMISSED // Dismissed without action
}

enum ViolationSeverity {
  MINOR // Minor infraction
  MODERATE // Moderate violation
  MAJOR // Major violation
  CRITICAL // Critical/safety issue
}

enum NoticeType {
  WARNING // Informal warning
  FIRST_NOTICE // First formal notice
  SECOND_NOTICE // Second notice
  FINAL_NOTICE // Final notice before fine
  FINE_NOTICE // Fine assessment notice
  HEARING_NOTICE // Hearing notification
  CURE_CONFIRMATION // Confirmation of cure
}

enum NoticeDeliveryMethod {
  EMAIL
  MAIL
  CERTIFIED_MAIL
  POSTED // Posted on property
  HAND_DELIVERED
  PORTAL // Via owner portal
}

enum HearingOutcome {
  PENDING // Not yet held
  UPHELD // Violation upheld
  MODIFIED // Fine/penalty modified
  DISMISSED // Violation dismissed
  CONTINUED // Hearing continued
}

enum AppealStatus {
  PENDING // Appeal filed, awaiting review
  SCHEDULED // Appeal hearing scheduled
  UPHELD // Original decision upheld
  MODIFIED // Fine/penalty modified on appeal
  REVERSED // Original decision reversed
  WITHDRAWN // Appeal withdrawn by filer
}

// -----------------------------------------------------------------------------
// Phase 14: Cross-Tenant Features
// -----------------------------------------------------------------------------

enum ServiceProviderLinkStatus {
  PENDING // Link requested, awaiting verification
  VERIFIED // Link verified and active
  REJECTED // Link request rejected
  REVOKED // Link was active but has been revoked
}

// -----------------------------------------------------------------------------
// Phase 2: Contractor Operations
// -----------------------------------------------------------------------------

enum VendorApprovalStatus {
  PENDING // Awaiting approval
  APPROVED // Approved for work
  CONDITIONAL // Approved with conditions
  SUSPENDED // Temporarily suspended
  REJECTED // Rejected
}

enum ContractorTradeType {
  PLUMBING
  ELECTRICAL
  HVAC
  ROOFING
  LANDSCAPING
  PAINTING
  FLOORING
  CARPENTRY
  MASONRY
  GENERAL_CONTRACTOR
  POOL_SPA
  PEST_CONTROL
  CLEANING
  SECURITY
  FIRE_SAFETY
  ELEVATOR
  APPLIANCE_REPAIR
  LOCKSMITH
  GLASS_WINDOW
  FENCING
  CONCRETE
  DEMOLITION
  EXCAVATION
  WATERPROOFING
  INSULATION
  DRYWALL
  SIDING
  GUTTERS
  GARAGE_DOOR
  OTHER
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
  REVOKED
  PENDING_RENEWAL
}

enum InsuranceType {
  GENERAL_LIABILITY
  WORKERS_COMPENSATION
  PROFESSIONAL_LIABILITY
  AUTO_LIABILITY
  UMBRELLA
  BONDING
}

enum InsuranceStatus {
  ACTIVE
  EXPIRED
  PENDING_VERIFICATION
  CANCELLED
}

enum IndividualRequestStatus {
  SUBMITTED // Request submitted by homeowner
  REVIEWING // Being reviewed/quoted
  APPROVED // Approved by homeowner
  SCHEDULED // Work scheduled
  IN_PROGRESS // Work in progress
  COMPLETED // Work completed
  CANCELLED // Request cancelled
}

// -----------------------------------------------------------------------------
// Phase 15: Reporting & Analytics
// -----------------------------------------------------------------------------

enum ReportCategory {
  FINANCIAL // Balance sheet, income statement, etc.
  RECEIVABLES // Aged receivables, delinquency
  PAYABLES // AP aging, vendor payments
  OPERATIONAL // Work orders, violations, ARC
  COMPLIANCE // Compliance status, deadlines
  GOVERNANCE // Board reports, meeting summaries
  CUSTOM // User-defined reports
}

enum ReportFormat {
  PDF
  EXCEL
  CSV
  JSON
  HTML
}

enum ScheduleFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
  CUSTOM // Uses cronExpression
}

enum ReportDeliveryMethod {
  EMAIL
  PORTAL // Available in portal for download
  BOTH
}

enum ReportExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum WidgetType {
  CHART_BAR
  CHART_LINE
  CHART_PIE
  CHART_DONUT
  METRIC_CARD // Single value with trend
  TABLE // Data table
  LIST // Simple list
  CALENDAR // Calendar view
  MAP // Geographic map
}

// -----------------------------------------------------------------------------
// Phase 6: ARC (Architectural Requests)
// -----------------------------------------------------------------------------

enum ARCCategory {
  FENCE
  ROOF
  PAINT
  ADDITION
  LANDSCAPING
  WINDOWS
  DOORS
  DRIVEWAY
  GARAGE
  SOLAR
  HVAC
  OTHER
}

enum ARCRequestStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  CHANGES_REQUESTED
  TABLED
  WITHDRAWN
  CANCELLED
  EXPIRED
}

enum ARCReviewAction {
  APPROVE
  DENY
  REQUEST_CHANGES
  TABLE
}

enum ARCDocumentType {
  PLANS
  SPECS
  PHOTO
  PERMIT
  RENDERING
  SURVEY
  OTHER
}

// =============================================================================
// PHASE 7: Governance
// =============================================================================

enum BoardRole {
  PRESIDENT
  VICE_PRESIDENT
  SECRETARY
  TREASURER
  DIRECTOR
  MEMBER_AT_LARGE
}

enum MeetingType {
  BOARD
  ANNUAL
  SPECIAL
}

enum MeetingStatus {
  SCHEDULED
  HELD
  CANCELLED
}

enum MeetingAttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
}

enum VoteMethod {
  IN_PERSON
  PROXY
  ELECTRONIC
}

enum VoteChoice {
  YES
  NO
  ABSTAIN
}

enum ResolutionStatus {
  PROPOSED
  ADOPTED
  SUPERSEDED
  ARCHIVED
}

enum PolicyStatus {
  DRAFT
  ACTIVE
  RETIRED
}

// =============================================================================
// PHASE 8: Communications
// =============================================================================

enum CommunicationTemplateType {
  EMAIL
  SMS
  LETTER
}

enum CommunicationChannel {
  EMAIL
  SMS
  LETTER
}

enum CommunicationStatus {
  DRAFT
  SCHEDULED
  SENT
  CANCELLED
}

enum AnnouncementStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CalendarEventType {
  MEETING
  MAINTENANCE
  AMENITY_CLOSURE
  OTHER
}

enum TemplateVersionStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// =============================================================================
// CORE MODELS - Organization (Tenant)
// =============================================================================

/// @description Primary tenant entity for multitenancy
model Organization {
  id       String             @id @default(cuid())
  name     String
  slug     String             @unique
  type     OrganizationType
  status   OrganizationStatus @default(ACTIVE)
  settings Json               @default("{}")

  // Phase 2: External service provider contact info (for EXTERNAL_SERVICE_PROVIDER type)
  externalContactName  String? @map("external_contact_name")
  externalContactEmail String? @map("external_contact_email") @db.Citext
  externalContactPhone String? @map("external_contact_phone")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  memberships         UserOrganization[]
  idempotencyKeys     IdempotencyKey[]
  associations        Association[]
  parties             Party[]
  managedAssociations ManagementContract[] // For management companies

  // Phase 12: Compliance
  complianceRequirements ComplianceRequirement[]

  // Phase 14: Cross-Tenant Features
  serviceAreas              ServiceArea[]                  @relation("ServiceProviderAreas")
  serviceProviderLinks      ServiceProviderLink[]          @relation("ServiceProviderLinks")
  individualProperties      IndividualProperty[]           @relation("IndividualProperties")
  vendorMaintenanceRequests IndividualMaintenanceRequest[] @relation("VendorMaintenanceRequests")

  // Phase 2: Contractor Operations
  contractorProfile  ContractorProfile?
  contractorBranches ContractorBranch[]
  technicians        Technician[]
  pricebooks         Pricebook[]
  jobTemplates       JobTemplate[]
  customers          Customer[]
  jobs               Job[]

  // Phase 2: Dispatch & Scheduling
  dispatchAssignments DispatchAssignment[]
  scheduleSlots       ScheduleSlot[]
  routePlans          RoutePlan[]
  slaWindows          SLAWindow[]
  slaRecords          SLARecord[]

  // Phase 2: Field Technician Mobile
  jobChecklists    JobChecklist[]
  jobMedia         JobMedia[]
  jobTimeEntries   JobTimeEntry[]
  jobSignatures    JobSignature[]
  offlineSyncQueue OfflineSyncQueue[]

  // Phase 2: Estimates, Proposals & Invoicing
  estimates      Estimate[]
  proposals      Proposal[]
  jobInvoices    JobInvoice[]
  paymentIntents PaymentIntent[]

  // Phase 2: Inventory, Materials & Procurement
  suppliers           Supplier[]
  inventoryItems      InventoryItem[]
  inventoryLocations  InventoryLocation[]
  inventoryTransfers  InventoryTransfer[]
  materialUsages      MaterialUsage[]
  purchaseOrders      PurchaseOrder[]

  // Phase 2: Maintenance Contracts
  serviceContracts ServiceContract[]

  // Phase 4: Activity & Audit
  activityEvents ActivityEvent[]

  // Phase 3: Concierge Property Owner Platform
  propertyPortfolios PropertyPortfolio[]
  ownerIntents       OwnerIntent[]
  conciergeCases     ConciergeCase[]

  // Phase 3.5: Unified Document Management
  documents Document[]

  // Phase 3.7-3.9: External Context & Decisions
  externalHoaContexts    ExternalHOAContext[]
  externalVendorContexts ExternalVendorContext[]
  linkedVendorContexts   ExternalVendorContext[] @relation("LinkedServiceProvider")
  materialDecisions      MaterialDecision[]

  @@map("organizations")
}

// =============================================================================
// CORE MODELS - User & Authentication
// =============================================================================

/// @description Platform user account
model User {
  id            String  @id @default(cuid())
  email         String  @unique @db.Citext
  emailVerified Boolean @default(false) @map("email_verified")
  name          String?
  image         String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  memberships        UserOrganization[]
  sessions           Session[]
  accounts           Account[]
  parties            Party[] // Party records linked to this user
  managerAssignments ManagerAssignment[]
  // Phase 6: ARC
  arcReviews         ARCReview[]

  // Phase 3: Concierge Cases
  assignedConciergeCases ConciergeCase[] @relation("AssignedConciergeCases")
  performedActions       ConciergeAction[] @relation("ActionPerformer")
  materialDecisions      MaterialDecision[] @relation("DecisionMaker")

  @@map("users")
}

/// @description Junction table for user-organization membership with roles
model UserOrganization {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  organizationId String   @map("organization_id")
  role           UserRole @default(OWNER)
  isDefault      Boolean  @default(false) @map("is_default")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@map("user_organizations")
}

/// @description User session for authentication
model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

/// @description OAuth account linking
model Account {
  id                    String    @id @default(cuid())
  userId                String    @map("user_id")
  accountId             String    @map("account_id")
  providerId            String    @map("provider_id")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                 String?
  idToken               String?   @map("id_token")
  password              String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

/// @description Email verification tokens
model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("verifications")
}

// =============================================================================
// CORE MODELS - Idempotency & Audit
// =============================================================================

/// @description Tracks idempotency keys for mutating operations
model IdempotencyKey {
  id             String @id @default(cuid())
  key            String
  organizationId String @map("organization_id")
  response       Json?
  statusCode     Int?   @map("status_code")

  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([key, organizationId])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

/// @description Activity event for tracking business actions across the platform (Phase 4)
model ActivityEvent {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // Event classification
  entityType    ActivityEntityType    @map("entity_type")
  entityId      String                @map("entity_id")
  action        ActivityActionType
  eventCategory ActivityEventCategory @map("event_category")
  summary       String                // Human-readable description

  // Actor information
  performedById   String?           @map("performed_by_id")
  performedByType ActivityActorType @map("performed_by_type")
  performedAt     DateTime          @default(now()) @map("performed_at")

  // Request context
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  // Phase 1 context (CAM)
  associationId String? @map("association_id")
  unitId        String? @map("unit_id")
  violationId   String? @map("violation_id")
  arcRequestId  String? @map("arc_request_id")

  // Phase 2 context (Contractor)
  jobId        String? @map("job_id")
  workOrderId  String? @map("work_order_id")
  technicianId String? @map("technician_id")

  // Phase 3 context (Concierge)
  caseId     String? @map("case_id")
  intentId   String? @map("intent_id")
  propertyId String? @map("property_id")
  decisionId String? @map("decision_id")

  // Change tracking
  previousState Json? @map("previous_state")
  newState      Json? @map("new_state")

  // Extensible metadata (documents referenced, authorization context, AI reasoning, etc.)
  metadata Json?

  // Tracing
  traceId String? @map("trace_id") // OpenTelemetry trace ID

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes for common queries
  @@index([organizationId, performedAt])
  @@index([organizationId, entityType, entityId])
  @@index([organizationId, eventCategory])
  @@index([organizationId, performedByType])
  @@index([associationId])
  @@index([caseId])
  @@index([jobId])
  @@index([workOrderId])
  @@index([intentId])
  @@index([propertyId])
  @@map("activity_events")
}

// =============================================================================
// PHASE 4 - ACTIVITY & AUDIT ENUMS
// =============================================================================

/// @description Entity types that can be audited across all pillars
enum ActivityEntityType {
  // Phase 1 - CAM
  ASSOCIATION
  UNIT
  OWNER
  VIOLATION
  ARC_REQUEST
  ASSESSMENT
  GOVERNING_DOCUMENT
  BOARD_ACTION

  // Phase 2 - Contractor
  JOB
  WORK_ORDER
  ESTIMATE
  INVOICE
  TECHNICIAN
  CONTRACTOR
  INVENTORY

  // Phase 3 - Concierge
  CONCIERGE_CASE
  OWNER_INTENT
  INDIVIDUAL_PROPERTY
  PROPERTY_DOCUMENT
  MATERIAL_DECISION
  EXTERNAL_HOA
  EXTERNAL_VENDOR
  CONCIERGE_ACTION

  // Cross-cutting
  USER
  USER_ROLE
  ORGANIZATION
  DOCUMENT

  // Escape hatch
  OTHER
}

/// @description Action types for activity events
enum ActivityActionType {
  CREATE
  UPDATE
  DELETE
  STATUS_CHANGE
  APPROVE
  DENY
  ASSIGN
  UNASSIGN
  SUBMIT
  CANCEL
  COMPLETE
  SCHEDULE
  DISPATCH
  CLOSE
  REOPEN
  ESCALATE
  ROLE_CHANGE
  LOGIN
  LOGOUT
  WORKFLOW_INITIATED
  WORKFLOW_COMPLETED
  WORKFLOW_FAILED
  CUSTOM
  // Document-specific actions
  CLASSIFY // Document classification/reclassification
  VERSION // New document version created
  SUPERSEDE // Document superseded by newer version
  REFERENCED // Document referenced in a decision
}

/// @description Actor types for activity events
enum ActivityActorType {
  HUMAN
  AI
  SYSTEM
}

/// @description Event category for intent vs decision vs execution distinction
enum ActivityEventCategory {
  INTENT     // User requested/expressed desire
  DECISION   // Determination made (human or AI)
  EXECUTION  // Action taken
  SYSTEM     // Background/automated
}

// =============================================================================
// DOMAIN 1 - ENUMS
// =============================================================================

enum AssociationStatus {
  ACTIVE
  ONBOARDING
  SUSPENDED
  TERMINATED
}

enum PropertyType {
  SINGLE_FAMILY
  CONDOMINIUM
  TOWNHOUSE
  COOPERATIVE
  MIXED_USE
  COMMERCIAL
}

enum UnitType {
  SINGLE_FAMILY_HOME
  CONDO_UNIT
  TOWNHOUSE
  LOT
  COMMERCIAL_UNIT
}

enum AmenityType {
  POOL
  CLUBHOUSE
  GYM
  TENNIS_COURT
  PLAYGROUND
  PARK
  GATE
  PARKING
  OTHER
}

enum PartyType {
  INDIVIDUAL
  TRUST
  CORPORATION
  LLC
  PARTNERSHIP
  ESTATE
}

enum OwnershipType {
  FEE_SIMPLE
  JOINT_TENANCY
  TENANCY_IN_COMMON
  COMMUNITY_PROPERTY
  TRUST
}

// -----------------------------------------------------------------------------
// Phase 9: Owner Portal / CRM
// -----------------------------------------------------------------------------

enum ContactPreferenceChannel {
  EMAIL
  SMS
  PUSH
  MAIL
  PORTAL
}

enum NotificationCategory {
  GENERAL
  BILLING
  MAINTENANCE
  GOVERNANCE
  ARC
  VIOLATION
  COMMUNICATION
}

enum OwnerRequestStatus {
  DRAFT
  SUBMITTED
  IN_PROGRESS
  RESOLVED
  CLOSED
  CANCELLED
}

enum OwnerRequestCategory {
  GENERAL_INQUIRY
  MAINTENANCE
  BILLING
  ARCHITECTURAL
  VIOLATION
  GOVERNANCE
  AMENITY
  OTHER
}

enum PaymentMethodType {
  BANK_ACCOUNT
  CREDIT_CARD
  DEBIT_CARD
}

enum AutoPayFrequency {
  MONTHLY
  QUARTERLY
  ANNUALLY
  ON_DUE_DATE
}

enum DocumentVisibility {
  PUBLIC // All association members
  OWNERS_ONLY // Only owners
  BOARD_ONLY // Only board members
  STAFF_ONLY // Only staff/managers
  PRIVATE // Specific parties only
}

enum DocumentCategory {
  // === CAM / HOA ===
  GOVERNING_DOCS // CC&Rs, Bylaws, Rules
  FINANCIAL // Budgets, audits, statements
  MEETING // Minutes, agendas
  LEGAL // Contracts, legal notices
  INSURANCE // Policies, certificates
  MAINTENANCE // Maintenance records, warranties
  ARCHITECTURAL // ARC guidelines, approvals
  RESERVE_STUDY // Reserve studies
  INSPECTION // Inspection reports
  CONTRACT // Vendor contracts

  // === Property Owner / Concierge ===
  CC_AND_RS // CC&Rs (owner-held copy)
  PERMIT // Building permits, work permits
  APPROVAL // HOA approvals, government approvals
  CORRESPONDENCE // Letters, emails, notices
  TITLE_DEED // Property title, deed
  SURVEY // Property surveys, plats
  WARRANTY // Product/service warranties

  // === Contractor / Service Provider ===
  LICENSE // Business/trade licenses
  CERTIFICATION // Professional certifications
  BOND // Bonding documents
  PROPOSAL // Service proposals
  ESTIMATE // Cost estimates
  INVOICE // Invoices, receipts
  WORK_ORDER // Work order documents
  JOB_PHOTO // Before/after photos
  JOB_VIDEO // Job videos
  VOICE_NOTE // Voice memos, transcriptions
  SIGNATURE // Digital signatures
  CHECKLIST // Completed checklists

  // === Cross-Pillar ===
  GENERAL // Other documents
}

/// @description Context types for document bindings
enum DocumentContextType {
  ASSOCIATION // HOA/CAM association
  PROPERTY // Individual property
  UNIT // Unit within association
  JOB // Service job
  CASE // Concierge case
  WORK_ORDER // Work order
  TECHNICIAN // Technician profile
  CONTRACTOR // Contractor profile
  VENDOR // Vendor
  PARTY // Party (person/entity)
  OWNER_INTENT // Owner intent/request
  VIOLATION // Violation record
  ARC_REQUEST // Architectural review request
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  SUPERSEDED
  ARCHIVED
}

enum StorageProvider {
  LOCAL
  S3
  AZURE_BLOB
  GCS
}

// -----------------------------------------------------------------------------
// Phase 11: Reserve Studies
// -----------------------------------------------------------------------------

enum ReserveComponentCategory {
  ROOFING
  PAVING
  PAINTING
  PLUMBING
  ELECTRICAL
  HVAC
  POOL_SPA
  LANDSCAPING
  FENCING
  STRUCTURAL
  ELEVATOR
  COMMON_AREA
  EQUIPMENT
  OTHER
}

enum ReserveStudyType {
  FULL // Full on-site inspection
  UPDATE_WITH_SITE // Update with site visit
  UPDATE_NO_SITE // Update without site visit
}

enum FundingPlanType {
  BASELINE // Maintain positive balance
  THRESHOLD // Maintain minimum threshold
  FULL_FUNDING // 100% funded target
  STATUTORY // State-mandated minimum
}

// -----------------------------------------------------------------------------
// Phase 12: Compliance
// -----------------------------------------------------------------------------

enum ComplianceRequirementType {
  STATUTORY_DEADLINE // State/local law deadlines
  NOTICE_REQUIREMENT // Required notices to owners
  VOTING_RULE // Election/voting requirements
  FINANCIAL_AUDIT // Audit requirements
  RESALE_PACKET // Resale disclosure requirements
  INSURANCE // Insurance requirements
  MEETING // Required meetings
  FILING // Government filings
  RECORD_RETENTION // Document retention rules
  OTHER
}

enum ComplianceStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  WAIVED
  NOT_APPLICABLE
}

enum RecurrencePattern {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

// =============================================================================
// DOMAIN 1 - Association / Property Model
// =============================================================================

/// @description Community Association (HOA/COA/POA)
model Association {
  id                String            @id @default(cuid())
  organizationId    String            @map("organization_id")
  name              String
  legalName         String?           @map("legal_name")
  taxId             String?           @map("tax_id")
  status            AssociationStatus @default(ONBOARDING)
  incorporationDate DateTime?         @map("incorporation_date")
  fiscalYearEnd     Int               @default(12) @map("fiscal_year_end") // Month (1-12)
  settings          Json              @default("{}")
  deletedAt         DateTime?         @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  properties          Property[]
  managementContracts ManagementContract[]
  managerAssignments  ManagerAssignment[]

  // Accounting relations
  glAccounts        GLAccount[]
  journalEntries    JournalEntry[]
  bankAccounts      BankAccount[]
  assessmentTypes   AssessmentType[]
  assessmentCharges AssessmentCharge[]
  payments          Payment[]
  vendors           Vendor[]
  apInvoices        APInvoice[]

  // Phase 4: Work Orders & Assets
  assets           Asset[]
  workOrders       WorkOrder[]
  serviceProviders AssociationServiceProvider[]

  // Phase 5: Violations
  violationTypes ViolationType[]
  violations     Violation[]

  // Phase 6: ARC
  arcCommittees ARCCommittee[]
  arcRequests   ARCRequest[]

  // Phase 7: Governance
  boards                 Board[]
  meetings               Meeting[]
  resolutions            Resolution[]
  policyDocuments        PolicyDocument[]
  communicationTemplates CommunicationTemplate[]
  massCommunications     MassCommunication[]
  announcements          Announcement[]
  calendarEvents         CalendarEvent[]
  calendarNotifications  CalendarEventNotification[]

  // Phase 9: Owner Portal / CRM
  ownerRequests OwnerRequest[]
  // Documents are now accessed via DocumentContextBinding with contextType=ASSOCIATION

  // Phase 11: Reserve Studies
  reserveComponents ReserveComponent[]
  reserveStudies    ReserveStudy[]

  // Phase 12: Compliance
  complianceDeadlines ComplianceDeadline[]

  // Phase 5: Notice Templates
  noticeTemplates NoticeTemplate[]

  // Phase 15: Reporting
  reportDefinitions ReportDefinition[]
  reportSchedules   ReportSchedule[]
  reportExecutions  ReportExecution[]
  dashboardWidgets  DashboardWidget[]
  priceRules        PriceRule[]

  // Phase 2: Job Lifecycle
  jobs Job[]

  // Phase 2: Maintenance Contracts
  serviceContracts ServiceContract[]

  @@index([organizationId])
  @@map("associations")
}

/// @description Property/Community managed by an association
model Property {
  id            String       @id @default(cuid())
  associationId String       @map("association_id")
  name          String
  propertyType  PropertyType @map("property_type")

  // Address
  addressLine1 String  @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String
  state        String
  postalCode   String  @map("postal_code")
  country      String  @default("US")

  // Geo (PostGIS point)
  latitude  Float?
  longitude Float?

  // Metadata
  yearBuilt  Int?   @map("year_built")
  totalUnits Int    @default(0) @map("total_units")
  totalAcres Float? @map("total_acres")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  units       Unit[]
  commonAreas CommonArea[]
  jobs        Job[]

  // Maintenance Contracts
  serviceContracts ServiceContract[]

  @@index([associationId])
  @@map("properties")
}

/// @description Individual unit/lot within a property
model Unit {
  id         String   @id @default(cuid())
  propertyId String   @map("property_id")
  unitNumber String   @map("unit_number")
  unitType   UnitType @map("unit_type")

  // Address (if different from property)
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")

  // Unit details
  bedrooms      Int?
  bathrooms     Float?
  squareFeet    Int?   @map("square_feet")
  lotSquareFeet Int?   @map("lot_square_feet")
  parkingSpaces Int    @default(0) @map("parking_spaces")

  // Assessment info
  assessmentClass String? @map("assessment_class")
  votingWeight    Float   @default(1) @map("voting_weight")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  property   Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  ownerships Ownership[]
  tenancies  Tenancy[]

  // Accounting relations
  assessmentCharges AssessmentCharge[]
  payments          Payment[]

  // Phase 4: Work Orders & Assets
  assets     Asset[]
  workOrders WorkOrder[]

  // Phase 5: Violations
  violations Violation[]

  // Phase 6: ARC
  arcRequests ARCRequest[]

  // Phase 9: Owner Portal / CRM
  ownerRequests OwnerRequest[]

  // Phase 2: Job Lifecycle
  jobs Job[]

  // Maintenance Contracts
  serviceContracts ServiceContract[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@map("units")
}

/// @description Common area or amenity
model CommonArea {
  id          String      @id @default(cuid())
  propertyId  String      @map("property_id")
  name        String
  amenityType AmenityType @map("amenity_type")
  description String?

  // Location within property
  location String?

  // Scheduling
  reservable  Boolean @default(false)
  maxCapacity Int?    @map("max_capacity")

  // Operating hours (JSON: { monday: { open: "09:00", close: "21:00" }, ... })
  operatingHours Json? @map("operating_hours")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("common_areas")
}

// =============================================================================
// DOMAIN 1 - Party & Relationship Models
// =============================================================================

/// @description Person or entity that can own/rent property
model Party {
  id             String    @id @default(cuid())
  organizationId String    @map("organization_id")
  partyType      PartyType @map("party_type")

  // For individuals
  firstName String? @map("first_name")
  lastName  String? @map("last_name")

  // For entities
  entityName String? @map("entity_name")

  // Contact
  email String? @db.Citext
  phone String?

  // Address
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String? @default("US")

  // Link to platform user (if registered)
  userId String? @map("user_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  ownerships   Ownership[]
  tenancies    Tenancy[]

  // Accounting relations
  payments Payment[] // Payments made by this party

  // Phase 5: Violations
  violations Violation[] // Violations where this party is responsible

  // Phase 6: ARC
  arcRequests             ARCRequest[]         @relation("PartyARCRequests") // Requests submitted by this party
  arcCommitteeMemberships ARCCommitteeMember[]

  // Phase 7: Governance
  boardMemberships  BoardMember[]
  meetingAttendance MeetingAttendance[]
  voteBallots       VoteBallot[]
  announcementReads AnnouncementRead[]

  // Phase 9: Owner Portal / CRM
  userProfile          UserProfile?
  contactPreferences   ContactPreference[]
  notificationSettings NotificationSetting[]
  ownerRequests        OwnerRequest[]
  storedPaymentMethods StoredPaymentMethod[]
  autoPaySettings      AutoPaySetting[]
  documentAccessGrants DocumentAccessGrant[]
  documentDownloadLogs DocumentDownloadLog[]

  // Phase 3: Property Ownership
  propertyOwnerships    PropertyOwnership[]
  delegatedAuthorities  DelegatedAuthority[] @relation("DelegatedAuthorities")
  submittedIntents      OwnerIntent[]        @relation("IntentSubmitter")
  caseParticipations    CaseParticipant[]    @relation("CaseParticipants")

  @@index([organizationId])
  @@index([userId])
  @@index([email])
  @@map("parties")
}

// =============================================================================
// DOMAIN 5 - Violations
// =============================================================================

/// @description Configurable violation type for an association
model ViolationType {
  id                    String            @id @default(cuid())
  associationId         String            @map("association_id")
  code                  String
  name                  String
  description           String?
  category              String
  ccnrSection           String?           @map("ccnr_section")
  ruleReference         String?           @map("rule_reference")
  defaultSeverity       ViolationSeverity @default(MODERATE) @map("default_severity")
  defaultCurePeriodDays Int               @default(14) @map("default_cure_period_days")
  firstFineAmount       Decimal?          @map("first_fine_amount") @db.Decimal(10, 2)
  secondFineAmount      Decimal?          @map("second_fine_amount") @db.Decimal(10, 2)
  subsequentFineAmount  Decimal?          @map("subsequent_fine_amount") @db.Decimal(10, 2)
  maxFineAmount         Decimal?          @map("max_fine_amount") @db.Decimal(10, 2)
  warningTemplateId     String?           @map("warning_template_id")
  noticeTemplateId      String?           @map("notice_template_id")
  isActive              Boolean           @default(true) @map("is_active")
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")

  // Relations
  association     Association            @relation(fields: [associationId], references: [id], onDelete: Cascade)
  warningTemplate NoticeTemplate?        @relation("ViolationTypeWarningTemplate", fields: [warningTemplateId], references: [id], onDelete: SetNull)
  noticeTemplate  NoticeTemplate?        @relation("ViolationTypeNoticeTemplate", fields: [noticeTemplateId], references: [id], onDelete: SetNull)
  violations      Violation[]
  sequenceConfigs NoticeSequenceConfig[]

  @@unique([associationId, code])
  @@index([associationId])
  @@map("violation_types")
}

/// @description Violation instance
model Violation {
  id                 String            @id @default(cuid())
  associationId      String            @map("association_id")
  violationNumber    String            @map("violation_number")
  violationTypeId    String            @map("violation_type_id")
  unitId             String?           @map("unit_id")
  commonAreaName     String?           @map("common_area_name")
  locationDetails    String?           @map("location_details")
  title              String
  description        String?           @db.Text
  severity           ViolationSeverity
  status             ViolationStatus   @default(DRAFT)
  observedDate       DateTime          @map("observed_date")
  reportedDate       DateTime          @default(now()) @map("reported_date")
  curePeriodEnds     DateTime?         @map("cure_period_ends")
  curedDate          DateTime?         @map("cured_date")
  closedDate         DateTime?         @map("closed_date")
  responsiblePartyId String?           @map("responsible_party_id")
  reportedBy         String            @map("reported_by")
  reporterType       String?           @map("reporter_type")
  totalFinesAssessed Decimal           @default(0) @map("total_fines_assessed") @db.Decimal(10, 2)
  totalFinesPaid     Decimal           @default(0) @map("total_fines_paid") @db.Decimal(10, 2)
  totalFinesWaived   Decimal           @default(0) @map("total_fines_waived") @db.Decimal(10, 2)
  noticeCount        Int               @default(0) @map("notice_count")
  lastNoticeDate     DateTime?         @map("last_notice_date")
  lastNoticeType     NoticeType?       @map("last_notice_type")
  resolutionNotes    String?           @map("resolution_notes") @db.Text
  closedBy           String?           @map("closed_by")
  deletedAt          DateTime?         @map("deleted_at")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  association      Association              @relation(fields: [associationId], references: [id], onDelete: Cascade)
  violationType    ViolationType            @relation(fields: [violationTypeId], references: [id], onDelete: Restrict)
  unit             Unit?                    @relation(fields: [unitId], references: [id], onDelete: SetNull)
  responsibleParty Party?                   @relation(fields: [responsiblePartyId], references: [id], onDelete: SetNull)
  evidence         ViolationEvidence[]
  notices          ViolationNotice[]
  hearings         ViolationHearing[]
  fines            ViolationFine[]
  statusHistory    ViolationStatusHistory[]

  // Phase 9: Work Orders created from this violation
  workOrders WorkOrder[]

  @@index([associationId])
  @@index([violationTypeId])
  @@index([unitId])
  @@index([status])
  @@index([observedDate])
  @@index([responsiblePartyId])
  @@map("violations")
}

/// @description Evidence attached to a violation
model ViolationEvidence {
  id           String    @id @default(cuid())
  violationId  String    @map("violation_id")
  evidenceType String    @map("evidenceType")
  fileName     String    @map("file_name")
  fileUrl      String    @map("file_url")
  fileSize     Int?      @map("file_size")
  mimeType     String?   @map("mime_type")
  description  String?
  capturedAt   DateTime? @map("captured_at")
  capturedBy   String?   @map("captured_by")
  gpsLatitude  Decimal?  @map("gps_latitude") @db.Decimal(10, 8)
  gpsLongitude Decimal?  @map("gps_longitude") @db.Decimal(11, 8)
  uploadedBy   String    @map("uploaded_by")
  uploadedAt   DateTime  @default(now()) @map("uploaded_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  violation Violation @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@map("violation_evidence")
}

/// @description Notice issued for a violation
model ViolationNotice {
  id                String               @id @default(cuid())
  violationId       String               @map("violation_id")
  noticeType        NoticeType           @map("notice_type")
  noticeNumber      Int                  @map("notice_number")
  subject           String
  body              String
  deliveryMethod    NoticeDeliveryMethod @map("delivery_method")
  recipientName     String               @map("recipient_name")
  recipientAddress  String?              @map("recipient_address")
  recipientEmail    String?              @map("recipient_email")
  sentDate          DateTime             @map("sent_date")
  deliveredDate     DateTime?            @map("delivered_date")
  curePeriodDays    Int?                 @map("cure_period_days")
  curePeriodEnds    DateTime?            @map("cure_period_ends")
  trackingNumber    String?              @map("tracking_number")
  deliveryConfirmed Boolean              @default(false) @map("delivery_confirmed")
  sentBy            String               @map("sent_by")
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")

  // Relations
  violation Violation @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([noticeType])
  @@map("violation_notices")
}

/// @description Hearing scheduled for a violation
model ViolationHearing {
  id             String         @id @default(cuid())
  violationId    String         @map("violation_id")
  hearingDate    DateTime       @map("hearing_date")
  hearingTime    String?        @map("hearing_time")
  location       String?
  hearingOfficer String?        @map("hearing_officer")
  attendees      String?
  outcome        HearingOutcome @default(PENDING)
  outcomeNotes   String?        @map("outcome_notes")
  fineAssessed   Decimal?       @map("fine_assessed") @db.Decimal(10, 2)
  fineWaived     Decimal?       @map("fine_waived") @db.Decimal(10, 2)
  appealDeadline DateTime?      @map("appeal_deadline")
  appealFiled    Boolean        @default(false) @map("appeal_filed")
  appealDate     DateTime?      @map("appeal_date")
  recordedBy     String?        @map("recorded_by")
  recordedAt     DateTime?      @map("recorded_at")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  violation Violation         @relation(fields: [violationId], references: [id], onDelete: Cascade)
  appeals   ViolationAppeal[]

  @@index([violationId])
  @@index([hearingDate])
  @@map("violation_hearings")
}

/// @description Fine assessed for a violation
model ViolationFine {
  id                 String    @id @default(cuid())
  violationId        String    @map("violation_id")
  fineNumber         Int       @map("fine_number")
  amount             Decimal   @db.Decimal(10, 2)
  reason             String?
  assessedDate       DateTime  @map("assessed_date")
  dueDate            DateTime  @map("due_date")
  paidAmount         Decimal   @default(0) @map("paid_amount") @db.Decimal(10, 2)
  waivedAmount       Decimal   @default(0) @map("waived_amount") @db.Decimal(10, 2)
  balanceDue         Decimal   @map("balance_due") @db.Decimal(10, 2)
  waivedBy           String?   @map("waived_by")
  waivedDate         DateTime? @map("waived_date")
  waiverReason       String?   @map("waiver_reason")
  assessmentChargeId String?   @map("assessment_charge_id")
  glPosted           Boolean   @default(false) @map("gl_posted")
  assessedBy         String    @map("assessed_by")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  violation Violation @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@index([assessedDate])
  @@map("violation_fines")
}

/// @description Status change history for a violation
model ViolationStatusHistory {
  id          String           @id @default(cuid())
  violationId String           @map("violation_id")
  fromStatus  ViolationStatus?
  toStatus    ViolationStatus
  changedBy   String           @map("changed_by")
  changedAt   DateTime         @default(now()) @map("changed_at")
  notes       String?

  // Relations
  violation Violation @relation(fields: [violationId], references: [id], onDelete: Cascade)

  @@index([violationId])
  @@map("violation_status_history")
}

/// @description Notice template for violation notices
model NoticeTemplate {
  id                    String     @id @default(cuid())
  associationId         String     @map("association_id")
  name                  String
  noticeType            NoticeType @map("notice_type")
  subject               String
  bodyTemplate          String     @map("body_template") @db.Text // Supports {{variable}} placeholders
  defaultCurePeriodDays Int?       @map("default_cure_period_days")
  isActive              Boolean    @default(true) @map("is_active")
  createdAt             DateTime   @default(now()) @map("created_at")
  updatedAt             DateTime   @updatedAt @map("updated_at")

  // Relations
  association     Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)
  warningForTypes ViolationType[]      @relation("ViolationTypeWarningTemplate")
  noticeForTypes  ViolationType[]      @relation("ViolationTypeNoticeTemplate")
  sequenceSteps   NoticeSequenceStep[]

  @@unique([associationId, name])
  @@index([associationId])
  @@index([noticeType])
  @@map("notice_templates")
}

/// @description Notice sequence configuration per violation type
model NoticeSequenceConfig {
  id              String  @id @default(cuid())
  violationTypeId String  @map("violation_type_id")
  name            String
  description     String?
  isDefault       Boolean @default(false) @map("is_default")
  isActive        Boolean @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  violationType ViolationType        @relation(fields: [violationTypeId], references: [id], onDelete: Cascade)
  steps         NoticeSequenceStep[]

  @@index([violationTypeId])
  @@map("notice_sequence_configs")
}

/// @description Steps in a notice sequence
model NoticeSequenceStep {
  id                String   @id @default(cuid())
  sequenceId        String   @map("sequence_id")
  templateId        String   @map("template_id")
  stepOrder         Int      @map("step_order")
  daysAfterPrevious Int      @default(0) @map("days_after_previous")
  requiresCure      Boolean  @default(true) @map("requires_cure")
  autoSend          Boolean  @default(false) @map("auto_send")
  assessFine        Boolean  @default(false) @map("assess_fine")
  fineAmount        Decimal? @map("fine_amount") @db.Decimal(10, 2)
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  sequence NoticeSequenceConfig @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  template NoticeTemplate       @relation(fields: [templateId], references: [id])

  @@unique([sequenceId, stepOrder])
  @@index([sequenceId])
  @@map("notice_sequence_steps")
}

/// @description Appeal filed against a hearing decision
model ViolationAppeal {
  id                    String       @id @default(cuid())
  hearingId             String       @map("hearing_id")
  filedDate             DateTime     @map("filed_date")
  filedBy               String       @map("filed_by")
  reason                String       @db.Text
  documentsJson         String?      @map("documents_json") @db.Text
  appealHearingDate     DateTime?    @map("appeal_hearing_date")
  appealHearingLocation String?      @map("appeal_hearing_location")
  status                AppealStatus @default(PENDING)
  decisionDate          DateTime?    @map("decision_date")
  decisionBy            String?      @map("decision_by")
  decisionNotes         String?      @map("decision_notes") @db.Text
  originalFineAmount    Decimal?     @map("original_fine_amount") @db.Decimal(10, 2)
  revisedFineAmount     Decimal?     @map("revised_fine_amount") @db.Decimal(10, 2)
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  // Relations
  hearing ViolationHearing @relation(fields: [hearingId], references: [id], onDelete: Cascade)

  @@index([hearingId])
  @@index([status])
  @@map("violation_appeals")
}

/// @description User profile for portal/CRM
model UserProfile {
  id              String  @id @default(cuid())
  partyId         String  @map("party_id")
  preferredName   String? @map("preferred_name")
  profilePhotoUrl String? @map("profile_photo_url")
  language        String  @default("en") @map("language")
  timezone        String  @default("UTC") @map("timezone")
  mailingAddress  Json?   @map("mailing_address")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId])
  @@map("user_profiles")
}

/// @description Contact channel preferences for a party
model ContactPreference {
  id                 String                   @id @default(cuid())
  partyId            String                   @map("party_id")
  channel            ContactPreferenceChannel
  isEnabled          Boolean                  @default(true) @map("is_enabled")
  allowTransactional Boolean                  @default(true) @map("allow_transactional")
  allowMarketing     Boolean                  @default(false) @map("allow_marketing")
  allowEmergency     Boolean                  @default(true) @map("allow_emergency")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, channel])
  @@map("contact_preferences")
}

/// @description Notification preferences per category and channel
model NotificationSetting {
  id        String                   @id @default(cuid())
  partyId   String                   @map("party_id")
  category  NotificationCategory
  channel   ContactPreferenceChannel
  isEnabled Boolean                  @default(true) @map("is_enabled")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([partyId, category, channel])
  @@map("notification_settings")
}

/// @description Owner request / inquiry submitted via portal
model OwnerRequest {
  id            String  @id @default(cuid())
  associationId String  @map("association_id")
  unitId        String? @map("unit_id")
  partyId       String  @map("party_id")

  requestNumber String               @map("request_number") // e.g., REQ-2024-000001
  category      OwnerRequestCategory
  status        OwnerRequestStatus   @default(DRAFT)

  subject     String
  description String @db.Text
  attachments Json? // Array of file URLs/metadata

  // Tracking
  submittedAt DateTime? @map("submitted_at")
  resolvedAt  DateTime? @map("resolved_at")
  closedAt    DateTime? @map("closed_at")

  // Assignment
  assignedToUserId String? @map("assigned_to_user_id")

  // Resolution
  resolutionNotes String? @map("resolution_notes") @db.Text

  // Conversion to work order
  workOrderId String? @map("work_order_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association Association           @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit        Unit?                 @relation(fields: [unitId], references: [id])
  party       Party                 @relation(fields: [partyId], references: [id])
  workOrder   WorkOrder?            @relation(fields: [workOrderId], references: [id])
  history     OwnerRequestHistory[]

  @@unique([associationId, requestNumber])
  @@index([partyId])
  @@index([unitId])
  @@index([status])
  @@index([category])
  @@map("owner_requests")
}

/// @description History/audit trail for owner requests
model OwnerRequestHistory {
  id        String @id @default(cuid())
  requestId String @map("request_id")

  action         String // e.g., "CREATED", "SUBMITTED", "ASSIGNED", "RESOLVED", "CLOSED"
  previousStatus String? @map("previous_status")
  newStatus      String? @map("new_status")
  notes          String? @db.Text
  performedBy    String  @map("performed_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  request OwnerRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("owner_request_history")
}

/// @description Stored payment method for a party (tokenized reference only)
model StoredPaymentMethod {
  id      String @id @default(cuid())
  partyId String @map("party_id")

  methodType      PaymentMethodType @map("method_type")
  nickname        String? // e.g., "My Checking Account"
  lastFour        String            @map("last_four") // Last 4 digits
  expirationMonth Int?              @map("expiration_month") // For cards
  expirationYear  Int?              @map("expiration_year") // For cards
  bankName        String?           @map("bank_name") // For bank accounts

  // Tokenized reference (from payment processor)
  processorToken String @map("processor_token")
  processorType  String @map("processor_type") // e.g., "STRIPE", "PLAID"

  isDefault  Boolean @default(false) @map("is_default")
  isVerified Boolean @default(false) @map("is_verified")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  party           Party            @relation(fields: [partyId], references: [id], onDelete: Cascade)
  autoPaySettings AutoPaySetting[]

  @@index([partyId])
  @@map("stored_payment_methods")
}

/// @description Auto-pay configuration for a party
model AutoPaySetting {
  id              String @id @default(cuid())
  partyId         String @map("party_id")
  paymentMethodId String @map("payment_method_id")

  isEnabled  Boolean          @default(true) @map("is_enabled")
  frequency  AutoPayFrequency
  dayOfMonth Int?             @map("day_of_month") // 1-28 for monthly
  maxAmount  Decimal?         @map("max_amount") @db.Decimal(10, 2)

  // Scope (optional - if null, applies to all charges)
  associationId    String? @map("association_id")
  assessmentTypeId String? @map("assessment_type_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  party         Party               @relation(fields: [partyId], references: [id], onDelete: Cascade)
  paymentMethod StoredPaymentMethod @relation(fields: [paymentMethodId], references: [id])

  @@unique([partyId, associationId, assessmentTypeId])
  @@index([partyId])
  @@index([paymentMethodId])
  @@map("auto_pay_settings")
}

/// @description Ownership record linking party to unit
model Ownership {
  id            String        @id @default(cuid())
  unitId        String        @map("unit_id")
  partyId       String        @map("party_id")
  ownershipType OwnershipType @map("ownership_type")

  // Ownership percentage (for shared ownership)
  percentage Float @default(100)

  // Dates
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  // Primary contact for this unit
  isPrimary Boolean @default(false) @map("is_primary")

  // Mailing preferences
  mailingAddress Json? @map("mailing_address")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  unit  Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([partyId])
  @@index([endDate])
  @@map("ownerships")
}

/// @description Tenancy record for renters
model Tenancy {
  id      String @id @default(cuid())
  unitId  String @map("unit_id")
  partyId String @map("party_id")

  // Lease dates
  leaseStart DateTime  @map("lease_start")
  leaseEnd   DateTime? @map("lease_end")

  // Contact preferences
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  unit  Unit  @relation(fields: [unitId], references: [id], onDelete: Cascade)
  party Party @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([partyId])
  @@index([leaseEnd])
  @@map("tenancies")
}

/// @description Unified document model spanning all pillars (CAM, Contractor, Concierge)
model Document {
  id             String @id @default(cuid())
  organizationId String @map("organization_id") // Required for RLS

  title       String
  description String?
  category    DocumentCategory
  visibility  DocumentVisibility @default(PUBLIC)
  status      DocumentStatus     @default(ACTIVE)

  // File storage
  storageProvider StorageProvider @default(LOCAL) @map("storage_provider")
  storagePath     String          @map("storage_path") // Path/key in storage
  fileUrl         String          @map("file_url")
  fileName        String          @map("file_name")
  fileSize        Int             @map("file_size") // bytes
  mimeType        String          @map("mime_type")
  checksum        String? // MD5/SHA256 hash for integrity

  // Extracted metadata
  pageCount     Int?    @map("page_count")
  thumbnailUrl  String? @map("thumbnail_url")
  extractedText String? @map("extracted_text") @db.Text
  metadata      Json? // Additional extracted metadata

  // Versioning
  version          Int     @default(1)
  parentDocumentId String? @map("parent_document_id")
  supersededById   String? @map("superseded_by_id")

  // Effective dates (for governing docs, permits, etc.)
  effectiveDate  DateTime? @map("effective_date")
  expirationDate DateTime? @map("expiration_date")

  // Upload metadata
  uploadedBy String   @map("uploaded_by") // User ID
  tags       String[] @default([])

  // Archive info
  archivedAt    DateTime? @map("archived_at")
  archivedBy    String?   @map("archived_by")
  archiveReason String?   @map("archive_reason")

  // Processing status (malware scan, content moderation)
  malwareScanStatus        String?   @map("malware_scan_status") // PENDING, CLEAN, INFECTED, ERROR
  contentModerationStatus  String?   @map("content_moderation_status") // PENDING, APPROVED, FLAGGED
  processingCompletedAt    DateTime? @map("processing_completed_at")

  // Media-specific fields (for photos, videos, voice notes)
  latitude      Decimal?  @db.Decimal(10, 7)
  longitude     Decimal?  @db.Decimal(10, 7)
  capturedAt    DateTime? @map("captured_at")
  transcription String?   @db.Text
  isTranscribed Boolean   @default(false) @map("is_transcribed")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization   Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentDocument Document?               @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  childVersions  Document[]              @relation("DocumentVersions")
  supersededBy   Document?               @relation("SupersededDocuments", fields: [supersededById], references: [id])
  supersedes     Document[]              @relation("SupersededDocuments")
  contextBindings DocumentContextBinding[]
  accessGrants   DocumentAccessGrant[]
  downloadLogs   DocumentDownloadLog[]

  @@index([organizationId])
  @@index([category])
  @@index([visibility])
  @@index([status])
  @@index([malwareScanStatus])
  @@map("documents")
}

/// @description Binds a document to one or more contexts (association, property, job, case, etc.)
model DocumentContextBinding {
  id         String @id @default(cuid())
  documentId String @map("document_id")

  contextType DocumentContextType @map("context_type")
  contextId   String              @map("context_id") // ID of the related entity

  isPrimary    Boolean @default(false) @map("is_primary") // Marks primary context
  bindingNotes String? @map("binding_notes")

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by") // User ID

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, contextType, contextId])
  @@index([contextType, contextId])
  @@index([documentId])
  @@map("document_context_bindings")
}

/// @description Explicit access grant for private documents
model DocumentAccessGrant {
  id         String @id @default(cuid())
  documentId String @map("document_id")
  partyId    String @map("party_id")

  grantedBy String    @map("granted_by") // User ID
  grantedAt DateTime  @default(now()) @map("granted_at")
  expiresAt DateTime? @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  party    Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)

  @@unique([documentId, partyId])
  @@index([partyId])
  @@map("document_access_grants")
}

/// @description Log of document downloads for auditing
model DocumentDownloadLog {
  id         String  @id @default(cuid())
  documentId String  @map("document_id")
  partyId    String? @map("party_id")
  userId     String  @map("user_id")

  downloadedAt DateTime @default(now()) @map("downloaded_at")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")

  // Relations
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  party    Party?   @relation(fields: [partyId], references: [id])

  @@index([documentId])
  @@index([partyId])
  @@index([downloadedAt])
  @@map("document_download_logs")
}

// =============================================================================
// DOMAIN 11 - Reserve Studies
// =============================================================================

/// @description Reserve component tracked for an association
model ReserveComponent {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  name        String
  description String?
  category    ReserveComponentCategory
  location    String? // Where in the property

  // Lifecycle
  usefulLife          Int       @map("useful_life") // Years
  remainingLife       Int       @map("remaining_life") // Years
  placedInServiceDate DateTime? @map("placed_in_service_date")

  // Costs
  currentReplacementCost Decimal  @map("current_replacement_cost") @db.Decimal(12, 2)
  futureReplacementCost  Decimal? @map("future_replacement_cost") @db.Decimal(12, 2)
  inflationRate          Decimal  @default(3.0) @map("inflation_rate") @db.Decimal(5, 2)

  // Quantity
  quantity      Int     @default(1)
  unitOfMeasure String? @map("unit_of_measure")

  // Condition
  conditionRating    Int?      @map("condition_rating") // 1-10 scale
  lastInspectionDate DateTime? @map("last_inspection_date")
  notes              String?   @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association    Association             @relation(fields: [associationId], references: [id], onDelete: Cascade)
  studySnapshots ReserveStudyComponent[]

  @@index([associationId])
  @@index([category])
  @@map("reserve_components")
}

/// @description Reserve study for an association
model ReserveStudy {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  studyType      ReserveStudyType @map("study_type")
  studyDate      DateTime         @map("study_date")
  effectiveDate  DateTime         @map("effective_date")
  expirationDate DateTime?        @map("expiration_date")

  // Preparer info
  preparerName        String  @map("preparer_name")
  preparerCompany     String? @map("preparer_company")
  preparerCredentials String? @map("preparer_credentials")

  // Financial snapshot at study time
  reserveBalance     Decimal @map("reserve_balance") @db.Decimal(12, 2)
  percentFunded      Decimal @map("percent_funded") @db.Decimal(5, 2)
  fullyFundedBalance Decimal @map("fully_funded_balance") @db.Decimal(12, 2)

  // Recommendations
  recommendedContribution Decimal         @map("recommended_contribution") @db.Decimal(12, 2)
  fundingPlanType         FundingPlanType @map("funding_plan_type")

  // Document reference
  documentId String? @map("document_id")

  notes String? @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association     Association              @relation(fields: [associationId], references: [id], onDelete: Cascade)
  components      ReserveStudyComponent[]
  fundingSchedule ReserveFundingSchedule[]

  @@index([associationId])
  @@index([studyDate])
  @@map("reserve_studies")
}

/// @description Snapshot of a component at the time of a study
model ReserveStudyComponent {
  id          String @id @default(cuid())
  studyId     String @map("study_id")
  componentId String @map("component_id")

  // Snapshot values at study time
  usefulLife      Int     @map("useful_life")
  remainingLife   Int     @map("remaining_life")
  currentCost     Decimal @map("current_cost") @db.Decimal(12, 2)
  futureCost      Decimal @map("future_cost") @db.Decimal(12, 2)
  conditionRating Int?    @map("condition_rating")

  // Funding allocation
  fundedAmount  Decimal @map("funded_amount") @db.Decimal(12, 2)
  percentFunded Decimal @map("percent_funded") @db.Decimal(5, 2)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  study     ReserveStudy     @relation(fields: [studyId], references: [id], onDelete: Cascade)
  component ReserveComponent @relation(fields: [componentId], references: [id])

  @@unique([studyId, componentId])
  @@index([componentId])
  @@map("reserve_study_components")
}

/// @description Projected funding schedule from a reserve study
model ReserveFundingSchedule {
  id      String @id @default(cuid())
  studyId String @map("study_id")

  fiscalYear              Int     @map("fiscal_year")
  projectedBalance        Decimal @map("projected_balance") @db.Decimal(12, 2)
  recommendedContribution Decimal @map("recommended_contribution") @db.Decimal(12, 2)
  projectedExpenditures   Decimal @map("projected_expenditures") @db.Decimal(12, 2)
  percentFunded           Decimal @map("percent_funded") @db.Decimal(5, 2)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  study ReserveStudy @relation(fields: [studyId], references: [id], onDelete: Cascade)

  @@unique([studyId, fiscalYear])
  @@index([studyId])
  @@map("reserve_funding_schedules")
}

// =============================================================================
// DOMAIN 12 - Compliance
// =============================================================================

/// @description Compliance requirement template (jurisdiction-based)
model ComplianceRequirement {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  name         String
  description  String?                   @db.Text
  type         ComplianceRequirementType
  jurisdiction String? // State/county/city code

  // Timing
  recurrence          RecurrencePattern @default(ANNUAL)
  defaultDueDayOfYear Int?              @map("default_due_day_of_year") // 1-365
  defaultLeadDays     Int               @default(30) @map("default_lead_days")

  // Requirements
  requiresEvidence   Boolean  @default(false) @map("requires_evidence")
  evidenceTypes      String[] @default([]) @map("evidence_types")
  statutoryReference String?  @map("statutory_reference")
  penaltyDescription String?  @map("penalty_description") @db.Text

  // Template checklist items
  checklistTemplate Json? @map("checklist_template")

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deadlines    ComplianceDeadline[]

  @@index([organizationId])
  @@index([type])
  @@index([jurisdiction])
  @@map("compliance_requirements")
}

/// @description Compliance deadline instance for an association
model ComplianceDeadline {
  id            String @id @default(cuid())
  associationId String @map("association_id")
  requirementId String @map("requirement_id")

  // Deadline info
  title        String
  description  String?   @db.Text
  dueDate      DateTime  @map("due_date")
  reminderDate DateTime? @map("reminder_date")

  // Status
  status      ComplianceStatus @default(NOT_STARTED)
  completedAt DateTime?        @map("completed_at")
  completedBy String?          @map("completed_by")

  // Evidence
  evidenceDocumentIds String[] @default([]) @map("evidence_document_ids")
  notes               String?  @db.Text

  // Recurrence tracking
  fiscalYear      Int? @map("fiscal_year")
  recurrenceIndex Int? @map("recurrence_index")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association    Association               @relation(fields: [associationId], references: [id], onDelete: Cascade)
  requirement    ComplianceRequirement     @relation(fields: [requirementId], references: [id])
  checklistItems ComplianceChecklistItem[]

  @@index([associationId])
  @@index([requirementId])
  @@index([dueDate])
  @@index([status])
  @@map("compliance_deadlines")
}

/// @description Checklist item for a compliance deadline
model ComplianceChecklistItem {
  id         String @id @default(cuid())
  deadlineId String @map("deadline_id")

  title       String
  description String?
  sortOrder   Int     @default(0) @map("sort_order")

  // Status
  isCompleted Boolean   @default(false) @map("is_completed")
  completedAt DateTime? @map("completed_at")
  completedBy String?   @map("completed_by")

  // Evidence
  evidenceDocumentId String? @map("evidence_document_id")
  notes              String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  deadline ComplianceDeadline @relation(fields: [deadlineId], references: [id], onDelete: Cascade)

  @@index([deadlineId])
  @@map("compliance_checklist_items")
}

// =============================================================================
// DOMAIN 1 - Management Relationships
// =============================================================================

/// @description Contract between management company and association
model ManagementContract {
  id                  String @id @default(cuid())
  associationId       String @map("association_id")
  managementCompanyId String @map("management_company_id")

  // Contract details
  contractNumber String?   @map("contract_number")
  startDate      DateTime  @map("start_date")
  endDate        DateTime? @map("end_date")
  autoRenew      Boolean   @default(false) @map("auto_renew")

  // Terms
  monthlyFee Decimal? @map("monthly_fee") @db.Decimal(10, 2)
  terms      Json?

  // Service levels
  serviceLevels Json? @map("service_levels") // { tier: "premium", sla: {...} }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association       Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  managementCompany Organization @relation(fields: [managementCompanyId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([managementCompanyId])
  @@map("management_contracts")
}

// =============================================================================
// DOMAIN 1 - Manager Assignments
// =============================================================================

enum ManagerAssignmentType {
  COMMUNITY_MANAGER
  PORTFOLIO_MANAGER
  ASSISTANT_MANAGER
}

/// @description Manager assignment to associations
model ManagerAssignment {
  id             String                @id @default(cuid())
  userId         String                @map("user_id")
  associationId  String                @map("association_id")
  assignmentType ManagerAssignmentType @map("assignment_type")

  // Assignment details
  isPrimary Boolean   @default(false) @map("is_primary")
  startDate DateTime  @map("start_date")
  endDate   DateTime? @map("end_date")

  // Workload tracking
  maxUnits Int?    @map("max_units") // Max units this manager can handle
  notes    String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@unique([userId, associationId, assignmentType])
  @@index([userId])
  @@index([associationId])
  @@index([endDate])
  @@map("manager_assignments")
}

// =============================================================================
// DOMAIN 3 - ACCOUNTING ENUMS
// =============================================================================

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum AccountCategory {
  // Asset categories
  CASH
  ACCOUNTS_RECEIVABLE
  PREPAID
  FIXED_ASSET
  OTHER_ASSET

  // Liability categories
  ACCOUNTS_PAYABLE
  ACCRUED_LIABILITY
  DEFERRED_REVENUE
  LONG_TERM_LIABILITY
  OTHER_LIABILITY

  // Equity categories
  RETAINED_EARNINGS
  FUND_BALANCE
  RESERVE_FUND

  // Revenue categories
  ASSESSMENT_INCOME
  LATE_FEE_INCOME
  INTEREST_INCOME
  OTHER_INCOME

  // Expense categories
  ADMINISTRATIVE
  UTILITIES
  MAINTENANCE
  INSURANCE
  PROFESSIONAL_FEES
  RESERVE_CONTRIBUTION
  OTHER_EXPENSE
}

enum FundType {
  OPERATING
  RESERVE
  SPECIAL
}

enum JournalEntryStatus {
  DRAFT
  PENDING_APPROVAL
  POSTED
  REVERSED
}

enum AssessmentFrequency {
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
  ONE_TIME
}

enum ChargeStatus {
  PENDING
  BILLED
  PARTIALLY_PAID
  PAID
  WRITTEN_OFF
  CREDITED
}

enum PaymentMethod {
  CHECK
  ACH
  CREDIT_CARD
  CASH
  WIRE
  OTHER
}

enum PaymentStatus {
  PENDING
  CLEARED
  BOUNCED
  REFUNDED
  VOIDED
}

enum InvoiceStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PARTIALLY_PAID
  PAID
  VOIDED
}

// =============================================================================
// DOMAIN 3 - CHART OF ACCOUNTS
// =============================================================================

/// @description General Ledger Account
model GLAccount {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  // Account identification
  accountNumber String  @map("account_number")
  name          String
  description   String?

  // Classification
  accountType AccountType     @map("account_type")
  category    AccountCategory
  fundType    FundType        @default(OPERATING) @map("fund_type")

  // Hierarchy
  parentId String? @map("parent_id")

  // Status
  isActive        Boolean @default(true) @map("is_active")
  isSystemAccount Boolean @default(false) @map("is_system_account") // Cannot be deleted

  // Normal balance (true = debit, false = credit)
  normalDebit Boolean @default(true) @map("normal_debit")

  // Current balance (denormalized for performance)
  currentBalance Decimal @default(0) @map("current_balance") @db.Decimal(15, 2)

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association     Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  parent          GLAccount?         @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        GLAccount[]        @relation("AccountHierarchy")
  journalLines    JournalEntryLine[]
  bankAccounts    BankAccount[]
  assessmentTypes AssessmentType[]   @relation("AssessmentRevenueAccount")
  lateFeeAccount  AssessmentType[]   @relation("LateFeeAccount")

  @@unique([associationId, accountNumber])
  @@index([associationId])
  @@index([parentId])
  @@index([accountType])
  @@map("gl_accounts")
}

// =============================================================================
// DOMAIN 3 - JOURNAL ENTRIES
// =============================================================================

/// @description Journal Entry header
model JournalEntry {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  // Entry identification
  entryNumber String   @map("entry_number")
  entryDate   DateTime @map("entry_date") @db.Date

  // Description
  description String
  memo        String?

  // Status
  status JournalEntryStatus @default(DRAFT)

  // Source reference (for auto-generated entries)
  sourceType String? @map("source_type") // "ASSESSMENT", "PAYMENT", "INVOICE", etc.
  sourceId   String? @map("source_id")

  // Reversal tracking
  isReversal      Boolean @default(false) @map("is_reversal")
  reversedEntryId String? @unique @map("reversed_entry_id")

  // Approval
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")

  // Audit
  createdBy String    @map("created_by")
  postedAt  DateTime? @map("posted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association   Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  lines         JournalEntryLine[]
  reversedEntry JournalEntry?      @relation("ReversalPair", fields: [reversedEntryId], references: [id])
  reversalEntry JournalEntry?      @relation("ReversalPair")

  @@unique([associationId, entryNumber])
  @@index([associationId])
  @@index([entryDate])
  @@index([status])
  @@index([sourceType, sourceId])
  @@map("journal_entries")
}

/// @description Journal Entry line (debit or credit)
model JournalEntryLine {
  id             String @id @default(cuid())
  journalEntryId String @map("journal_entry_id")
  accountId      String @map("account_id")

  // Amount (positive for debit, negative for credit)
  debitAmount  Decimal? @map("debit_amount") @db.Decimal(15, 2)
  creditAmount Decimal? @map("credit_amount") @db.Decimal(15, 2)

  // Line description
  description String?

  // Reference (unit, vendor, etc.)
  referenceType String? @map("reference_type")
  referenceId   String? @map("reference_id")

  // Line order
  lineNumber Int @map("line_number")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  journalEntry JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  account      GLAccount    @relation(fields: [accountId], references: [id])

  @@index([journalEntryId])
  @@index([accountId])
  @@index([referenceType, referenceId])
  @@map("journal_entry_lines")
}

// =============================================================================
// DOMAIN 3 - BANK ACCOUNTS
// =============================================================================

/// @description Bank Account linked to GL
model BankAccount {
  id            String @id @default(cuid())
  associationId String @map("association_id")
  glAccountId   String @map("gl_account_id")

  // Bank details
  bankName      String  @map("bank_name")
  accountName   String  @map("account_name")
  accountNumber String  @map("account_number") // Last 4 digits only for display
  routingNumber String? @map("routing_number") // Encrypted or last 4
  accountType   String  @map("account_type") // "CHECKING", "SAVINGS", "MONEY_MARKET"

  // Fund designation
  fundType FundType @default(OPERATING) @map("fund_type")

  // Balances
  bookBalance    Decimal   @default(0) @map("book_balance") @db.Decimal(15, 2)
  bankBalance    Decimal   @default(0) @map("bank_balance") @db.Decimal(15, 2)
  lastReconciled DateTime? @map("last_reconciled")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  glAccount   GLAccount   @relation(fields: [glAccountId], references: [id])
  payments    Payment[]

  @@index([associationId])
  @@index([glAccountId])
  @@map("bank_accounts")
}

// =============================================================================
// DOMAIN 3 - ASSESSMENTS
// =============================================================================

/// @description Assessment type configuration
model AssessmentType {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  // Type details
  name        String
  description String?
  code        String // Short code like "REG", "SPEC", "LATE"

  // Frequency
  frequency AssessmentFrequency

  // Default amount (can be overridden per unit)
  defaultAmount Decimal @map("default_amount") @db.Decimal(10, 2)

  // GL mapping
  revenueAccountId String  @map("revenue_account_id")
  lateFeeAccountId String? @map("late_fee_account_id")

  // Late fee configuration
  lateFeeAmount   Decimal? @map("late_fee_amount") @db.Decimal(10, 2)
  lateFeePercent  Decimal? @map("late_fee_percent") @db.Decimal(5, 2)
  gracePeriodDays Int      @default(15) @map("grace_period_days")

  // Pro-ration
  prorateOnTransfer Boolean @default(true) @map("prorate_on_transfer")

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association    Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  revenueAccount GLAccount          @relation("AssessmentRevenueAccount", fields: [revenueAccountId], references: [id])
  lateFeeAccount GLAccount?         @relation("LateFeeAccount", fields: [lateFeeAccountId], references: [id])
  charges        AssessmentCharge[]

  @@unique([associationId, code])
  @@index([associationId])
  @@map("assessment_types")
}

/// @description Assessment charge against a unit
model AssessmentCharge {
  id               String @id @default(cuid())
  associationId    String @map("association_id")
  unitId           String @map("unit_id")
  assessmentTypeId String @map("assessment_type_id")

  // Charge details
  chargeDate  DateTime  @map("charge_date") @db.Date
  dueDate     DateTime  @map("due_date") @db.Date
  periodStart DateTime? @map("period_start") @db.Date
  periodEnd   DateTime? @map("period_end") @db.Date

  // Amounts
  amount        Decimal @db.Decimal(10, 2)
  lateFeeAmount Decimal @default(0) @map("late_fee_amount") @db.Decimal(10, 2)
  totalAmount   Decimal @map("total_amount") @db.Decimal(10, 2) // amount + lateFeeAmount
  paidAmount    Decimal @default(0) @map("paid_amount") @db.Decimal(10, 2)
  balanceDue    Decimal @map("balance_due") @db.Decimal(10, 2) // totalAmount - paidAmount

  // Status
  status ChargeStatus @default(PENDING)

  // Late fee tracking
  lateFeeApplied Boolean   @default(false) @map("late_fee_applied")
  lateFeeDate    DateTime? @map("late_fee_date")

  // GL posting
  journalEntryId String? @map("journal_entry_id")

  // Notes
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association         Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit                Unit                 @relation(fields: [unitId], references: [id])
  assessmentType      AssessmentType       @relation(fields: [assessmentTypeId], references: [id])
  paymentApplications PaymentApplication[]

  @@index([associationId])
  @@index([unitId])
  @@index([assessmentTypeId])
  @@index([dueDate])
  @@index([status])
  @@map("assessment_charges")
}

// =============================================================================
// DOMAIN 3 - PAYMENTS (AR)
// =============================================================================

/// @description Payment received from owner/tenant
model Payment {
  id            String @id @default(cuid())
  associationId String @map("association_id")
  unitId        String @map("unit_id")

  // Payment details
  paymentDate DateTime @map("payment_date") @db.Date
  amount      Decimal  @db.Decimal(10, 2)

  // Method
  paymentMethod   PaymentMethod @map("payment_method")
  referenceNumber String?       @map("reference_number") // Check number, transaction ID

  // Bank account (where deposited)
  bankAccountId String? @map("bank_account_id")

  // Payer info
  payerName    String? @map("payer_name")
  payerPartyId String? @map("payer_party_id")

  // Status
  status PaymentStatus @default(PENDING)

  // Application tracking
  appliedAmount   Decimal @default(0) @map("applied_amount") @db.Decimal(10, 2)
  unappliedAmount Decimal @map("unapplied_amount") @db.Decimal(10, 2) // amount - appliedAmount

  // GL posting
  journalEntryId String? @map("journal_entry_id")

  // Notes
  memo String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association  Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit         Unit                 @relation(fields: [unitId], references: [id])
  bankAccount  BankAccount?         @relation(fields: [bankAccountId], references: [id])
  payerParty   Party?               @relation(fields: [payerPartyId], references: [id])
  applications PaymentApplication[]

  @@index([associationId])
  @@index([unitId])
  @@index([paymentDate])
  @@index([status])
  @@map("payments")
}

/// @description Payment application to charges
model PaymentApplication {
  id        String @id @default(cuid())
  paymentId String @map("payment_id")
  chargeId  String @map("charge_id")

  // Amount applied
  amount Decimal @db.Decimal(10, 2)

  // Application date
  appliedAt DateTime @default(now()) @map("applied_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  payment Payment          @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  charge  AssessmentCharge @relation(fields: [chargeId], references: [id])

  @@index([paymentId])
  @@index([chargeId])
  @@map("payment_applications")
}

// =============================================================================
// DOMAIN 3 - ACCOUNTS PAYABLE
// =============================================================================

/// @description Vendor (service provider for AP)
model Vendor {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  // Vendor details
  name String
  dba  String? // Doing business as

  // Contact
  contactName String? @map("contact_name")
  email       String? @db.Citext
  phone       String?

  // Address
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")

  // Tax info
  taxId          String? @map("tax_id") // EIN or SSN (encrypted)
  w9OnFile       Boolean @default(false) @map("w9_on_file")
  is1099Eligible Boolean @default(false) @map("is_1099_eligible")

  // Payment info
  paymentTerms       Int     @default(30) @map("payment_terms") // Net days
  defaultGLAccountId String? @map("default_gl_account_id")

  // Link to service provider organization (if on platform)
  serviceProviderOrgId String? @map("service_provider_org_id")

  // Phase 2: Compliance fields
  approvalStatus     VendorApprovalStatus @default(PENDING) @map("approval_status")
  approvedAt         DateTime?            @map("approved_at")
  approvedBy         String?              @map("approved_by")
  insuranceVerified  Boolean              @default(false) @map("insurance_verified")
  insuranceExpiresAt DateTime?            @map("insurance_expires_at")
  licenseVerified    Boolean              @default(false) @map("license_verified")
  licenseExpiresAt   DateTime?            @map("license_expires_at")
  complianceNotes    String?              @map("compliance_notes") @db.Text

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  invoices    APInvoice[]

  // Phase 4: Work Orders
  workOrders WorkOrder[]
  bids       WorkOrderBid[]

  // Phase 14: Service Provider Links
  serviceProviderLinks ServiceProviderLink[]

  // Phase 2: Inventory & Procurement
  suppliers Supplier[]

  @@index([associationId])
  @@index([email])
  @@index([approvalStatus])
  @@map("vendors")
}

/// @description Accounts Payable Invoice
model APInvoice {
  id            String @id @default(cuid())
  associationId String @map("association_id")
  vendorId      String @map("vendor_id")

  // Invoice details
  invoiceNumber String   @map("invoice_number")
  invoiceDate   DateTime @map("invoice_date") @db.Date
  dueDate       DateTime @map("due_date") @db.Date

  // Amounts
  subtotal    Decimal @db.Decimal(10, 2)
  taxAmount   Decimal @default(0) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount Decimal @map("total_amount") @db.Decimal(10, 2)
  paidAmount  Decimal @default(0) @map("paid_amount") @db.Decimal(10, 2)
  balanceDue  Decimal @map("balance_due") @db.Decimal(10, 2)

  // Status
  status InvoiceStatus @default(DRAFT)

  // Approval workflow
  approvedBy String?   @map("approved_by")
  approvedAt DateTime? @map("approved_at")

  // GL posting
  journalEntryId String? @map("journal_entry_id")

  // Reference
  description String?
  memo        String?

  // Work order link (if applicable)
  workOrderId String? @map("work_order_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association     @relation(fields: [associationId], references: [id], onDelete: Cascade)
  vendor      Vendor          @relation(fields: [vendorId], references: [id])
  lineItems   APInvoiceLine[]

  @@unique([associationId, vendorId, invoiceNumber])
  @@index([associationId])
  @@index([vendorId])
  @@index([dueDate])
  @@index([status])
  @@map("ap_invoices")
}

/// @description AP Invoice line item
model APInvoiceLine {
  id        String @id @default(cuid())
  invoiceId String @map("invoice_id")

  // Line details
  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  // GL account
  glAccountId String @map("gl_account_id")

  // Line order
  lineNumber Int @map("line_number")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  invoice APInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("ap_invoice_lines")
}

// =============================================================================
// PHASE 4: WORK ORDERS & ASSET MANAGEMENT
// =============================================================================

/// @description Physical asset (equipment, systems, common area items)
model Asset {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  // Asset identification
  assetNumber String  @map("asset_number")
  name        String
  description String?

  // Classification
  category AssetCategory
  status   AssetStatus   @default(ACTIVE)

  // Location - either unit or common area
  unitId          String? @map("unit_id")
  commonAreaName  String? @map("common_area_name") // e.g., "Pool House", "Clubhouse"
  locationDetails String? @map("location_details") // Specific location within

  // Asset details
  manufacturer String?
  model        String?
  serialNumber String? @map("serial_number")

  // Dates
  purchaseDate DateTime? @map("purchase_date") @db.Date
  installDate  DateTime? @map("install_date") @db.Date

  // Warranty
  warrantyExpires DateTime? @map("warranty_expires") @db.Date
  warrantyDetails String?   @map("warranty_details")

  // Financial
  purchaseCost Decimal? @map("purchase_cost") @db.Decimal(10, 2)
  currentValue Decimal? @map("current_value") @db.Decimal(10, 2)

  // Maintenance schedule
  maintenanceFrequencyDays Int?      @map("maintenance_frequency_days")
  lastMaintenanceDate      DateTime? @map("last_maintenance_date") @db.Date
  nextMaintenanceDate      DateTime? @map("next_maintenance_date") @db.Date

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  association        Association           @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit               Unit?                 @relation(fields: [unitId], references: [id])
  workOrders         WorkOrder[]
  maintenanceHistory AssetMaintenanceLog[]

  @@unique([associationId, assetNumber])
  @@index([associationId])
  @@index([unitId])
  @@index([category])
  @@index([status])
  @@map("assets")
}

/// @description Asset maintenance history log
model AssetMaintenanceLog {
  id      String @id @default(cuid())
  assetId String @map("asset_id")

  // Maintenance details
  maintenanceDate DateTime @map("maintenance_date") @db.Date
  maintenanceType String   @map("maintenance_type") // Routine, Repair, Inspection, etc.
  description     String
  performedBy     String?  @map("performed_by") // Vendor name or internal

  // Cost
  cost Decimal? @db.Decimal(10, 2)

  // Work order reference
  workOrderId String? @map("work_order_id")

  // Notes
  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")

  // Relations
  asset     Asset      @relation(fields: [assetId], references: [id], onDelete: Cascade)
  workOrder WorkOrder? @relation(fields: [workOrderId], references: [id])

  @@index([assetId])
  @@index([maintenanceDate])
  @@map("asset_maintenance_logs")
}

/// @description Service provider capabilities and service areas
model ServiceProviderProfile {
  id             String @id @default(cuid())
  organizationId String @unique @map("organization_id") // Links to SERVICE_PROVIDER org

  // Business info
  businessName String  @map("business_name")
  description  String?

  // Service categories (what they do)
  serviceCategories String[] @map("service_categories") // Array of AssetCategory values

  // Service area (where they work)
  serviceAreaRadius Int?     @map("service_area_radius") // Miles from base
  serviceZipCodes   String[] @map("service_zip_codes")

  // Compliance
  insuranceExpires DateTime? @map("insurance_expires") @db.Date
  insuranceAmount  Decimal?  @map("insurance_amount") @db.Decimal(12, 2)
  licenseNumber    String?   @map("license_number")
  licenseExpires   DateTime? @map("license_expires") @db.Date
  bondedAmount     Decimal?  @map("bonded_amount") @db.Decimal(12, 2)

  // Ratings
  averageRating Decimal? @map("average_rating") @db.Decimal(2, 1)
  totalReviews  Int      @default(0) @map("total_reviews")

  // Status
  isVerified Boolean @default(false) @map("is_verified")
  isActive   Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  associationRelationships AssociationServiceProvider[]

  @@index([serviceCategories])
  @@map("service_provider_profiles")
}

/// @description Association-to-Service Provider relationship
model AssociationServiceProvider {
  id                String @id @default(cuid())
  associationId     String @map("association_id")
  serviceProviderId String @map("service_provider_id")

  // Relationship status
  isPreferred Boolean @default(false) @map("is_preferred")
  isApproved  Boolean @default(true) @map("is_approved")
  isBlocked   Boolean @default(false) @map("is_blocked")

  // Contract info
  contractStartDate DateTime? @map("contract_start_date") @db.Date
  contractEndDate   DateTime? @map("contract_end_date") @db.Date

  // Notes
  notes String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association     Association            @relation(fields: [associationId], references: [id], onDelete: Cascade)
  serviceProvider ServiceProviderProfile @relation(fields: [serviceProviderId], references: [id])

  @@unique([associationId, serviceProviderId])
  @@index([associationId])
  @@index([serviceProviderId])
  @@map("association_service_providers")
}

/// @description Work order for maintenance, repairs, and services
model WorkOrder {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  // Work order identification
  workOrderNumber String @map("work_order_number")

  // Classification
  category WorkOrderCategory
  priority WorkOrderPriority @default(MEDIUM)
  status   WorkOrderStatus   @default(DRAFT)

  // Request details
  title       String
  description String

  // Location - unit, common area, or asset
  unitId          String? @map("unit_id")
  commonAreaName  String? @map("common_area_name")
  assetId         String? @map("asset_id")
  locationDetails String? @map("location_details")

  // Requestor
  requestedBy String   @map("requested_by") // User ID
  requestedAt DateTime @default(now()) @map("requested_at")

  // Assignment
  assignedVendorId           String?   @map("assigned_vendor_id")
  assignedAt                 DateTime? @map("assigned_at")
  assignedBy                 String?   @map("assigned_by")
  assignedTechnicianId       String?   @map("assigned_technician_id")
  assignedTechnicianBranchId String?   @map("assigned_technician_branch_id")
  pricebookVersionId         String?   @map("pricebook_version_id")
  jobTemplateId              String?   @map("job_template_id")

  // Scheduling
  scheduledStart DateTime? @map("scheduled_start")
  scheduledEnd   DateTime? @map("scheduled_end")

  // Execution
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Closure
  closedAt DateTime? @map("closed_at")
  closedBy String?   @map("closed_by")

  // Estimated vs actual
  estimatedCost  Decimal? @map("estimated_cost") @db.Decimal(10, 2)
  actualCost     Decimal? @map("actual_cost") @db.Decimal(10, 2)
  estimatedHours Decimal? @map("estimated_hours") @db.Decimal(5, 2)
  actualHours    Decimal? @map("actual_hours") @db.Decimal(5, 2)

  // Resolution
  resolutionNotes String? @map("resolution_notes")

  // AP Integration
  invoiceId String? @map("invoice_id")

  // SLA tracking
  slaDeadline DateTime? @map("sla_deadline")
  slaMet      Boolean?  @map("sla_met")

  // Phase 9: Origin tracking (CAM Oversight)
  originType   WorkOrderOriginType? @map("origin_type")
  violationId  String?              @map("violation_id")
  arcRequestId String?              @map("arc_request_id")
  resolutionId String?              @map("resolution_id") // For board directives
  originNotes  String?              @map("origin_notes") @db.Text

  // Phase 9: Authorization fields (CAM Oversight)
  authorizedBy           String?   @map("authorized_by")
  authorizedAt           DateTime? @map("authorized_at")
  authorizationRationale String?   @map("authorization_rationale") @db.Text
  authorizingRole        String?   @map("authorizing_role") // 'MANAGER' | 'BOARD'

  // Phase 9: Budget tracking (CAM Oversight)
  budgetSource   FundType? @map("budget_source") // OPERATING | RESERVE | SPECIAL
  approvedAmount Decimal?  @map("approved_amount") @db.Decimal(12, 2)
  spendToDate    Decimal?  @map("spend_to_date") @db.Decimal(12, 2)

  // Phase 9: Constraints and Board Approval (CAM Oversight)
  constraints           String?             @map("constraints") @db.Text // HOA rules, conditions
  requiresBoardApproval Boolean             @default(false) @map("requires_board_approval")
  boardApprovalVoteId   String?             @map("board_approval_vote_id")
  boardApprovalStatus   BoardApprovalStatus? @map("board_approval_status")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association        Association              @relation(fields: [associationId], references: [id], onDelete: Cascade)
  unit               Unit?                    @relation(fields: [unitId], references: [id])
  asset              Asset?                   @relation(fields: [assetId], references: [id])
  assignedVendor     Vendor?                  @relation(fields: [assignedVendorId], references: [id])
  assignedTechnician Technician?              @relation(fields: [assignedTechnicianId], references: [id])
  pricebookVersion   PricebookVersion?        @relation(fields: [pricebookVersionId], references: [id], onDelete: SetNull)
  jobTemplate        JobTemplate?             @relation(fields: [jobTemplateId], references: [id], onDelete: SetNull)
  statusHistory      WorkOrderStatusHistory[]
  comments           WorkOrderComment[]
  attachments        WorkOrderAttachment[]
  bids               WorkOrderBid[]
  maintenanceLogs    AssetMaintenanceLog[]
  lineItems          WorkOrderLineItem[]

  // Phase 9: Origin relations (CAM Oversight)
  violation  Violation?  @relation(fields: [violationId], references: [id])
  arcRequest ARCRequest? @relation(fields: [arcRequestId], references: [id])
  resolution Resolution? @relation(fields: [resolutionId], references: [id])
  boardVote  Vote?       @relation(fields: [boardApprovalVoteId], references: [id])

  // Phase 9: Owner Portal / CRM
  ownerRequests OwnerRequest[]

  // Phase 2: Job Lifecycle
  jobs Job[]

  @@unique([associationId, workOrderNumber])
  @@index([associationId])
  @@index([unitId])
  @@index([assetId])
  @@index([assignedVendorId])
  @@index([pricebookVersionId])
  @@index([jobTemplateId])
  @@index([status])
  @@index([priority])
  @@index([requestedAt])
  // Phase 9: Indexes for origin tracking
  @@index([originType])
  @@index([violationId])
  @@index([arcRequestId])
  @@index([resolutionId])
  @@index([boardApprovalVoteId])
  @@index([requiresBoardApproval])
  @@map("work_orders")
}

/// @description Bid submitted by a vendor for a work order
model WorkOrderBid {
  id                String    @id @default(cuid())
  workOrderId       String    @map("work_order_id")
  vendorId          String    @map("vendor_id")
  status            BidStatus @default(REQUESTED)
  laborCost         Decimal?  @map("labor_cost") @db.Decimal(10, 2)
  materialsCost     Decimal?  @map("materials_cost") @db.Decimal(10, 2)
  totalAmount       Decimal?  @map("total_amount") @db.Decimal(10, 2)
  estimatedHours    Decimal?  @map("estimated_hours") @db.Decimal(5, 2)
  proposedStartDate DateTime? @map("proposed_start_date")
  proposedEndDate   DateTime? @map("proposed_end_date")
  validUntil        DateTime? @map("valid_until")
  notes             String?
  requestedAt       DateTime  @default(now()) @map("requested_at")
  submittedAt       DateTime? @map("submitted_at")
  respondedAt       DateTime? @map("responded_at")
  respondedBy       String?   @map("responded_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  vendor    Vendor    @relation(fields: [vendorId], references: [id], onDelete: Restrict)

  @@unique([workOrderId, vendorId])
  @@index([workOrderId])
  @@index([vendorId])
  @@index([status])
  @@map("work_order_bids")
}

/// @description Status change history for a work order
model WorkOrderStatusHistory {
  id          String           @id @default(cuid())
  workOrderId String           @map("work_order_id")
  fromStatus  WorkOrderStatus? @map("from_status")
  toStatus    WorkOrderStatus  @map("to_status")
  changedBy   String           @map("changed_by")
  changedAt   DateTime         @default(now()) @map("changed_at")
  notes       String?

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@index([changedAt])
  @@map("work_order_status_history")
}

/// @description Comment on a work order
model WorkOrderComment {
  id          String   @id @default(cuid())
  workOrderId String   @map("work_order_id")
  comment     String
  isInternal  Boolean  @default(false) @map("is_internal")
  authorId    String   @map("author_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_comments")
}

/// @description Attachment linked to a work order
model WorkOrderAttachment {
  id             String   @id @default(cuid())
  workOrderId    String   @map("work_order_id")
  fileName       String   @map("file_name")
  fileType       String   @map("file_type")
  fileSize       Int      @map("file_size")
  fileUrl        String   @map("file_url")
  description    String?
  uploadedBy     String   @map("uploaded_by")
  uploadedAt     DateTime @default(now()) @map("uploaded_at")
  attachmentType String   @map("attachment_type")

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@index([workOrderId])
  @@map("work_order_attachments")
}

/// @description Line items attached to a work order (snapshot of pricebook or custom)
model WorkOrderLineItem {
  id              String  @id @default(cuid())
  workOrderId     String  @map("work_order_id")
  pricebookItemId String? @map("pricebook_item_id")

  quantity   Decimal @default(1) @db.Decimal(10, 2)
  unitPrice  Decimal @db.Decimal(12, 2)
  total      Decimal @db.Decimal(14, 2)
  lineNumber Int     @default(1) @map("line_number")
  notes      String? @db.Text
  isCustom   Boolean @default(false) @map("is_custom")

  // Snapshotted descriptors for audit/history
  itemCode      String?
  itemName      String?
  itemType      PricebookItemType?
  unitOfMeasure String?
  trade         ContractorTradeType?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  workOrder     WorkOrder      @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  pricebookItem PricebookItem? @relation(fields: [pricebookItemId], references: [id], onDelete: SetNull)

  @@unique([workOrderId, lineNumber])
  @@index([workOrderId])
  @@index([pricebookItemId])
  @@map("work_order_line_items")
}

// =============================================================================
// PHASE 6: ARC (Architectural Requests)
// =============================================================================

/// @description Architectural change request
model ARCRequest {
  id               String  @id @default(cuid())
  associationId    String  @map("association_id")
  committeeId      String? @map("committee_id")
  unitId           String? @map("unit_id")
  requesterPartyId String  @map("requester_party_id")

  // Identification
  requestNumber String @map("request_number")

  // Details
  title             String
  description       String           @db.Text
  category          ARCCategory
  status            ARCRequestStatus @default(DRAFT)
  estimatedCost     Decimal?         @map("estimated_cost") @db.Decimal(12, 2)
  proposedStartDate DateTime?        @map("proposed_start_date")
  proposedEndDate   DateTime?        @map("proposed_end_date")
  conditions        String?          @db.Text // Conditions of approval

  // Timeline
  submittedAt        DateTime? @map("submitted_at")
  reviewedAt         DateTime? @map("reviewed_at")
  decisionDate       DateTime? @map("decision_date")
  expiresAt          DateTime? @map("expires_at")
  withdrawnAt        DateTime? @map("withdrawn_at")
  cancellationReason String?   @map("cancellation_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association    Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  committee      ARCCommittee? @relation(fields: [committeeId], references: [id])
  unit           Unit?         @relation(fields: [unitId], references: [id])
  requesterParty Party         @relation("PartyARCRequests", fields: [requesterPartyId], references: [id])
  documents      ARCDocument[]
  reviews        ARCReview[]

  // Phase 9: Work Orders created from this ARC approval
  workOrders WorkOrder[]

  @@unique([associationId, requestNumber])
  @@index([associationId])
  @@index([committeeId])
  @@index([unitId])
  @@index([requesterPartyId])
  @@index([status])
  @@map("arc_requests")
}

/// @description Documents attached to an ARC request
model ARCDocument {
  id        String @id @default(cuid())
  requestId String @map("request_id")

  documentType ARCDocumentType @map("document_type")
  fileName     String          @map("file_name")
  fileUrl      String          @map("file_url")
  fileSize     Int?            @map("file_size")
  mimeType     String?         @map("mime_type")
  description  String?
  version      String? // Optional version label

  uploadedBy String   @map("uploaded_by") // User ID
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  request ARCRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@map("arc_documents")
}

/// @description ARC committee configuration
model ARCCommittee {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  name              String
  description       String?
  approvalThreshold Decimal @map("approval_threshold") @db.Decimal(5, 2) // e.g., 50.00 for majority
  quorum            Int?
  isActive          Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association          @relation(fields: [associationId], references: [id], onDelete: Cascade)
  members     ARCCommitteeMember[]
  requests    ARCRequest[]

  @@index([associationId])
  @@map("arc_committees")
}

/// @description Members of an ARC committee
model ARCCommitteeMember {
  id          String @id @default(cuid())
  committeeId String @map("committee_id")
  partyId     String @map("party_id")

  role     String?
  isChair  Boolean   @default(false) @map("is_chair")
  joinedAt DateTime  @default(now()) @map("joined_at")
  leftAt   DateTime? @map("left_at")

  // Relations
  committee ARCCommittee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  party     Party        @relation(fields: [partyId], references: [id])

  @@unique([committeeId, partyId])
  @@index([partyId])
  @@map("arc_committee_members")
}

/// @description Reviews/decisions recorded for an ARC request
model ARCReview {
  id         String          @id @default(cuid())
  requestId  String          @map("request_id")
  reviewerId String          @map("reviewer_id") // User ID
  action     ARCReviewAction
  notes      String?         @db.Text
  conditions String?         @db.Text
  expiresAt  DateTime?       @map("expires_at") // For conditional approvals
  decidedAt  DateTime        @default(now()) @map("decided_at")
  createdAt  DateTime        @default(now()) @map("created_at")

  // Relations
  request  ARCRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  reviewer User       @relation(fields: [reviewerId], references: [id])

  @@index([requestId])
  @@index([reviewerId])
  @@map("arc_reviews")
}

// =============================================================================
// PHASE 7: Governance
// =============================================================================

/// @description Board for an association
model Board {
  id            String @id @default(cuid())
  associationId String @map("association_id")

  name        String
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association    @relation(fields: [associationId], references: [id], onDelete: Cascade)
  members     BoardMember[]
  meetings    Meeting[]
  resolutions Resolution[]
  history     BoardHistory[]

  @@index([associationId])
  @@map("boards")
}

/// @description Board membership with roles and terms
model BoardMember {
  id      String @id @default(cuid())
  boardId String @map("board_id")
  partyId String @map("party_id")

  role      BoardRole
  termStart DateTime  @map("term_start")
  termEnd   DateTime? @map("term_end")
  isActive  Boolean   @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  party Party @relation(fields: [partyId], references: [id])

  @@unique([boardId, partyId, termStart])
  @@index([partyId])
  @@map("board_members")
}

/// @description Meetings for governance (board, annual, special)
model Meeting {
  id            String  @id @default(cuid())
  associationId String  @map("association_id")
  boardId       String? @map("board_id")

  type         MeetingType
  status       MeetingStatus @default(SCHEDULED)
  title        String
  description  String?       @db.Text
  scheduledFor DateTime      @map("scheduled_for")
  location     String?

  createdBy String   @map("created_by") // User ID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association         @relation(fields: [associationId], references: [id], onDelete: Cascade)
  board       Board?              @relation(fields: [boardId], references: [id])
  agendaItems MeetingAgendaItem[]
  minutes     MeetingMinutes?
  attendance  MeetingAttendance[]
  votes       Vote[]

  @@index([associationId])
  @@index([boardId])
  @@index([scheduledFor])
  @@map("meetings")
}

/// @description Agenda items for a meeting
model MeetingAgendaItem {
  id        String @id @default(cuid())
  meetingId String @map("meeting_id")

  title       String
  description String? @db.Text
  order       Int     @default(0)

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  votes   Vote[]

  @@index([meetingId])
  @@map("meeting_agenda_items")
}

/// @description Minutes recorded for a meeting
model MeetingMinutes {
  id         String @id @default(cuid())
  meetingId  String @unique @map("meeting_id")
  recordedBy String @map("recorded_by") // User ID
  content    String @db.Text

  recordedAt DateTime @default(now()) @map("recorded_at")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  @@map("meeting_minutes")
}

/// @description Attendance records for a meeting
model MeetingAttendance {
  id              String                  @id @default(cuid())
  meetingId       String                  @map("meeting_id")
  partyId         String                  @map("party_id")
  status          MeetingAttendanceStatus @default(PRESENT)
  proxyForPartyId String?                 @map("proxy_for_party_id")
  checkedInAt     DateTime?               @map("checked_in_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  meeting Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  party   Party   @relation(fields: [partyId], references: [id])

  @@unique([meetingId, partyId])
  @@index([proxyForPartyId])
  @@map("meeting_attendance")
}

/// @description Vote session within a meeting
model Vote {
  id           String  @id @default(cuid())
  meetingId    String  @map("meeting_id")
  agendaItemId String? @map("agenda_item_id")

  question       String
  method         VoteMethod @default(IN_PERSON)
  createdBy      String     @map("created_by") // User ID
  quorumRequired Int?       @map("quorum_required")
  closedAt       DateTime?  @map("closed_at")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  meeting    Meeting            @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  agendaItem MeetingAgendaItem? @relation(fields: [agendaItemId], references: [id])
  ballots    VoteBallot[]

  // Phase 9: Work Orders requiring board approval via this vote
  workOrderApprovals WorkOrder[]

  @@index([meetingId])
  @@index([agendaItemId])
  @@map("votes")
}

/// @description Ballots cast for a vote
model VoteBallot {
  id           String     @id @default(cuid())
  voteId       String     @map("vote_id")
  voterPartyId String     @map("voter_party_id")
  choice       VoteChoice
  castAt       DateTime   @default(now()) @map("cast_at")

  // Relations
  vote       Vote  @relation(fields: [voteId], references: [id], onDelete: Cascade)
  voterParty Party @relation(fields: [voterPartyId], references: [id])

  @@unique([voteId, voterPartyId])
  @@index([voterPartyId])
  @@map("vote_ballots")
}

/// @description Audit trail for board changes
model BoardHistory {
  id         String  @id @default(cuid())
  boardId    String  @map("board_id")
  changeType String
  detail     Json?
  changedBy  String? @map("changed_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@map("board_history")
}

/// @description Formal resolutions adopted by an association
model Resolution {
  id             String           @id @default(cuid())
  associationId  String           @map("association_id")
  boardId        String?          @map("board_id")
  title          String
  summary        String?          @db.Text
  status         ResolutionStatus @default(PROPOSED)
  effectiveDate  DateTime?        @map("effective_date")
  supersededById String?          @map("superseded_by_id")

  adoptedAt  DateTime? @map("adopted_at")
  proposedBy String?   @map("proposed_by") // User ID
  adoptedBy  String?   @map("adopted_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association  Association  @relation(fields: [associationId], references: [id], onDelete: Cascade)
  board        Board?       @relation(fields: [boardId], references: [id])
  supersededBy Resolution?  @relation("ResolutionSupersede", fields: [supersededById], references: [id])
  supersedes   Resolution[] @relation("ResolutionSupersede")

  policyDocuments PolicyDocument[]

  // Phase 9: Work Orders created from this board directive
  workOrders WorkOrder[]

  @@index([associationId])
  @@index([boardId])
  @@index([status])
  @@map("resolutions")
}

/// @description Policy documents with version history
model PolicyDocument {
  id             String       @id @default(cuid())
  associationId  String       @map("association_id")
  resolutionId   String?      @map("resolution_id")
  title          String
  description    String?      @db.Text
  currentVersion String?      @map("current_version")
  status         PolicyStatus @default(DRAFT)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association     @relation(fields: [associationId], references: [id], onDelete: Cascade)
  resolution  Resolution?     @relation(fields: [resolutionId], references: [id])
  versions    PolicyVersion[]

  @@index([associationId])
  @@index([resolutionId])
  @@index([status])
  @@map("policy_documents")
}

/// @description Versioned content for a policy document
model PolicyVersion {
  id               String       @id @default(cuid())
  policyDocumentId String       @map("policy_document_id")
  version          String
  content          String       @db.Text
  status           PolicyStatus @default(DRAFT)
  approvedAt       DateTime?    @map("approved_at")
  approvedBy       String?      @map("approved_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  policyDocument PolicyDocument @relation(fields: [policyDocumentId], references: [id], onDelete: Cascade)

  @@unique([policyDocumentId, version])
  @@index([policyDocumentId])
  @@index([status])
  @@map("policy_versions")
}

// =============================================================================
// PHASE 8: Communications
// =============================================================================

/// @description Templates for communications
model CommunicationTemplate {
  id             String                    @id @default(cuid())
  associationId  String                    @map("association_id")
  name           String
  type           CommunicationTemplateType
  channel        CommunicationChannel
  subject        String?
  body           String                    @db.Text
  variables      Json?
  currentVersion String?                   @map("current_version")

  createdBy String?  @map("created_by") // User ID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association        Association                    @relation(fields: [associationId], references: [id], onDelete: Cascade)
  massCommunications MassCommunication[]
  versions           CommunicationTemplateVersion[]

  @@index([associationId])
  @@map("communication_templates")
}

/// @description Versioned content for communication templates
model CommunicationTemplateVersion {
  id         String                @id @default(cuid())
  templateId String                @map("template_id")
  version    String
  subject    String?
  body       String                @db.Text
  variables  Json?
  status     TemplateVersionStatus @default(DRAFT)
  createdBy  String?               @map("created_by") // User ID
  createdAt  DateTime              @default(now()) @map("created_at")

  // Relations
  template CommunicationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
  @@index([status])
  @@map("communication_template_versions")
}

/// @description Mass communications (scheduled or sent)
model MassCommunication {
  id            String  @id @default(cuid())
  associationId String  @map("association_id")
  templateId    String? @map("template_id")

  subject      String?
  body         String               @db.Text
  channel      CommunicationChannel
  status       CommunicationStatus  @default(DRAFT)
  scheduledFor DateTime?            @map("scheduled_for")
  sentAt       DateTime?            @map("sent_at")
  targetFilter Json?                @map("target_filter") // e.g., audience selection

  createdBy String?  @map("created_by") // User ID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association                 @relation(fields: [associationId], references: [id], onDelete: Cascade)
  template    CommunicationTemplate?      @relation(fields: [templateId], references: [id])
  deliveries  MassCommunicationDelivery[]

  @@index([associationId])
  @@index([templateId])
  @@index([status])
  @@map("mass_communications")
}

/// @description Delivery log entries for mass communications
model MassCommunicationDelivery {
  id                  String               @id @default(cuid())
  massCommunicationId String               @map("mass_communication_id")
  recipient           String
  channel             CommunicationChannel
  status              DeliveryStatus       @default(PENDING)
  sentAt              DateTime?            @map("sent_at")
  errorMessage        String?              @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  massCommunication MassCommunication @relation(fields: [massCommunicationId], references: [id], onDelete: Cascade)

  @@index([massCommunicationId])
  @@index([status])
  @@map("mass_communication_deliveries")
}

/// @description Announcements for portal or broadcasts
model Announcement {
  id            String             @id @default(cuid())
  associationId String             @map("association_id")
  title         String
  content       String             @db.Text
  status        AnnouncementStatus @default(DRAFT)
  publishedAt   DateTime?          @map("published_at")
  expiresAt     DateTime?          @map("expires_at")
  audience      Json?

  createdBy String?  @map("created_by") // User ID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association        @relation(fields: [associationId], references: [id], onDelete: Cascade)
  reads       AnnouncementRead[]

  @@index([associationId])
  @@index([status])
  @@map("announcements")
}

/// @description Read receipts for announcements
model AnnouncementRead {
  id             String   @id @default(cuid())
  announcementId String   @map("announcement_id")
  partyId        String   @map("party_id")
  readAt         DateTime @default(now()) @map("read_at")

  // Relations
  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  party        Party        @relation(fields: [partyId], references: [id])

  @@unique([announcementId, partyId])
  @@index([partyId])
  @@map("announcement_reads")
}

/// @description Calendar events (meetings, maintenance, closures)
model CalendarEvent {
  id             String            @id @default(cuid())
  associationId  String            @map("association_id")
  type           CalendarEventType
  title          String
  description    String?           @db.Text
  startsAt       DateTime          @map("starts_at")
  endsAt         DateTime?         @map("ends_at")
  location       String?
  metadata       Json?
  recurrenceRule String?           @map("recurrence_rule")
  notifyAt       DateTime?         @map("notify_at")

  createdBy String?  @map("created_by") // User ID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association   Association                 @relation(fields: [associationId], references: [id], onDelete: Cascade)
  notifications CalendarEventNotification[]

  @@index([associationId])
  @@index([startsAt])
  @@map("calendar_events")
}

/// @description Notification entries for calendar events
model CalendarEventNotification {
  id            String                @id @default(cuid())
  associationId String                @map("association_id")
  eventId       String                @map("event_id")
  notifyAt      DateTime              @map("notify_at")
  status        NotificationStatus    @default(PENDING)
  channel       CommunicationChannel?
  payload       Json?
  sentAt        DateTime?             @map("sent_at")
  errorMessage  String?               @map("error_message")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association   @relation(fields: [associationId], references: [id], onDelete: Cascade)
  event       CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([eventId])
  @@index([status])
  @@map("calendar_event_notifications")
}

// =============================================================================
// PHASE 14: CROSS-TENANT FEATURES
// =============================================================================

/// @description Service area coverage for service providers
model ServiceArea {
  id                   String @id @default(cuid())
  serviceProviderOrgId String @map("service_provider_org_id")

  // Geographic coverage
  name      String // e.g., "Greater Denver Metro"
  zipCodes  String[] @map("zip_codes") // Array of covered zip codes
  radius    Int? // Radius in miles from center point
  centerLat Float?   @map("center_lat")
  centerLng Float?   @map("center_lng")

  // Service categories offered in this area
  serviceCategories String[] @map("service_categories") // e.g., ["PLUMBING", "HVAC", "ELECTRICAL"]

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  serviceProviderOrg    Organization          @relation("ServiceProviderAreas", fields: [serviceProviderOrgId], references: [id], onDelete: Cascade)
  technicianTerritories TechnicianTerritory[]
  pricebookItems        PricebookItem[]
  priceRules            PriceRule[]
  jobTemplates          JobTemplate[]

  @@index([serviceProviderOrgId])
  @@map("service_areas")
}

/// @description Links service provider org to vendor records across associations
model ServiceProviderLink {
  id                   String @id @default(cuid())
  serviceProviderOrgId String @map("service_provider_org_id")
  vendorId             String @map("vendor_id")

  // Link status
  status   ServiceProviderLinkStatus @default(PENDING)
  linkedAt DateTime?                 @map("linked_at")
  linkedBy String?                   @map("linked_by") // User who approved the link

  // Verification
  verificationCode    String?   @map("verification_code")
  verificationExpires DateTime? @map("verification_expires")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  serviceProviderOrg Organization @relation("ServiceProviderLinks", fields: [serviceProviderOrgId], references: [id], onDelete: Cascade)
  vendor             Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@unique([serviceProviderOrgId, vendorId])
  @@index([serviceProviderOrgId])
  @@index([vendorId])
  @@map("service_provider_links")
}

/// @description Individual homeowner property (non-HOA)
model IndividualProperty {
  id         String @id @default(cuid())
  ownerOrgId String @map("owner_org_id") // INDIVIDUAL_PROPERTY_OWNER or TRUST_OR_LLC org

  // Property details
  name         String // e.g., "Main Residence", "Vacation Home"
  propertyType PropertyType @map("property_type")

  // Address
  addressLine1 String  @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String
  state        String
  postalCode   String  @map("postal_code")
  country      String  @default("US")

  // Property info
  yearBuilt     Int?   @map("year_built")
  squareFeet    Int?   @map("square_feet")
  lotSquareFeet Int?   @map("lot_square_feet")
  bedrooms      Int?
  bathrooms     Float?

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Cross-Domain Integration (P3.12)
  // Link to Phase 1 HOA unit if property is in a platform HOA
  linkedUnitId String? @map("linked_unit_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  ownerOrg            Organization                   @relation("IndividualProperties", fields: [ownerOrgId], references: [id], onDelete: Cascade)
  maintenanceRequests IndividualMaintenanceRequest[]
  assets              IndividualAsset[]

  // Phase 3: Property Ownership
  propertyOwnerships PropertyOwnership[]
  portfolioMemberships PortfolioProperty[]
  ownerIntents         OwnerIntent[]
  conciergeCases       ConciergeCase[]
  externalHoaContexts  ExternalHOAContext[]
  externalVendorContexts ExternalVendorContext[]

  @@index([ownerOrgId])
  @@map("individual_properties")
}

/// @description Assets for individual properties
model IndividualAsset {
  id         String @id @default(cuid())
  propertyId String @map("property_id")

  // Asset details
  name         String
  category     String // e.g., "HVAC", "Appliance", "Roof"
  manufacturer String?
  model        String?
  serialNumber String? @map("serial_number")

  // Dates
  installDate     DateTime? @map("install_date")
  warrantyExpires DateTime? @map("warranty_expires")
  lastServiceDate DateTime? @map("last_service_date")

  // Status
  condition String? // e.g., "Good", "Fair", "Needs Attention"
  notes     String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  property IndividualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@map("individual_assets")
}

/// @description Maintenance requests for individual homeowners
model IndividualMaintenanceRequest {
  id         String @id @default(cuid())
  propertyId String @map("property_id")

  // Request details
  requestNumber String @map("request_number")
  title         String
  description   String @db.Text
  category      String // e.g., "PLUMBING", "HVAC", "ELECTRICAL"
  priority      String @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  // Status
  status IndividualRequestStatus @default(SUBMITTED)

  // Scheduling
  preferredDate DateTime? @map("preferred_date")
  scheduledDate DateTime? @map("scheduled_date")
  completedDate DateTime? @map("completed_date")

  // Vendor assignment
  assignedVendorOrgId String? @map("assigned_vendor_org_id")

  // Cost tracking
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(10, 2)
  actualCost    Decimal? @map("actual_cost") @db.Decimal(10, 2)

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  property          IndividualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  assignedVendorOrg Organization?      @relation("VendorMaintenanceRequests", fields: [assignedVendorOrgId], references: [id])

  @@unique([propertyId, requestNumber])
  @@index([propertyId])
  @@index([status])
  @@index([assignedVendorOrgId])
  @@map("individual_maintenance_requests")
}

// =============================================================================
// PHASE 15: REPORTING & ANALYTICS
// =============================================================================

/// @description Report definition/template
model ReportDefinition {
  id            String  @id @default(cuid())
  associationId String? @map("association_id") // Null for system-wide reports

  // Report identification
  code        String // e.g., "BALANCE_SHEET", "AGED_RECEIVABLES"
  name        String
  description String?
  category    ReportCategory

  // Report configuration
  queryTemplate  String  @map("query_template") @db.Text // SQL or query builder JSON
  parametersJson String? @map("parameters_json") @db.Text // JSON schema for parameters
  columnsJson    String? @map("columns_json") @db.Text // Column definitions

  // Output options
  defaultFormat  ReportFormat   @default(PDF) @map("default_format")
  allowedFormats ReportFormat[] @map("allowed_formats")

  // Access control
  isSystemReport Boolean @default(false) @map("is_system_report")
  isActive       Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association?      @relation(fields: [associationId], references: [id], onDelete: Cascade)
  executions  ReportExecution[]
  schedules   ReportSchedule[]

  @@unique([associationId, code])
  @@index([associationId])
  @@index([category])
  @@map("report_definitions")
}

/// @description Scheduled report execution
model ReportSchedule {
  id            String @id @default(cuid())
  reportId      String @map("report_id")
  associationId String @map("association_id")

  // Schedule configuration
  name           String
  frequency      ScheduleFrequency
  cronExpression String?           @map("cron_expression") // For custom schedules

  // Parameters for this schedule
  parametersJson String? @map("parameters_json") @db.Text

  // Output configuration
  format ReportFormat @default(PDF)

  // Delivery
  deliveryMethod ReportDeliveryMethod @default(EMAIL) @map("delivery_method")
  recipientsJson String?              @map("recipients_json") @db.Text // JSON array of email addresses

  // Status
  isActive  Boolean   @default(true) @map("is_active")
  lastRunAt DateTime? @map("last_run_at")
  nextRunAt DateTime? @map("next_run_at")

  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  report      ReportDefinition  @relation(fields: [reportId], references: [id], onDelete: Cascade)
  association Association       @relation(fields: [associationId], references: [id], onDelete: Cascade)
  executions  ReportExecution[]

  @@index([reportId])
  @@index([associationId])
  @@index([nextRunAt])
  @@map("report_schedules")
}

/// @description Report execution history
model ReportExecution {
  id            String  @id @default(cuid())
  reportId      String  @map("report_id")
  scheduleId    String? @map("schedule_id") // Null if ad-hoc
  associationId String  @map("association_id")

  // Execution details
  status         ReportExecutionStatus @default(PENDING)
  parametersJson String?               @map("parameters_json") @db.Text
  format         ReportFormat

  // Timing
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Output
  outputUrl  String? @map("output_url") // S3/storage URL
  outputSize Int?    @map("output_size") // Bytes
  rowCount   Int?    @map("row_count")

  // Error handling
  errorMessage String? @map("error_message") @db.Text

  // Who ran it
  executedBy String? @map("executed_by") // Null for scheduled

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  report      ReportDefinition @relation(fields: [reportId], references: [id], onDelete: Cascade)
  schedule    ReportSchedule?  @relation(fields: [scheduleId], references: [id])
  association Association      @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([scheduleId])
  @@index([associationId])
  @@index([status])
  @@index([createdAt])
  @@map("report_executions")
}

/// @description Dashboard widget configuration
model DashboardWidget {
  id            String  @id @default(cuid())
  associationId String  @map("association_id")
  userId        String? @map("user_id") // Null for association-wide

  // Widget configuration
  widgetType WidgetType @map("widget_type")
  title      String
  configJson String?    @map("config_json") @db.Text // Widget-specific config

  // Layout
  position Int @default(0) // Order in dashboard
  width    Int @default(1) // Grid units
  height   Int @default(1)

  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  association Association @relation(fields: [associationId], references: [id], onDelete: Cascade)

  @@index([associationId])
  @@index([userId])
  @@map("dashboard_widgets")
}

// =============================================================================
// PHASE 2: CONTRACTOR OPERATIONS
// =============================================================================

/// @description Contractor profile for SERVICE_PROVIDER organizations
model ContractorProfile {
  id             String @id @default(cuid())
  organizationId String @unique @map("organization_id")

  // Business info
  legalName String  @map("legal_name")
  dba       String? // Doing business as
  taxId     String? @map("tax_id") // EIN (encrypted)

  // Contact
  primaryContactName  String? @map("primary_contact_name")
  primaryContactEmail String? @map("primary_contact_email") @db.Citext
  primaryContactPhone String? @map("primary_contact_phone")

  // Address (headquarters)
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String  @default("US")

  // Operating hours (JSON: { "monday": { "open": "08:00", "close": "17:00" }, ... })
  operatingHoursJson String? @map("operating_hours_json") @db.Text
  timezone           String  @default("America/New_York")

  // Capabilities
  maxTechnicians   Int? @map("max_technicians")
  maxServiceRadius Int? @map("max_service_radius") // Miles

  // Compliance summary (computed/cached)
  complianceScore     Int?      @map("compliance_score") // 0-100
  lastComplianceCheck DateTime? @map("last_compliance_check")

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  trades       ContractorTrade[]
  licenses     ContractorLicense[]
  insurances   ContractorInsurance[]

  @@index([organizationId])
  @@map("contractor_profiles")
}

/// @description Branch office for a contractor organization
model ContractorBranch {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // Branch info
  name String // e.g., "North Region Office"
  code String? // Internal branch code

  // Contact
  contactName  String? @map("contact_name")
  contactEmail String? @map("contact_email") @db.Citext
  contactPhone String? @map("contact_phone")

  // Address
  addressLine1 String  @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String
  state        String
  postalCode   String  @map("postal_code")
  country      String  @default("US")

  // Operating hours (JSON)
  operatingHoursJson String? @map("operating_hours_json") @db.Text
  timezone           String  @default("America/New_York")

  // Service area (can override org-level)
  serviceRadiusMiles Int? @map("service_radius_miles")

  // Status
  isActive  Boolean @default(true) @map("is_active")
  isPrimary Boolean @default(false) @map("is_primary")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technicians  Technician[]
  jobs         Job[]

  // Inventory
  inventoryLocations InventoryLocation[]

  // Maintenance Contracts
  serviceContracts ServiceContract[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("contractor_branches")
}

/// @description Trade/service category a contractor is qualified for
model ContractorTrade {
  id                  String @id @default(cuid())
  contractorProfileId String @map("contractor_profile_id")

  tradeType       ContractorTradeType @map("trade_type")
  isPrimary       Boolean             @default(false) @map("is_primary")
  yearsExperience Int?                @map("years_experience")
  notes           String?             @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contractorProfile ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)

  @@unique([contractorProfileId, tradeType])
  @@index([contractorProfileId])
  @@index([tradeType])
  @@map("contractor_trades")
}

/// @description Contractor license record
model ContractorLicense {
  id                  String @id @default(cuid())
  contractorProfileId String @map("contractor_profile_id")

  // License details
  licenseType      String  @map("license_type") // e.g., "General Contractor", "Electrician"
  licenseNumber    String  @map("license_number")
  issuingAuthority String  @map("issuing_authority") // e.g., "State of California"
  issuingState     String? @map("issuing_state")

  // Dates
  issueDate      DateTime? @map("issue_date")
  expirationDate DateTime? @map("expiration_date")

  // Status
  status     LicenseStatus @default(ACTIVE)
  verifiedAt DateTime?     @map("verified_at")
  verifiedBy String?       @map("verified_by")

  // Document reference
  documentUrl String? @map("document_url")

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contractorProfile ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)

  @@index([contractorProfileId])
  @@index([expirationDate])
  @@index([status])
  @@map("contractor_licenses")
}

/// @description Contractor insurance policy record
model ContractorInsurance {
  id                  String @id @default(cuid())
  contractorProfileId String @map("contractor_profile_id")

  // Insurance details
  insuranceType InsuranceType @map("insurance_type")
  policyNumber  String        @map("policy_number")
  carrier       String // Insurance company name

  // Coverage
  coverageAmount Decimal  @map("coverage_amount") @db.Decimal(12, 2)
  deductible     Decimal? @db.Decimal(10, 2)

  // Dates
  effectiveDate  DateTime @map("effective_date")
  expirationDate DateTime @map("expiration_date")

  // Status
  status     InsuranceStatus @default(ACTIVE)
  verifiedAt DateTime?       @map("verified_at")
  verifiedBy String?         @map("verified_by")

  // Certificate of Insurance
  coiDocumentUrl String? @map("coi_document_url")

  // Additional insured (HOAs may require this)
  additionalInsuredJson String? @map("additional_insured_json") @db.Text

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contractorProfile ContractorProfile @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)

  @@index([contractorProfileId])
  @@index([expirationDate])
  @@index([status])
  @@map("contractor_insurances")
}

/// @description Contractor compliance status (computed/cached per association)
model ContractorComplianceStatus {
  id       String @id @default(cuid())
  vendorId String @map("vendor_id") // Links to Vendor (association-specific view)

  // Overall compliance
  isCompliant     Boolean @default(false) @map("is_compliant")
  complianceScore Int     @default(0) @map("compliance_score") // 0-100

  // Individual checks
  hasValidLicense   Boolean @default(false) @map("has_valid_license")
  hasValidInsurance Boolean @default(false) @map("has_valid_insurance")
  hasW9OnFile       Boolean @default(false) @map("has_w9_on_file")
  meetsMinCoverage  Boolean @default(false) @map("meets_min_coverage")

  // Expiration tracking
  earliestLicenseExpiry   DateTime? @map("earliest_license_expiry")
  earliestInsuranceExpiry DateTime? @map("earliest_insurance_expiry")

  // Blocking
  isBlocked   Boolean   @default(false) @map("is_blocked")
  blockReason String?   @map("block_reason") @db.Text
  blockedAt   DateTime? @map("blocked_at")
  blockedBy   String?   @map("blocked_by")

  // Last check
  lastCheckedAt DateTime @default(now()) @map("last_checked_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([vendorId])
  @@index([isCompliant])
  @@index([isBlocked])
  @@index([earliestLicenseExpiry])
  @@index([earliestInsuranceExpiry])
  @@map("contractor_compliance_statuses")
}

// =============================================================================
// PHASE 2: PRICEBOOK, SERVICES & MATERIALS
// =============================================================================

enum PricebookItemType {
  SERVICE
  LABOR
  MATERIAL
  BUNDLE
}

enum PricebookVersionStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  ARCHIVED
}

enum PriceRuleType {
  HOA
  SEASONAL
  VOLUME
  CONTRACTOR_OVERRIDE
  OTHER
}

/// @description Catalog scoped to a contractor/service provider organization
model Pricebook {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  name        String
  description String?
  currency    String  @default("USD")
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  versions     PricebookVersion[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("pricebooks")
}

/// @description Versioned snapshot of a pricebook
model PricebookVersion {
  id            String @id @default(cuid())
  pricebookId   String @map("pricebook_id")
  versionNumber Int    @map("version_number")

  status         PricebookVersionStatus @default(DRAFT)
  effectiveStart DateTime?              @map("effective_start")
  effectiveEnd   DateTime?              @map("effective_end")
  notes          String?                @db.Text
  metadata       Json?

  publishedAt DateTime? @map("published_at")
  publishedBy String?   @map("published_by") // User ID who published
  activatedAt DateTime? @map("activated_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  pricebook    Pricebook       @relation(fields: [pricebookId], references: [id], onDelete: Cascade)
  items        PricebookItem[]
  rules        PriceRule[]
  jobTemplates JobTemplate[]
  workOrders   WorkOrder[]

  @@unique([pricebookId, versionNumber])
  @@index([pricebookId])
  @@index([status])
  @@map("pricebook_versions")
}

/// @description Catalog line for a service, labor, material, or bundle
model PricebookItem {
  id                 String @id @default(cuid())
  pricebookVersionId String @map("pricebook_version_id")

  type        PricebookItemType
  code        String
  name        String
  description String?              @db.Text
  trade       ContractorTradeType?

  unitOfMeasure String?  @map("unit_of_measure")
  basePrice     Decimal  @map("base_price") @db.Decimal(12, 2)
  cost          Decimal? @db.Decimal(12, 2)
  isTaxable     Boolean  @default(true) @map("is_taxable")

  serviceAreaId String? @map("service_area_id")
  metadata      Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  pricebookVersion   PricebookVersion    @relation(fields: [pricebookVersionId], references: [id], onDelete: Cascade)
  serviceArea        ServiceArea?        @relation(fields: [serviceAreaId], references: [id], onDelete: SetNull)
  jobTemplateItems   JobTemplateItem[]
  rules              PriceRule[]
  workOrderLineItems WorkOrderLineItem[]

  // Estimates & Invoicing
  estimateLines EstimateLine[]
  invoiceLines  InvoiceLine[]

  // Inventory
  inventoryItems InventoryItem[]

  // Maintenance Contracts
  contractServiceItems ContractServiceItem[]

  @@unique([pricebookVersionId, code])
  @@index([pricebookVersionId])
  @@index([serviceAreaId])
  @@index([trade])
  @@map("pricebook_items")
}

/// @description Pricing rule for adjustments (HOA, seasonal, volume, overrides)
model PriceRule {
  id                 String  @id @default(cuid())
  pricebookVersionId String  @map("pricebook_version_id")
  pricebookItemId    String? @map("pricebook_item_id")

  ruleType    PriceRuleType
  name        String
  description String?       @db.Text
  priority    Int           @default(100)

  // Conditions
  associationId String?   @map("association_id")
  serviceAreaId String?   @map("service_area_id")
  minQuantity   Decimal?  @map("min_quantity") @db.Decimal(10, 2)
  startsAt      DateTime? @map("starts_at")
  endsAt        DateTime? @map("ends_at")
  conditionJson Json?

  // Adjustments
  percentageAdjustment Decimal? @map("percentage_adjustment") @db.Decimal(7, 4)
  amountAdjustment     Decimal? @map("amount_adjustment") @db.Decimal(12, 2)
  adjustmentJson       Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  pricebookVersion PricebookVersion @relation(fields: [pricebookVersionId], references: [id], onDelete: Cascade)
  pricebookItem    PricebookItem?   @relation(fields: [pricebookItemId], references: [id], onDelete: Cascade)
  association      Association?     @relation(fields: [associationId], references: [id], onDelete: Cascade)
  serviceArea      ServiceArea?     @relation(fields: [serviceAreaId], references: [id], onDelete: SetNull)

  @@index([pricebookVersionId])
  @@index([pricebookItemId])
  @@index([associationId])
  @@index([serviceAreaId])
  @@index([ruleType])
  @@map("price_rules")
}

/// @description Job template referencing pricebook items for repeatable work definitions
model JobTemplate {
  id                 String @id @default(cuid())
  organizationId     String @map("organization_id")
  pricebookVersionId String @map("pricebook_version_id")

  name        String
  description String? @db.Text
  isActive    Boolean @default(true) @map("is_active")

  defaultTrade         ContractorTradeType?
  defaultServiceAreaId String?              @map("default_service_area_id")
  metadata             Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  pricebookVersion   PricebookVersion  @relation(fields: [pricebookVersionId], references: [id], onDelete: Cascade)
  defaultServiceArea ServiceArea?      @relation(fields: [defaultServiceAreaId], references: [id], onDelete: SetNull)
  items              JobTemplateItem[]
  workOrders         WorkOrder[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([pricebookVersionId])
  @@map("job_templates")
}

/// @description Line items within a job template
model JobTemplateItem {
  id              String @id @default(cuid())
  jobTemplateId   String @map("job_template_id")
  pricebookItemId String @map("pricebook_item_id")

  quantity   Decimal @default(1) @db.Decimal(10, 2)
  lineNumber Int     @default(1) @map("line_number")
  notes      String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  jobTemplate   JobTemplate   @relation(fields: [jobTemplateId], references: [id], onDelete: Cascade)
  pricebookItem PricebookItem @relation(fields: [pricebookItemId], references: [id], onDelete: Cascade)

  @@unique([jobTemplateId, lineNumber])
  @@index([pricebookItemId])
  @@map("job_template_items")
}

// =============================================================================
// PHASE 2: JOB LIFECYCLE & WORK ORDER MANAGEMENT (P2.4)
// =============================================================================

enum JobStatus {
  LEAD
  TICKET
  ESTIMATE_REQUIRED
  JOB_CREATED
  SCHEDULED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  WARRANTY
  CLOSED
  CANCELLED
}

enum JobSourceType {
  WORK_ORDER      // HOA-originated via WorkOrder
  VIOLATION       // Violation remediation
  ARC_REQUEST     // Architectural request
  DIRECT_CUSTOMER // Off-platform customer
  LEAD            // Marketing/referral lead
  RECURRING       // From maintenance contract
}

enum CheckpointType {
  QA_INSPECTION
  WARRANTY_CHECK
  CUSTOMER_APPROVAL
  SAFETY_CHECK
  COMPLIANCE_CHECK
  OTHER
}

/// @description Off-platform customer for contractor jobs
model Customer {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // Customer details
  name        String
  companyName String? @map("company_name")
  email       String? @db.Citext
  phone       String?
  altPhone    String? @map("alt_phone")

  // Address
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String? @default("US")

  // Additional info
  notes       String? @db.Text
  tags        String[] // e.g., ["VIP", "Commercial"]
  source      String? // How they found us
  referredBy  String? @map("referred_by")

  isActive  Boolean   @default(true) @map("is_active")
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobs         Job[]

  // Estimates & Invoicing
  estimates      Estimate[]
  proposals      Proposal[]
  invoices       JobInvoice[]
  paymentIntents PaymentIntent[]

  // Maintenance Contracts
  serviceContracts ServiceContract[]

  @@index([organizationId])
  @@index([email])
  @@index([phone])
  @@map("customers")
}

/// @description Contractor job - can originate from WorkOrder, Violation, ARC, or direct customer
model Job {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // Job identification
  jobNumber String    @map("job_number") // e.g., "JOB-2024-000001"
  status    JobStatus @default(LEAD)

  // Source/origin (one of these should be set)
  sourceType   JobSourceType @map("source_type")
  workOrderId  String?       @map("work_order_id")
  violationId  String?       @map("violation_id")
  arcRequestId String?       @map("arc_request_id")
  customerId   String?       @map("customer_id")

  // Location (for off-platform jobs or override)
  unitId         String? @map("unit_id")
  propertyId     String? @map("property_id")
  associationId  String? @map("association_id")
  addressLine1   String? @map("address_line_1")
  addressLine2   String? @map("address_line_2")
  city           String?
  state          String?
  postalCode     String? @map("postal_code")
  locationNotes  String? @map("location_notes")

  // Job details
  title       String
  description String? @db.Text
  category    String? // e.g., "HVAC", "Plumbing"
  priority    String  @default("MEDIUM") // EMERGENCY, HIGH, MEDIUM, LOW

  // Assignment
  assignedTechnicianId String?   @map("assigned_technician_id")
  assignedBranchId     String?   @map("assigned_branch_id")
  assignedAt           DateTime? @map("assigned_at")
  assignedBy           String?   @map("assigned_by")

  // Scheduling
  scheduledStart DateTime? @map("scheduled_start")
  scheduledEnd   DateTime? @map("scheduled_end")
  estimatedHours Decimal?  @map("estimated_hours") @db.Decimal(5, 2)

  // Execution
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  closedAt    DateTime? @map("closed_at")
  closedBy    String?   @map("closed_by")

  // Financials
  estimatedCost Decimal? @map("estimated_cost") @db.Decimal(12, 2)
  actualCost    Decimal? @map("actual_cost") @db.Decimal(12, 2)
  actualHours   Decimal? @map("actual_hours") @db.Decimal(5, 2)

  // Warranty
  warrantyEnds  DateTime? @map("warranty_ends")
  warrantyNotes String?   @map("warranty_notes") @db.Text

  // Resolution
  resolutionNotes String? @map("resolution_notes") @db.Text
  customerRating  Int?    @map("customer_rating") // 1-5
  customerFeedback String? @map("customer_feedback") @db.Text

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workOrder          WorkOrder?           @relation(fields: [workOrderId], references: [id], onDelete: SetNull)
  customer           Customer?            @relation(fields: [customerId], references: [id], onDelete: SetNull)
  assignedTechnician Technician?          @relation(fields: [assignedTechnicianId], references: [id], onDelete: SetNull)
  assignedBranch     ContractorBranch?    @relation(fields: [assignedBranchId], references: [id], onDelete: SetNull)
  unit               Unit?                @relation(fields: [unitId], references: [id], onDelete: SetNull)
  property           Property?            @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  association        Association?         @relation(fields: [associationId], references: [id], onDelete: SetNull)
  statusHistory      JobStatusHistory[]
  notes              JobNote[]
  attachments        JobAttachment[]
  checkpoints        JobCheckpoint[]
  visits             JobVisit[]

  // Dispatch & Scheduling
  dispatchAssignments DispatchAssignment[]
  slaRecord           SLARecord?

  // Field Technician Mobile
  checklists   JobChecklist[]
  media        JobMedia[]
  timeEntries  JobTimeEntry[]
  signatures   JobSignature[]

  // Estimates & Invoicing
  estimates Estimate[]
  invoices  JobInvoice[]

  // Inventory
  materialUsages MaterialUsage[]

  // Maintenance Contracts
  scheduledVisits ScheduledVisit[]

  @@unique([organizationId, jobNumber])
  @@index([organizationId])
  @@index([status])
  @@index([workOrderId])
  @@index([customerId])
  @@index([assignedTechnicianId])
  @@index([scheduledStart])
  @@map("jobs")
}

/// @description Status change history for jobs
model JobStatusHistory {
  id        String    @id @default(cuid())
  jobId     String    @map("job_id")
  fromStatus JobStatus? @map("from_status")
  toStatus  JobStatus  @map("to_status")
  changedBy String    @map("changed_by")
  changedAt DateTime  @default(now()) @map("changed_at")
  notes     String?   @db.Text

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_status_history")
}

/// @description Notes/comments on a job
model JobNote {
  id         String  @id @default(cuid())
  jobId      String  @map("job_id")
  authorId   String  @map("author_id")
  content    String  @db.Text
  isInternal Boolean @default(false) @map("is_internal") // Internal vs customer-visible

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_notes")
}

/// @description File attachments on a job
model JobAttachment {
  id       String @id @default(cuid())
  jobId    String @map("job_id")

  fileName    String  @map("file_name")
  fileUrl     String  @map("file_url")
  fileSize    Int?    @map("file_size")
  mimeType    String? @map("mime_type")
  description String?

  uploadedBy String   @map("uploaded_by")
  uploadedAt DateTime @default(now()) @map("uploaded_at")

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_attachments")
}

/// @description QA/warranty checkpoints for a job
model JobCheckpoint {
  id    String         @id @default(cuid())
  jobId String         @map("job_id")
  type  CheckpointType

  name        String
  description String? @db.Text
  isRequired  Boolean @default(true) @map("is_required")

  // Completion
  completedAt DateTime? @map("completed_at")
  completedBy String?   @map("completed_by")
  passed      Boolean?
  notes       String?   @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("job_checkpoints")
}

/// @description Individual visit/appointment for a job
model JobVisit {
  id    String @id @default(cuid())
  jobId String @map("job_id")

  visitNumber Int @map("visit_number") // Sequence for this job

  // Scheduling
  scheduledStart DateTime  @map("scheduled_start")
  scheduledEnd   DateTime  @map("scheduled_end")
  actualStart    DateTime? @map("actual_start")
  actualEnd      DateTime? @map("actual_end")

  // Assignment
  technicianId String? @map("technician_id")

  // Status
  status String @default("SCHEDULED") // SCHEDULED, EN_ROUTE, ARRIVED, IN_PROGRESS, COMPLETED, CANCELLED

  // Notes
  notes        String? @db.Text
  workPerformed String? @map("work_performed") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  job        Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  technician Technician? @relation(fields: [technicianId], references: [id], onDelete: SetNull)

  // Inventory
  materialUsages MaterialUsage[]

  @@unique([jobId, visitNumber])
  @@index([jobId])
  @@index([technicianId])
  @@index([scheduledStart])
  @@map("job_visits")
}

// =============================================================================
// PHASE 2: DISPATCH, ROUTING & SCHEDULING (P2.5)
// =============================================================================

enum DispatchStatus {
  PENDING
  ASSIGNED
  ACCEPTED
  DECLINED
  EN_ROUTE
  ON_SITE
  COMPLETED
  CANCELLED
}

enum SLAPriority {
  EMERGENCY   // 2-4 hours
  URGENT      // Same day
  HIGH        // Next business day
  STANDARD    // 2-3 business days
  LOW         // 5+ business days
}

/// @description Assignment of a technician to a job/visit for dispatch
model DispatchAssignment {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // What is being dispatched
  jobId      String  @map("job_id")
  jobVisitId String? @map("job_visit_id")

  // Who is assigned
  technicianId String @map("technician_id")

  // Status tracking
  status       DispatchStatus @default(PENDING)
  assignedAt   DateTime       @default(now()) @map("assigned_at")
  assignedBy   String         @map("assigned_by")
  acceptedAt   DateTime?      @map("accepted_at")
  declinedAt   DateTime?      @map("declined_at")
  declineReason String?       @map("decline_reason")
  startedAt    DateTime?      @map("started_at")
  completedAt  DateTime?      @map("completed_at")
  cancelledAt  DateTime?      @map("cancelled_at")
  cancelReason String?        @map("cancel_reason")

  // Scheduling window
  scheduledStart DateTime  @map("scheduled_start")
  scheduledEnd   DateTime  @map("scheduled_end")
  actualStart    DateTime? @map("actual_start")
  actualEnd      DateTime? @map("actual_end")

  // Travel estimates
  estimatedTravelMinutes Int? @map("estimated_travel_minutes")
  actualTravelMinutes    Int? @map("actual_travel_minutes")
  distanceMiles          Decimal? @map("distance_miles") @db.Decimal(8, 2)

  // Notes
  dispatchNotes String? @map("dispatch_notes") @db.Text
  techNotes     String? @map("tech_notes") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  technician   Technician   @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([jobId])
  @@index([technicianId])
  @@index([status])
  @@index([scheduledStart])
  @@map("dispatch_assignments")
}

/// @description Schedule slot for a technician's calendar
model ScheduleSlot {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  technicianId   String @map("technician_id")

  // Time window
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")

  // What this slot is for
  slotType String @map("slot_type") // AVAILABLE, JOB, BREAK, TRAVEL, BLOCKED

  // Reference to job/visit if applicable
  jobId      String? @map("job_id")
  jobVisitId String? @map("job_visit_id")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technician   Technician   @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([technicianId])
  @@index([startTime])
  @@index([slotType])
  @@map("schedule_slots")
}

/// @description Route plan for a technician's day
model RoutePlan {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  technicianId   String @map("technician_id")

  // Date for this route
  routeDate DateTime @map("route_date") @db.Date

  // Route optimization
  isOptimized       Boolean   @default(false) @map("is_optimized")
  optimizedAt       DateTime? @map("optimized_at")
  totalDistanceMiles Decimal? @map("total_distance_miles") @db.Decimal(10, 2)
  totalTravelMinutes Int?     @map("total_travel_minutes")
  totalJobMinutes    Int?     @map("total_job_minutes")

  // Start/end locations
  startAddress String? @map("start_address")
  startLat     Decimal? @map("start_lat") @db.Decimal(10, 7)
  startLng     Decimal? @map("start_lng") @db.Decimal(10, 7)
  endAddress   String? @map("end_address")
  endLat       Decimal? @map("end_lat") @db.Decimal(10, 7)
  endLng       Decimal? @map("end_lng") @db.Decimal(10, 7)

  // Route stops (ordered JSON array of stop details)
  stopsJson Json? @map("stops_json")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technician   Technician   @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@unique([technicianId, routeDate])
  @@index([organizationId])
  @@index([technicianId])
  @@index([routeDate])
  @@map("route_plans")
}

/// @description SLA window configuration for job types/priorities
model SLAWindow {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // What this SLA applies to
  name        String
  description String? @db.Text
  priority    SLAPriority

  // Response time requirements (in minutes)
  responseTimeMinutes   Int @map("response_time_minutes")   // Time to acknowledge
  resolutionTimeMinutes Int @map("resolution_time_minutes") // Time to complete

  // Business hours consideration
  businessHoursOnly Boolean @default(true) @map("business_hours_only")

  // Applicability
  jobCategory String? @map("job_category") // Optional: specific job category
  isDefault   Boolean @default(false) @map("is_default")
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  slaRecords   SLARecord[]

  @@index([organizationId])
  @@index([priority])
  @@map("sla_windows")
}

/// @description SLA tracking record for a specific job
model SLARecord {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  jobId          String @map("job_id")
  slaWindowId    String @map("sla_window_id")

  // Deadlines
  responseDue   DateTime @map("response_due")
  resolutionDue DateTime @map("resolution_due")

  // Actual times
  respondedAt DateTime? @map("responded_at")
  resolvedAt  DateTime? @map("resolved_at")

  // Status
  responseBreached   Boolean @default(false) @map("response_breached")
  resolutionBreached Boolean @default(false) @map("resolution_breached")

  // Notes
  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  slaWindow    SLAWindow    @relation(fields: [slaWindowId], references: [id], onDelete: Cascade)

  @@unique([jobId])
  @@index([organizationId])
  @@index([slaWindowId])
  @@index([responseDue])
  @@index([resolutionDue])
  @@map("sla_records")
}

// =============================================================================
// PHASE 2: FIELD TECHNICIAN MOBILE (P2.6)
// =============================================================================

enum ChecklistItemStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  FAILED
}

enum TimeEntryType {
  TRAVEL
  WORK
  BREAK
  WAITING
}

enum MediaType {
  PHOTO
  VIDEO
  AUDIO
  DOCUMENT
}

/// @description Checklist template for jobs
model JobChecklist {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  name        String
  description String? @db.Text

  // Template vs instance
  isTemplate Boolean @default(false) @map("is_template")
  templateId String? @map("template_id") // If instance, references template

  // Association
  jobId String? @map("job_id") // Null for templates

  // Status
  isCompleted   Boolean   @default(false) @map("is_completed")
  completedAt   DateTime? @map("completed_at")
  completedBy   String?   @map("completed_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job?           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  template     JobChecklist?  @relation("ChecklistTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  instances    JobChecklist[] @relation("ChecklistTemplate")
  steps        JobStep[]

  @@index([organizationId])
  @@index([jobId])
  @@index([isTemplate])
  @@map("job_checklists")
}

/// @description Individual step within a checklist
model JobStep {
  id          String @id @default(cuid())
  checklistId String @map("checklist_id")

  // Step details
  stepNumber  Int     @map("step_number")
  title       String
  description String? @db.Text
  isRequired  Boolean @default(true) @map("is_required")

  // Completion
  status      ChecklistItemStatus @default(PENDING)
  completedAt DateTime?           @map("completed_at")
  completedBy String?             @map("completed_by")
  notes       String?             @db.Text

  // Evidence requirements
  requiresPhoto     Boolean @default(false) @map("requires_photo")
  requiresSignature Boolean @default(false) @map("requires_signature")
  requiresNotes     Boolean @default(false) @map("requires_notes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  checklist JobChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@unique([checklistId, stepNumber])
  @@index([checklistId])
  @@map("job_steps")
}

/// @description Media files attached to jobs (photos, videos, voice notes)
model JobMedia {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  jobId          String @map("job_id")
  jobVisitId     String? @map("job_visit_id")

  // Media details
  mediaType   MediaType
  fileName    String    @map("file_name")
  fileSize    Int       @map("file_size") // bytes
  mimeType    String    @map("mime_type")
  storageKey  String    @map("storage_key") // S3/storage key
  storageUrl  String?   @map("storage_url") // Presigned URL (temporary)

  // Metadata
  caption     String? @db.Text
  latitude    Decimal? @db.Decimal(10, 7)
  longitude   Decimal? @db.Decimal(10, 7)
  capturedAt  DateTime? @map("captured_at")

  // Voice note transcription
  transcription String? @db.Text
  isTranscribed Boolean @default(false) @map("is_transcribed")

  // Upload status (for offline sync)
  isUploaded    Boolean   @default(false) @map("is_uploaded")
  uploadedAt    DateTime? @map("uploaded_at")
  uploadRetries Int       @default(0) @map("upload_retries")

  uploadedBy String @map("uploaded_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([jobId])
  @@index([jobVisitId])
  @@index([mediaType])
  @@map("job_media")
}

/// @description Time tracking entries for jobs
model JobTimeEntry {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  jobId          String @map("job_id")
  jobVisitId     String? @map("job_visit_id")
  technicianId   String @map("technician_id")

  // Time tracking
  entryType TimeEntryType @map("entry_type")
  startTime DateTime      @map("start_time")
  endTime   DateTime?     @map("end_time")

  // Calculated duration (in minutes)
  durationMinutes Int? @map("duration_minutes")

  // Notes
  notes String? @db.Text

  // Billing
  isBillable Boolean @default(true) @map("is_billable")
  hourlyRate Decimal? @map("hourly_rate") @db.Decimal(10, 2)

  // Sync status (for offline)
  isSynced  Boolean   @default(true) @map("is_synced")
  syncedAt  DateTime? @map("synced_at")
  localId   String?   @map("local_id") // Client-side ID for offline records

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  technician   Technician   @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([jobId])
  @@index([technicianId])
  @@index([startTime])
  @@map("job_time_entries")
}

/// @description Digital signatures captured for jobs
model JobSignature {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  jobId          String @map("job_id")
  jobVisitId     String? @map("job_visit_id")

  // Signer info
  signerName  String  @map("signer_name")
  signerEmail String? @map("signer_email")
  signerRole  String  @map("signer_role") // CUSTOMER, TECHNICIAN, MANAGER, etc.

  // Signature data
  signatureData String   @map("signature_data") @db.Text // Base64 or SVG path
  signedAt      DateTime @map("signed_at")

  // Location
  latitude  Decimal? @db.Decimal(10, 7)
  longitude Decimal? @db.Decimal(10, 7)

  // What was signed
  documentType String  @map("document_type") // WORK_COMPLETION, ESTIMATE_APPROVAL, etc.
  documentId   String? @map("document_id")

  // IP/device info for audit
  ipAddress   String? @map("ip_address")
  deviceInfo  String? @map("device_info")

  capturedBy String @map("captured_by")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([jobId])
  @@index([jobVisitId])
  @@map("job_signatures")
}

/// @description Queued records for offline sync
model OfflineSyncQueue {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  technicianId   String @map("technician_id")

  // Record details
  entityType String @map("entity_type") // JobTimeEntry, JobMedia, JobStep, etc.
  entityId   String @map("entity_id")   // Local ID
  action     String // CREATE, UPDATE, DELETE
  payload    Json   // Full record data

  // Sync status
  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at")
  errorMessage  String?   @map("error_message") @db.Text
  isSynced      Boolean   @default(false) @map("is_synced")
  syncedAt      DateTime? @map("synced_at")
  syncedId      String?   @map("synced_id") // Server-side ID after sync

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technician   Technician   @relation(fields: [technicianId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([technicianId])
  @@index([isSynced])
  @@index([entityType])
  @@map("offline_sync_queue")
}

// =============================================================================
// PHASE 2: ESTIMATES, PROPOSALS & INVOICING (P2.7)
// =============================================================================

enum EstimateStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  DECLINED
  EXPIRED
  REVISED
}

enum ProposalStatus {
  DRAFT
  SENT
  VIEWED
  ACCEPTED
  DECLINED
  EXPIRED
}

enum JobInvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PARTIAL
  PAID
  OVERDUE
  VOID
  REFUNDED
}

enum JobPaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

/// @description Estimate for a job
model Estimate {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  jobId          String @map("job_id")
  customerId     String @map("customer_id")

  // Estimate details
  estimateNumber String         @map("estimate_number")
  version        Int            @default(1)
  status         EstimateStatus @default(DRAFT)

  // Dates
  issueDate   DateTime  @default(now()) @map("issue_date")
  validUntil  DateTime? @map("valid_until")
  sentAt      DateTime? @map("sent_at")
  viewedAt    DateTime? @map("viewed_at")
  acceptedAt  DateTime? @map("accepted_at")
  declinedAt  DateTime? @map("declined_at")

  // Amounts
  subtotal    Decimal @default(0) @map("subtotal") @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  discount    Decimal @default(0) @db.Decimal(12, 2)
  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(12, 2)

  // Content
  title       String?
  description String? @db.Text
  notes       String? @db.Text
  terms       String? @db.Text

  // Revision tracking
  previousVersionId String? @map("previous_version_id")

  createdBy String @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job             Job              @relation(fields: [jobId], references: [id], onDelete: Cascade)
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  previousVersion Estimate?        @relation("EstimateVersions", fields: [previousVersionId], references: [id], onDelete: SetNull)
  newerVersions   Estimate[]       @relation("EstimateVersions")
  lines           EstimateLine[]
  options         EstimateOption[]
  proposals       Proposal[]

  @@unique([organizationId, estimateNumber, version])
  @@index([organizationId])
  @@index([jobId])
  @@index([customerId])
  @@index([status])
  @@map("estimates")
}

/// @description Line item on an estimate
model EstimateLine {
  id         String @id @default(cuid())
  estimateId String @map("estimate_id")

  // Line details
  lineNumber  Int     @map("line_number")
  description String  @db.Text
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  lineTotal   Decimal @map("line_total") @db.Decimal(12, 2)

  // Optional pricebook reference
  pricebookItemId String? @map("pricebook_item_id")

  // Tax
  isTaxable Boolean @default(true) @map("is_taxable")
  taxRate   Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)

  // Grouping
  optionId String? @map("option_id") // If part of an option

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  estimate       Estimate        @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  pricebookItem  PricebookItem?  @relation(fields: [pricebookItemId], references: [id], onDelete: SetNull)
  option         EstimateOption? @relation(fields: [optionId], references: [id], onDelete: SetNull)

  @@unique([estimateId, lineNumber])
  @@index([estimateId])
  @@index([pricebookItemId])
  @@map("estimate_lines")
}

/// @description Option/alternative within an estimate
model EstimateOption {
  id         String @id @default(cuid())
  estimateId String @map("estimate_id")

  // Option details
  name        String
  description String? @db.Text
  isDefault   Boolean @default(false) @map("is_default")
  isSelected  Boolean @default(false) @map("is_selected")

  // Amounts
  subtotal    Decimal @default(0) @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(12, 2)

  sortOrder Int @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  estimate Estimate       @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  lines    EstimateLine[]

  @@index([estimateId])
  @@map("estimate_options")
}

/// @description Proposal sent to customer (can include multiple estimates/options)
model Proposal {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  customerId     String @map("customer_id")
  estimateId     String? @map("estimate_id")

  // Proposal details
  proposalNumber String         @map("proposal_number")
  status         ProposalStatus @default(DRAFT)

  // Dates
  issueDate  DateTime  @default(now()) @map("issue_date")
  validUntil DateTime? @map("valid_until")
  sentAt     DateTime? @map("sent_at")
  viewedAt   DateTime? @map("viewed_at")
  acceptedAt DateTime? @map("accepted_at")
  declinedAt DateTime? @map("declined_at")

  // Content
  title          String?
  coverLetter    String? @map("cover_letter") @db.Text
  terms          String? @db.Text
  signatureData  String? @map("signature_data") @db.Text
  signedAt       DateTime? @map("signed_at")
  signedByName   String? @map("signed_by_name")
  signedByEmail  String? @map("signed_by_email")

  // Selected option (if estimate has options)
  selectedOptionId String? @map("selected_option_id")

  createdBy String @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  estimate     Estimate?    @relation(fields: [estimateId], references: [id], onDelete: SetNull)

  @@unique([organizationId, proposalNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([estimateId])
  @@index([status])
  @@map("proposals")
}

/// @description Invoice for a job
model JobInvoice {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  jobId          String @map("job_id")
  customerId     String @map("customer_id")

  // Invoice details
  invoiceNumber String           @map("invoice_number")
  status        JobInvoiceStatus @default(DRAFT)

  // Dates
  issueDate DateTime  @default(now()) @map("issue_date")
  dueDate   DateTime? @map("due_date")
  sentAt    DateTime? @map("sent_at")
  viewedAt  DateTime? @map("viewed_at")
  paidAt    DateTime? @map("paid_at")

  // Amounts
  subtotal      Decimal @default(0) @db.Decimal(12, 2)
  taxAmount     Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  discount      Decimal @default(0) @db.Decimal(12, 2)
  totalAmount   Decimal @default(0) @map("total_amount") @db.Decimal(12, 2)
  amountPaid    Decimal @default(0) @map("amount_paid") @db.Decimal(12, 2)
  balanceDue    Decimal @default(0) @map("balance_due") @db.Decimal(12, 2)

  // Content
  notes String? @db.Text
  terms String? @db.Text

  // Reference
  estimateId String? @map("estimate_id")

  createdBy String @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job              @relation(fields: [jobId], references: [id], onDelete: Cascade)
  customer     Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lines        InvoiceLine[]
  payments     PaymentIntent[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([jobId])
  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@map("job_invoices")
}

/// @description Line item on an invoice
model InvoiceLine {
  id        String @id @default(cuid())
  invoiceId String @map("invoice_id")

  // Line details
  lineNumber  Int     @map("line_number")
  description String  @db.Text
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  lineTotal   Decimal @map("line_total") @db.Decimal(12, 2)

  // Optional pricebook reference
  pricebookItemId String? @map("pricebook_item_id")

  // Tax
  isTaxable Boolean @default(true) @map("is_taxable")
  taxRate   Decimal @default(0) @map("tax_rate") @db.Decimal(5, 4)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  invoice       JobInvoice     @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  pricebookItem PricebookItem? @relation(fields: [pricebookItemId], references: [id], onDelete: SetNull)

  @@unique([invoiceId, lineNumber])
  @@index([invoiceId])
  @@map("invoice_lines")
}

/// @description Payment intent/record (stub for payment integration)
model PaymentIntent {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  invoiceId      String @map("invoice_id")
  customerId     String @map("customer_id")

  // Payment details
  amount   Decimal          @db.Decimal(12, 2)
  currency String           @default("USD")
  status   JobPaymentStatus @default(PENDING)

  // Payment method
  paymentMethod String? @map("payment_method") // card, bank_transfer, check, cash, etc.
  
  // External payment processor reference
  externalId       String? @map("external_id") // Stripe payment intent ID, etc.
  externalProvider String? @map("external_provider") // stripe, square, etc.

  // Timestamps
  initiatedAt DateTime  @default(now()) @map("initiated_at")
  processedAt DateTime? @map("processed_at")
  failedAt    DateTime? @map("failed_at")
  refundedAt  DateTime? @map("refunded_at")

  // Error tracking
  errorCode    String? @map("error_code")
  errorMessage String? @map("error_message") @db.Text

  // Metadata
  metadata Json?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice      JobInvoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([invoiceId])
  @@index([customerId])
  @@index([status])
  @@index([externalId])
  @@map("payment_intents")
}

// =============================================================================
// P2.8: INVENTORY, MATERIALS & PROCUREMENT
// =============================================================================

/// @description Type of inventory location
enum InventoryLocationType {
  WAREHOUSE
  TRUCK
  BRANCH
  VENDOR_CONSIGNMENT
}

/// @description Status of a purchase order
enum PurchaseOrderStatus {
  DRAFT
  SUBMITTED
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

/// @description Unit of measure for inventory items
enum UnitOfMeasure {
  EACH
  BOX
  CASE
  PACK
  ROLL
  GALLON
  QUART
  PINT
  OUNCE
  POUND
  FOOT
  YARD
  METER
  SQUARE_FOOT
  CUBIC_FOOT
  HOUR
  DAY
}

/// @description Supplier/vendor for procurement
model Supplier {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  name           String
  code           String? // Internal supplier code
  contactName    String? @map("contact_name")
  email          String?
  phone          String?
  website        String?

  // Address
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")
  country      String? @default("US")

  // Payment terms
  paymentTermsDays Int?     @default(30) @map("payment_terms_days")
  creditLimit      Decimal? @map("credit_limit") @db.Decimal(12, 2)

  // Link to existing Vendor if applicable
  vendorId String? @map("vendor_id")

  notes     String? @db.Text
  isActive  Boolean @default(true) @map("is_active")
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor         Vendor?         @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  purchaseOrders PurchaseOrder[]
  inventoryItems InventoryItem[] @relation("PreferredSupplier")

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([vendorId])
  @@index([isActive])
  @@map("suppliers")
}

/// @description Inventory item (material, part, supply)
model InventoryItem {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  sku         String // Stock keeping unit
  name        String
  description String? @db.Text
  category    String?

  // Unit and pricing
  unitOfMeasure UnitOfMeasure @default(EACH) @map("unit_of_measure")
  unitCost      Decimal       @default(0) @map("unit_cost") @db.Decimal(12, 4)

  // Inventory control
  reorderPoint    Int @default(0) @map("reorder_point")
  reorderQuantity Int @default(0) @map("reorder_quantity")
  minStockLevel   Int @default(0) @map("min_stock_level")
  maxStockLevel   Int? @map("max_stock_level")

  // Tracking
  isSerialTracked Boolean @default(false) @map("is_serial_tracked")
  isLotTracked    Boolean @default(false) @map("is_lot_tracked")

  // Preferred supplier
  preferredSupplierId String? @map("preferred_supplier_id")

  // Link to pricebook item if applicable
  pricebookItemId String? @map("pricebook_item_id")

  isActive  Boolean   @default(true) @map("is_active")
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  preferredSupplier Supplier?          @relation("PreferredSupplier", fields: [preferredSupplierId], references: [id], onDelete: SetNull)
  pricebookItem     PricebookItem?     @relation(fields: [pricebookItemId], references: [id], onDelete: SetNull)
  inventoryLevels   InventoryLevel[]
  materialUsages    MaterialUsage[]
  purchaseOrderLines PurchaseOrderLine[]

  @@unique([organizationId, sku])
  @@index([organizationId])
  @@index([category])
  @@index([preferredSupplierId])
  @@index([pricebookItemId])
  @@index([isActive])
  @@map("inventory_items")
}

/// @description Inventory storage location (warehouse, truck, branch)
model InventoryLocation {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  name        String
  code        String? // Location code
  type        InventoryLocationType
  description String? @db.Text

  // Address (for warehouses)
  addressLine1 String? @map("address_line_1")
  addressLine2 String? @map("address_line_2")
  city         String?
  state        String?
  postalCode   String? @map("postal_code")

  // For truck stock - link to technician
  technicianId String? @map("technician_id")

  // For branch stock
  branchId String? @map("branch_id")

  isActive  Boolean   @default(true) @map("is_active")
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  technician      Technician?      @relation(fields: [technicianId], references: [id], onDelete: SetNull)
  branch          ContractorBranch? @relation(fields: [branchId], references: [id], onDelete: SetNull)
  inventoryLevels InventoryLevel[]
  transfersFrom   InventoryTransfer[] @relation("TransferFrom")
  transfersTo     InventoryTransfer[] @relation("TransferTo")

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([type])
  @@index([technicianId])
  @@index([branchId])
  @@index([isActive])
  @@map("inventory_locations")
}

/// @description Current inventory level at a location
model InventoryLevel {
  id         String @id @default(cuid())
  itemId     String @map("item_id")
  locationId String @map("location_id")

  quantityOnHand    Int @default(0) @map("quantity_on_hand")
  quantityReserved  Int @default(0) @map("quantity_reserved")
  quantityAvailable Int @default(0) @map("quantity_available") // Computed: onHand - reserved

  // Lot/serial tracking
  lotNumber    String? @map("lot_number")
  serialNumber String? @map("serial_number")
  expirationDate DateTime? @map("expiration_date")

  lastCountedAt DateTime? @map("last_counted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  item     InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  location InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([itemId, locationId, lotNumber, serialNumber])
  @@index([itemId])
  @@index([locationId])
  @@index([quantityOnHand])
  @@map("inventory_levels")
}

/// @description Transfer of inventory between locations
model InventoryTransfer {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  transferNumber String @map("transfer_number")

  fromLocationId String @map("from_location_id")
  toLocationId   String @map("to_location_id")

  status      String @default("PENDING") // PENDING, IN_TRANSIT, COMPLETED, CANCELLED
  requestedAt DateTime @default(now()) @map("requested_at")
  shippedAt   DateTime? @map("shipped_at")
  receivedAt  DateTime? @map("received_at")

  notes String? @db.Text

  requestedBy String @map("requested_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fromLocation InventoryLocation @relation("TransferFrom", fields: [fromLocationId], references: [id], onDelete: Cascade)
  toLocation   InventoryLocation @relation("TransferTo", fields: [toLocationId], references: [id], onDelete: Cascade)
  lines        InventoryTransferLine[]

  @@unique([organizationId, transferNumber])
  @@index([organizationId])
  @@index([fromLocationId])
  @@index([toLocationId])
  @@index([status])
  @@map("inventory_transfers")
}

/// @description Line item in an inventory transfer
model InventoryTransferLine {
  id         String @id @default(cuid())
  transferId String @map("transfer_id")
  itemId     String @map("item_id")

  quantityRequested Int @map("quantity_requested")
  quantityShipped   Int @default(0) @map("quantity_shipped")
  quantityReceived  Int @default(0) @map("quantity_received")

  lotNumber    String? @map("lot_number")
  serialNumber String? @map("serial_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  transfer InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  @@index([transferId])
  @@index([itemId])
  @@map("inventory_transfer_lines")
}

/// @description Material usage on a job
model MaterialUsage {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  jobId       String @map("job_id")
  jobVisitId  String? @map("job_visit_id")
  itemId      String @map("item_id")
  locationId  String @map("location_id") // Where material was taken from

  quantity    Int
  unitCost    Decimal @map("unit_cost") @db.Decimal(12, 4)
  totalCost   Decimal @map("total_cost") @db.Decimal(12, 2)

  // Tracking
  lotNumber    String? @map("lot_number")
  serialNumber String? @map("serial_number")

  usedAt   DateTime @default(now()) @map("used_at")
  usedBy   String   @map("used_by") // Technician who used it

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  job          Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobVisit     JobVisit?     @relation(fields: [jobVisitId], references: [id], onDelete: SetNull)
  item         InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([jobId])
  @@index([jobVisitId])
  @@index([itemId])
  @@index([locationId])
  @@index([usedAt])
  @@map("material_usages")
}

/// @description Purchase order for procurement
model PurchaseOrder {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  poNumber   String              @map("po_number")
  supplierId String              @map("supplier_id")
  status     PurchaseOrderStatus @default(DRAFT)

  // Dates
  orderDate        DateTime  @default(now()) @map("order_date")
  expectedDate     DateTime? @map("expected_date")
  submittedAt      DateTime? @map("submitted_at")
  confirmedAt      DateTime? @map("confirmed_at")
  receivedAt       DateTime? @map("received_at")

  // Delivery location
  deliveryLocationId String? @map("delivery_location_id")

  // Totals
  subtotal    Decimal @default(0) @map("subtotal") @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @map("tax_amount") @db.Decimal(12, 2)
  shippingCost Decimal @default(0) @map("shipping_cost") @db.Decimal(12, 2)
  totalAmount Decimal @default(0) @map("total_amount") @db.Decimal(12, 2)

  notes         String? @db.Text
  supplierNotes String? @map("supplier_notes") @db.Text

  createdBy String @map("created_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  supplier     Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  lines        PurchaseOrderLine[]
  receipts     PurchaseOrderReceipt[]

  @@unique([organizationId, poNumber])
  @@index([organizationId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

/// @description Line item in a purchase order
model PurchaseOrderLine {
  id              String @id @default(cuid())
  purchaseOrderId String @map("purchase_order_id")
  lineNumber      Int    @map("line_number")

  itemId      String  @map("item_id")
  description String?

  quantity         Int
  unitCost         Decimal @map("unit_cost") @db.Decimal(12, 4)
  lineTotal        Decimal @map("line_total") @db.Decimal(12, 2)

  quantityReceived Int @default(0) @map("quantity_received")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item          InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([itemId])
  @@map("purchase_order_lines")
}

/// @description Receipt of goods from a purchase order
model PurchaseOrderReceipt {
  id              String @id @default(cuid())
  purchaseOrderId String @map("purchase_order_id")

  receiptNumber String   @map("receipt_number")
  receivedAt    DateTime @default(now()) @map("received_at")
  receivedBy    String   @map("received_by")

  // Delivery location
  locationId String @map("location_id")

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseOrder PurchaseOrder              @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  lines         PurchaseOrderReceiptLine[]

  @@index([purchaseOrderId])
  @@index([receivedAt])
  @@map("purchase_order_receipts")
}

/// @description Line item in a purchase order receipt
model PurchaseOrderReceiptLine {
  id        String @id @default(cuid())
  receiptId String @map("receipt_id")
  itemId    String @map("item_id")

  quantityReceived Int @map("quantity_received")

  lotNumber    String? @map("lot_number")
  serialNumber String? @map("serial_number")
  expirationDate DateTime? @map("expiration_date")

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  receipt PurchaseOrderReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)

  @@index([receiptId])
  @@index([itemId])
  @@map("purchase_order_receipt_lines")
}

// =============================================================================
// PHASE 2: MAINTENANCE CONTRACTS & RECURRING SERVICES (P2.9)
// =============================================================================

enum ServiceContractStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
  RENEWED
}

enum ServiceContractType {
  PREVENTIVE_MAINTENANCE
  FULL_SERVICE
  INSPECTION_ONLY
  ON_CALL
  SEASONAL
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum ScheduledVisitStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  RESCHEDULED
  MISSED
}

/// @description Service/maintenance contract with a customer or HOA
model ServiceContract {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  // Contract identification
  contractNumber String               @map("contract_number")
  name           String
  type           ServiceContractType
  status         ServiceContractStatus @default(DRAFT)

  // Customer/property linkage (one of these)
  customerId    String? @map("customer_id")
  associationId String? @map("association_id")
  propertyId    String? @map("property_id")
  unitId        String? @map("unit_id")

  // Contract terms
  startDate       DateTime  @map("start_date") @db.Date
  endDate         DateTime  @map("end_date") @db.Date
  autoRenew       Boolean   @default(false) @map("auto_renew")
  renewalTermDays Int?      @map("renewal_term_days") // Days before end to trigger renewal
  renewalNoticeAt DateTime? @map("renewal_notice_at")

  // Pricing
  contractValue   Decimal  @map("contract_value") @db.Decimal(12, 2)
  billingFrequency RecurrenceFrequency @map("billing_frequency")
  billingAmount   Decimal  @map("billing_amount") @db.Decimal(12, 2)
  nextBillingDate DateTime? @map("next_billing_date") @db.Date

  // Service scope
  description      String? @db.Text
  scopeOfWork      String? @map("scope_of_work") @db.Text
  exclusions       String? @db.Text
  serviceAreaNotes String? @map("service_area_notes") @db.Text

  // SLA terms
  responseTimeHours   Int? @map("response_time_hours") // Max hours to respond
  resolutionTimeHours Int? @map("resolution_time_hours") // Max hours to resolve
  coverageHoursJson   String? @map("coverage_hours_json") @db.Text // JSON: { mon: "8-17", tue: "8-17", ... }
  emergencyCoverage   Boolean @default(false) @map("emergency_coverage")

  // Assignment
  primaryTechnicianId String? @map("primary_technician_id")
  assignedBranchId    String? @map("assigned_branch_id")

  // Documents
  documentUrl String? @map("document_url")
  signedAt    DateTime? @map("signed_at")
  signedBy    String?   @map("signed_by")

  // Metadata
  notes     String? @db.Text
  metadata  Json?

  // Soft delete
  deletedAt DateTime? @map("deleted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @map("created_by")

  // Relations
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer           Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  association        Association?      @relation(fields: [associationId], references: [id], onDelete: SetNull)
  property           Property?         @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  unit               Unit?             @relation(fields: [unitId], references: [id], onDelete: SetNull)
  primaryTechnician  Technician?       @relation("PrimaryTechnician", fields: [primaryTechnicianId], references: [id], onDelete: SetNull)
  assignedBranch     ContractorBranch? @relation(fields: [assignedBranchId], references: [id], onDelete: SetNull)
  serviceItems       ContractServiceItem[]
  schedules          ContractSchedule[]
  scheduledVisits    ScheduledVisit[]
  renewals           ContractRenewal[]
  slaRecords         ContractSLARecord[]

  @@unique([organizationId, contractNumber])
  @@index([organizationId])
  @@index([customerId])
  @@index([associationId])
  @@index([status])
  @@index([endDate])
  @@map("service_contracts")
}

/// @description Line item/service included in a contract
model ContractServiceItem {
  id         String @id @default(cuid())
  contractId String @map("contract_id")

  // Service details
  name           String
  description    String? @db.Text
  pricebookItemId String? @map("pricebook_item_id")

  // Frequency
  frequency      RecurrenceFrequency
  visitsPerPeriod Int @default(1) @map("visits_per_period")

  // Pricing
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  quantity    Int     @default(1)
  lineTotal   Decimal @map("line_total") @db.Decimal(12, 2)

  // Scope
  estimatedDurationMinutes Int? @map("estimated_duration_minutes")
  notes                    String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contract      ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  pricebookItem PricebookItem?  @relation(fields: [pricebookItemId], references: [id], onDelete: SetNull)

  @@index([contractId])
  @@map("contract_service_items")
}

/// @description Recurring schedule definition for a contract
model ContractSchedule {
  id         String @id @default(cuid())
  contractId String @map("contract_id")

  // Schedule definition
  name        String
  description String? @db.Text
  frequency   RecurrenceFrequency
  isActive    Boolean @default(true) @map("is_active")

  // Timing
  startDate      DateTime  @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  preferredDayOfWeek  Int?  @map("preferred_day_of_week") // 0=Sun, 1=Mon, etc.
  preferredDayOfMonth Int?  @map("preferred_day_of_month") // 1-31
  preferredTimeStart  String? @map("preferred_time_start") // HH:MM
  preferredTimeEnd    String? @map("preferred_time_end") // HH:MM

  // Generation tracking
  lastGeneratedAt DateTime? @map("last_generated_at")
  nextGenerateAt  DateTime? @map("next_generate_at")

  // Assignment override
  technicianId String? @map("technician_id")

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contract       ServiceContract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  scheduledVisits ScheduledVisit[]

  @@index([contractId])
  @@index([nextGenerateAt])
  @@map("contract_schedules")
}

/// @description Individual scheduled visit generated from contract schedule
model ScheduledVisit {
  id         String @id @default(cuid())
  contractId String @map("contract_id")
  scheduleId String? @map("schedule_id")

  // Visit identification
  visitNumber Int @map("visit_number")
  status      ScheduledVisitStatus @default(SCHEDULED)

  // Scheduling
  scheduledDate  DateTime @map("scheduled_date") @db.Date
  scheduledStart DateTime? @map("scheduled_start")
  scheduledEnd   DateTime? @map("scheduled_end")
  confirmedAt    DateTime? @map("confirmed_at")

  // Execution
  actualStart DateTime? @map("actual_start")
  actualEnd   DateTime? @map("actual_end")
  completedAt DateTime? @map("completed_at")

  // Assignment
  technicianId String? @map("technician_id")
  assignedAt   DateTime? @map("assigned_at")

  // Linked job (created when visit is executed)
  jobId String? @map("job_id")

  // Notes
  serviceNotes   String? @map("service_notes") @db.Text
  customerNotes  String? @map("customer_notes") @db.Text
  completionNotes String? @map("completion_notes") @db.Text

  // Rescheduling
  rescheduledFrom String? @map("rescheduled_from") // Original visit ID
  rescheduleReason String? @map("reschedule_reason") @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contract   ServiceContract   @relation(fields: [contractId], references: [id], onDelete: Cascade)
  schedule   ContractSchedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  technician Technician?       @relation("ScheduledVisitTechnician", fields: [technicianId], references: [id], onDelete: SetNull)
  job        Job?              @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@unique([contractId, visitNumber])
  @@index([contractId])
  @@index([scheduleId])
  @@index([technicianId])
  @@index([scheduledDate])
  @@index([status])
  @@map("scheduled_visits")
}

/// @description Contract renewal history
model ContractRenewal {
  id         String @id @default(cuid())
  contractId String @map("contract_id")

  // Renewal details
  renewalNumber   Int      @map("renewal_number")
  previousEndDate DateTime @map("previous_end_date") @db.Date
  newEndDate      DateTime @map("new_end_date") @db.Date

  // Pricing changes
  previousValue Decimal @map("previous_value") @db.Decimal(12, 2)
  newValue      Decimal @map("new_value") @db.Decimal(12, 2)
  changePercent Decimal? @map("change_percent") @db.Decimal(5, 2)

  // Approval
  renewedAt   DateTime @map("renewed_at")
  renewedBy   String   @map("renewed_by")
  approvedAt  DateTime? @map("approved_at")
  approvedBy  String?   @map("approved_by")

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  contract ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, renewalNumber])
  @@index([contractId])
  @@map("contract_renewals")
}

/// @description SLA performance tracking for contracts
model ContractSLARecord {
  id         String @id @default(cuid())
  contractId String @map("contract_id")

  // Period
  periodStart DateTime @map("period_start") @db.Date
  periodEnd   DateTime @map("period_end") @db.Date

  // Metrics
  totalRequests      Int @default(0) @map("total_requests")
  onTimeResponses    Int @default(0) @map("on_time_responses")
  onTimeResolutions  Int @default(0) @map("on_time_resolutions")
  missedSLAs         Int @default(0) @map("missed_slas")

  // Calculated
  responseCompliancePercent   Decimal? @map("response_compliance_percent") @db.Decimal(5, 2)
  resolutionCompliancePercent Decimal? @map("resolution_compliance_percent") @db.Decimal(5, 2)

  // Averages
  avgResponseTimeMinutes   Int? @map("avg_response_time_minutes")
  avgResolutionTimeMinutes Int? @map("avg_resolution_time_minutes")

  // Visits
  scheduledVisits  Int @default(0) @map("scheduled_visits")
  completedVisits  Int @default(0) @map("completed_visits")
  missedVisits     Int @default(0) @map("missed_visits")
  visitCompliancePercent Decimal? @map("visit_compliance_percent") @db.Decimal(5, 2)

  notes String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  contract ServiceContract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@unique([contractId, periodStart, periodEnd])
  @@index([contractId])
  @@index([periodStart])
  @@map("contract_sla_records")
}

// =============================================================================
// PHASE 3 - CONCIERGE PROPERTY OWNER PLATFORM
// =============================================================================

// -----------------------------------------------------------------------------
// Phase 3.1: Property & Ownership Modeling
// -----------------------------------------------------------------------------

/// @description Role a party plays in property ownership
enum PropertyOwnershipRole {
  OWNER           // Primary owner with full authority
  CO_OWNER        // Joint owner with shared authority
  TRUSTEE_MANAGER // Manages property on behalf of trust/entity
  DELEGATED_AGENT // Authorized agent with delegated authority
}

/// @description Status of a property ownership record
enum PropertyOwnershipStatus {
  ACTIVE
  PENDING_VERIFICATION
  SUSPENDED
  TERMINATED
}

/// @description Type of authority that can be delegated
enum DelegatedAuthorityType {
  MAINTENANCE_APPROVAL  // Can approve maintenance up to limit
  VENDOR_SELECTION      // Can select vendors
  DOCUMENT_ACCESS       // Can access/upload documents
  CASE_MANAGEMENT       // Can manage concierge cases
  FINANCIAL_DECISIONS   // Can make financial decisions up to limit
  FULL_AUTHORITY        // Full delegated authority
}

/// @description Status of a delegated authority grant
enum DelegatedAuthorityStatus {
  ACTIVE
  EXPIRED
  REVOKED
  PENDING_ACCEPTANCE
}

/// @description Links a party to an IndividualProperty with ownership role
model PropertyOwnership {
  id         String @id @default(cuid())
  propertyId String @map("property_id")
  partyId    String @map("party_id")

  role   PropertyOwnershipRole
  status PropertyOwnershipStatus @default(ACTIVE)

  // Ownership details
  ownershipPercentage Decimal? @map("ownership_percentage") @db.Decimal(5, 2) // For co-owners
  isPrimaryContact    Boolean  @default(false) @map("is_primary_contact")

  // Verification
  verifiedAt DateTime? @map("verified_at")
  verifiedBy String?   @map("verified_by") // User ID who verified

  // Effective dates
  effectiveFrom DateTime  @default(now()) @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")

  notes String? @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  property            IndividualProperty    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  party               Party                 @relation(fields: [partyId], references: [id], onDelete: Cascade)
  delegatedAuthorities DelegatedAuthority[] @relation("OwnershipDelegations")

  @@unique([propertyId, partyId, role])
  @@index([propertyId])
  @@index([partyId])
  @@index([status])
  @@map("property_ownerships")
}

/// @description Scoped permission grant from an owner to another party
model DelegatedAuthority {
  id                  String @id @default(cuid())
  propertyOwnershipId String @map("property_ownership_id") // The ownership granting authority
  delegatePartyId     String @map("delegate_party_id")     // Party receiving authority

  authorityType DelegatedAuthorityType
  status        DelegatedAuthorityStatus @default(PENDING_ACCEPTANCE)

  // Scope limits
  monetaryLimit    Decimal? @map("monetary_limit") @db.Decimal(12, 2) // Max amount for financial decisions
  scopeDescription String?  @map("scope_description") @db.Text        // Human-readable scope description
  scopeRestrictions Json?   @map("scope_restrictions")                // Structured restrictions

  // Validity
  grantedAt   DateTime  @default(now()) @map("granted_at")
  acceptedAt  DateTime? @map("accepted_at")
  expiresAt   DateTime? @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  revokedBy   String?   @map("revoked_by") // User ID who revoked
  revokeReason String?  @map("revoke_reason")

  // Audit
  grantedBy String @map("granted_by") // User ID who granted

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  propertyOwnership PropertyOwnership @relation("OwnershipDelegations", fields: [propertyOwnershipId], references: [id], onDelete: Cascade)
  delegateParty     Party             @relation("DelegatedAuthorities", fields: [delegatePartyId], references: [id], onDelete: Cascade)

  @@index([propertyOwnershipId])
  @@index([delegatePartyId])
  @@index([status])
  @@index([authorityType])
  @@map("delegated_authorities")
}

// -----------------------------------------------------------------------------
// Phase 3.2: Property Portfolio Management
// -----------------------------------------------------------------------------

/// @description Portfolio grouping for multiple properties
model PropertyPortfolio {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")

  name        String
  description String? @db.Text
  settings    Json    @default("{}")

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  properties   PortfolioProperty[]

  @@index([organizationId])
  @@index([isActive])
  @@map("property_portfolios")
}

/// @description Junction table linking portfolios to properties
model PortfolioProperty {
  id          String @id @default(cuid())
  portfolioId String @map("portfolio_id")
  propertyId  String @map("property_id")

  // Optional metadata for this property within the portfolio
  displayOrder Int?    @map("display_order")
  notes        String? @db.Text

  addedAt   DateTime @default(now()) @map("added_at")
  addedBy   String   @map("added_by") // User ID who added
  removedAt DateTime? @map("removed_at")

  // Relations
  portfolio PropertyPortfolio  @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  property  IndividualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, propertyId])
  @@index([portfolioId])
  @@index([propertyId])
  @@map("portfolio_properties")
}

// -----------------------------------------------------------------------------
// Phase 3.3: Owner Intent & Request Intake
// -----------------------------------------------------------------------------

/// @description Category of owner intent/request
enum OwnerIntentCategory {
  MAINTENANCE   // Repair, upkeep
  IMPROVEMENT   // Upgrades, renovations
  COMPLIANCE    // HOA compliance, permits
  DISPUTE       // Neighbor disputes, HOA disputes
  INQUIRY       // General questions
  EMERGENCY     // Urgent issues
  OTHER
}

/// @description Priority level for owner intents
enum OwnerIntentPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

/// @description Status of an owner intent
enum OwnerIntentStatus {
  DRAFT              // Not yet submitted
  SUBMITTED          // Submitted by owner
  ACKNOWLEDGED       // Acknowledged by concierge
  CONVERTED_TO_CASE  // Converted to a concierge case
  DECLINED           // Declined by concierge
  WITHDRAWN          // Withdrawn by owner
}

/// @description Owner intent/request capturing goals in natural language
model OwnerIntent {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  propertyId     String @map("property_id")

  // Intent details
  title       String
  description String  @db.Text
  category    OwnerIntentCategory
  priority    OwnerIntentPriority @default(NORMAL)
  status      OwnerIntentStatus   @default(DRAFT)

  // Constraints and preferences (JSON for flexibility)
  constraints Json? // e.g., { "budget": 5000, "timeframe": "2 weeks" }
  attachments Json? // Array of document/file references

  // Submitter info
  submittedByPartyId String? @map("submitted_by_party_id")

  // Lifecycle timestamps
  submittedAt    DateTime? @map("submitted_at")
  acknowledgedAt DateTime? @map("acknowledged_at")
  acknowledgedBy String?   @map("acknowledged_by") // User ID

  // Conversion to case
  convertedCaseId String? @map("converted_case_id")
  convertedAt     DateTime? @map("converted_at")

  // Decline/withdraw info
  declinedAt    DateTime? @map("declined_at")
  declinedBy    String?   @map("declined_by")
  declineReason String?   @map("decline_reason") @db.Text
  withdrawnAt   DateTime? @map("withdrawn_at")
  withdrawReason String?  @map("withdraw_reason") @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  property        IndividualProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  submittedByParty Party?            @relation("IntentSubmitter", fields: [submittedByPartyId], references: [id], onDelete: SetNull)
  notes           IntentNote[]

  @@index([organizationId])
  @@index([propertyId])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@map("owner_intents")
}

/// @description Internal notes on owner intents
model IntentNote {
  id       String @id @default(cuid())
  intentId String @map("intent_id")

  content   String @db.Text
  createdBy String @map("created_by") // User ID
  isInternal Boolean @default(true) @map("is_internal") // Internal vs. visible to owner

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  intent OwnerIntent @relation(fields: [intentId], references: [id], onDelete: Cascade)

  @@index([intentId])
  @@map("intent_notes")
}

// -----------------------------------------------------------------------------
// Phase 3.4: Concierge Case Lifecycle
// -----------------------------------------------------------------------------

/// @description Status of a concierge case
enum ConciergeCaseStatus {
  INTAKE           // Initial intake
  ASSESSMENT       // Being assessed
  IN_PROGRESS      // Active work
  PENDING_EXTERNAL // Waiting on external party (HOA, vendor)
  PENDING_OWNER    // Waiting on owner response
  ON_HOLD          // Temporarily paused
  RESOLVED         // Work completed, pending closure
  CLOSED           // Fully closed
  CANCELLED        // Cancelled
}

/// @description Priority level for concierge cases
enum ConciergeCasePriority {
  LOW
  NORMAL
  HIGH
  URGENT
  EMERGENCY
}

/// @description Durable case container for concierge operations
model ConciergeCase {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  propertyId     String @map("property_id")

  // Case identification
  caseNumber String @unique @map("case_number") // Human-readable case number

  // Case details
  title       String
  description String @db.Text
  status      ConciergeCaseStatus   @default(INTAKE)
  priority    ConciergeCasePriority @default(NORMAL)

  // Origin (optional link to intent that created this case)
  originIntentId String? @map("origin_intent_id")

  // Cross-Domain Integration (P3.12)
  // Link to Phase 1 HOA unit if property is in a platform HOA
  linkedUnitId String? @map("linked_unit_id")
  // Link to Phase 2 Job when case requires contractor work
  linkedJobId  String? @map("linked_job_id")

  // Assignment
  assignedConciergeUserId String? @map("assigned_concierge_user_id")

  // Lifecycle timestamps
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  resolvedAt DateTime? @map("resolved_at")
  closedAt   DateTime? @map("closed_at")
  cancelledAt DateTime? @map("cancelled_at")
  deletedAt  DateTime? @map("deleted_at")

  // Resolution details
  resolutionSummary String? @map("resolution_summary") @db.Text
  resolvedBy        String? @map("resolved_by") // User ID

  // Cancellation details
  cancelReason String? @map("cancel_reason") @db.Text
  cancelledBy  String? @map("cancelled_by") // User ID

  // Relations
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  property           IndividualProperty  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  assignedConcierge  User?               @relation("AssignedConciergeCases", fields: [assignedConciergeUserId], references: [id], onDelete: SetNull)
  statusHistory      CaseStatusHistory[]
  notes              CaseNote[]
  attachments        CaseAttachment[]
  participants       CaseParticipant[]
  actions            ConciergeAction[]
  hoaApprovals       ExternalHOAApproval[]
  vendorInteractions ExternalVendorInteraction[]
  decisions          MaterialDecision[]

  @@index([organizationId])
  @@index([propertyId])
  @@index([status])
  @@index([priority])
  @@index([assignedConciergeUserId])
  @@index([caseNumber])
  @@map("concierge_cases")
}

/// @description Audit trail for case status transitions
model CaseStatusHistory {
  id     String @id @default(cuid())
  caseId String @map("case_id")

  fromStatus ConciergeCaseStatus? @map("from_status")
  toStatus   ConciergeCaseStatus  @map("to_status")
  reason     String?              @db.Text
  changedBy  String               @map("changed_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  case ConciergeCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@index([createdAt])
  @@map("case_status_history")
}

/// @description Internal notes on concierge cases
model CaseNote {
  id     String @id @default(cuid())
  caseId String @map("case_id")

  content    String  @db.Text
  createdBy  String  @map("created_by") // User ID
  isInternal Boolean @default(true) @map("is_internal") // Internal vs. visible to owner

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  case ConciergeCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@map("case_notes")
}

/// @description File attachments for concierge cases
model CaseAttachment {
  id     String @id @default(cuid())
  caseId String @map("case_id")

  // File details
  fileName    String @map("file_name")
  fileSize    Int    @map("file_size") // bytes
  mimeType    String @map("mime_type")
  storagePath String @map("storage_path")
  fileUrl     String @map("file_url")

  // Metadata
  description String? @db.Text
  uploadedBy  String  @map("uploaded_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  case ConciergeCase @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@index([caseId])
  @@map("case_attachments")
}

/// @description Participants involved in a concierge case
model CaseParticipant {
  id     String @id @default(cuid())
  caseId String @map("case_id")

  // Participant can be a party or external contact
  partyId             String? @map("party_id")
  externalContactName String? @map("external_contact_name")
  externalContactEmail String? @map("external_contact_email")
  externalContactPhone String? @map("external_contact_phone")

  // Role in the case
  role  String // e.g., "owner", "co-owner", "hoa_contact", "vendor_contact"
  notes String? @db.Text

  addedAt   DateTime  @default(now()) @map("added_at")
  addedBy   String    @map("added_by") // User ID
  removedAt DateTime? @map("removed_at")

  // Relations
  case  ConciergeCase @relation(fields: [caseId], references: [id], onDelete: Cascade)
  party Party?        @relation("CaseParticipants", fields: [partyId], references: [id], onDelete: SetNull)

  @@index([caseId])
  @@index([partyId])
  @@map("case_participants")
}

// -----------------------------------------------------------------------------
// Phase 3.6: Human Concierge Execution
// -----------------------------------------------------------------------------

/// @description Type of concierge action
enum ConciergeActionType {
  PHONE_CALL       // Phone call to owner, vendor, HOA, etc.
  EMAIL            // Email correspondence
  DOCUMENT_REVIEW  // Reviewing documents
  RESEARCH         // Research and investigation
  VENDOR_CONTACT   // Contacting vendors/service providers
  HOA_CONTACT      // Contacting HOA
  SCHEDULING       // Scheduling appointments, work
  APPROVAL_REQUEST // Requesting approvals
  FOLLOW_UP        // Follow-up actions
  ESCALATION       // Escalating to supervisor
  OTHER            // Other action types
}

/// @description Status of a concierge action
enum ConciergeActionStatus {
  PLANNED      // Action is planned but not started
  IN_PROGRESS  // Action is currently in progress
  COMPLETED    // Action has been completed
  CANCELLED    // Action was cancelled
  BLOCKED      // Action is blocked by external factors
}

/// @description Individual action taken by concierge staff on a case
model ConciergeAction {
  id     String @id @default(cuid())
  caseId String @map("case_id")

  // Action details
  actionType  ConciergeActionType
  status      ConciergeActionStatus @default(PLANNED)
  description String                @db.Text

  // Scheduling
  plannedAt   DateTime? @map("planned_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Performer
  performedByUserId String @map("performed_by_user_id")

  // Outcome (required for completion)
  outcome String? @db.Text
  notes   String? @db.Text

  // Related entities (JSON arrays of IDs)
  relatedDocumentIds       Json? @map("related_document_ids") // Array of Document IDs
  relatedExternalContactIds Json? @map("related_external_contact_ids") // Array of external contact IDs

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  case          ConciergeCase       @relation(fields: [caseId], references: [id], onDelete: Cascade)
  performedBy   User                @relation("ActionPerformer", fields: [performedByUserId], references: [id])
  logs          ConciergeActionLog[]

  @@index([caseId])
  @@index([performedByUserId])
  @@index([status])
  @@index([actionType])
  @@map("concierge_actions")
}

/// @description Audit log entry for concierge action changes
model ConciergeActionLog {
  id       String @id @default(cuid())
  actionId String @map("action_id")

  // Log details
  eventType   String  // e.g., "status_change", "note_added", "outcome_recorded"
  fromStatus  ConciergeActionStatus? @map("from_status")
  toStatus    ConciergeActionStatus? @map("to_status")
  description String? @db.Text
  changedBy   String  @map("changed_by") // User ID

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  action ConciergeAction @relation(fields: [actionId], references: [id], onDelete: Cascade)

  @@index([actionId])
  @@index([createdAt])
  @@map("concierge_action_logs")
}

// -----------------------------------------------------------------------------
// Phase 3.7: External HOA Context Tracking
// -----------------------------------------------------------------------------

/// @description Status of an external HOA approval
enum ExternalApprovalStatus {
  NOT_REQUIRED  // No approval needed
  PENDING       // Waiting to submit
  SUBMITTED     // Submitted to HOA
  APPROVED      // Approved by HOA
  DENIED        // Denied by HOA
  EXPIRED       // Approval expired
}

/// @description External HOA context for properties with non-platform HOAs
model ExternalHOAContext {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  propertyId     String @map("property_id")

  // HOA details
  hoaName         String  @map("hoa_name")
  hoaContactName  String? @map("hoa_contact_name")
  hoaContactEmail String? @map("hoa_contact_email")
  hoaContactPhone String? @map("hoa_contact_phone")
  hoaAddress      String? @map("hoa_address") @db.Text

  // Notes and documents
  notes        String? @db.Text
  documentsJson Json?   @map("documents_json") // Array of Document IDs

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  property     IndividualProperty  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  approvals    ExternalHOAApproval[]
  rules        ExternalHOARule[]

  @@index([organizationId])
  @@index([propertyId])
  @@map("external_hoa_contexts")
}

/// @description Approval tracking for external HOAs
model ExternalHOAApproval {
  id                   String @id @default(cuid())
  externalHoaContextId String @map("external_hoa_context_id")
  caseId               String? @map("case_id") // Optional link to concierge case

  // Approval details
  approvalType      String // e.g., "architectural", "landscaping", "fence"
  status            ExternalApprovalStatus @default(PENDING)
  submittedAt       DateTime? @map("submitted_at")
  responseAt        DateTime? @map("response_at")
  expiresAt         DateTime? @map("expires_at")
  approvalReference String?   @map("approval_reference") // HOA reference number

  // Notes and documents
  notes              String? @db.Text
  relatedDocumentIds Json?   @map("related_document_ids") // Array of Document IDs

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  externalHoaContext ExternalHOAContext @relation(fields: [externalHoaContextId], references: [id], onDelete: Cascade)
  case               ConciergeCase?     @relation(fields: [caseId], references: [id], onDelete: SetNull)

  @@index([externalHoaContextId])
  @@index([caseId])
  @@index([status])
  @@map("external_hoa_approvals")
}

/// @description Document-based rule references for external HOAs
model ExternalHOARule {
  id                   String @id @default(cuid())
  externalHoaContextId String @map("external_hoa_context_id")

  // Rule details
  ruleCategory     String  @map("rule_category") // e.g., "architectural", "landscaping", "parking"
  ruleDescription  String  @map("rule_description") @db.Text
  sourceDocumentId String? @map("source_document_id") // Reference to Document
  notes            String? @db.Text

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  externalHoaContext ExternalHOAContext @relation(fields: [externalHoaContextId], references: [id], onDelete: Cascade)

  @@index([externalHoaContextId])
  @@index([ruleCategory])
  @@map("external_hoa_rules")
}

// -----------------------------------------------------------------------------
// Phase 3.8: External Vendor Coordination
// -----------------------------------------------------------------------------

/// @description External vendor context for non-platform service providers
model ExternalVendorContext {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  propertyId     String? @map("property_id") // Optional property association

  // Vendor details
  vendorName         String  @map("vendor_name")
  vendorContactName  String? @map("vendor_contact_name")
  vendorContactEmail String? @map("vendor_contact_email")
  vendorContactPhone String? @map("vendor_contact_phone")
  vendorAddress      String? @map("vendor_address") @db.Text
  tradeCategories    Json?   @map("trade_categories") // Array of trade categories

  // Notes
  notes String? @db.Text

  // Migration path to Phase 2
  linkedServiceProviderOrgId String? @map("linked_service_provider_org_id")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization          Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  property              IndividualProperty? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  linkedServiceProvider Organization?       @relation("LinkedServiceProvider", fields: [linkedServiceProviderOrgId], references: [id], onDelete: SetNull)
  interactions          ExternalVendorInteraction[]

  @@index([organizationId])
  @@index([propertyId])
  @@index([linkedServiceProviderOrgId])
  @@map("external_vendor_contexts")
}

/// @description Interaction log for external vendors
model ExternalVendorInteraction {
  id                      String @id @default(cuid())
  externalVendorContextId String @map("external_vendor_context_id")
  caseId                  String? @map("case_id") // Optional link to concierge case

  // Interaction details
  interactionType String   // QUOTE, SCHEDULE, WORK, INVOICE, OTHER
  interactionDate DateTime @map("interaction_date")
  description     String   @db.Text
  amount          Decimal? @db.Decimal(12, 2) // Optional monetary amount

  // Notes and documents
  notes              String? @db.Text
  relatedDocumentIds Json?   @map("related_document_ids") // Array of Document IDs

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  externalVendorContext ExternalVendorContext @relation(fields: [externalVendorContextId], references: [id], onDelete: Cascade)
  case                  ConciergeCase?        @relation(fields: [caseId], references: [id], onDelete: SetNull)

  @@index([externalVendorContextId])
  @@index([caseId])
  @@index([interactionType])
  @@map("external_vendor_interactions")
}

// -----------------------------------------------------------------------------
// Phase 3.9: Decision, Rationale & Trust Ledger
// -----------------------------------------------------------------------------

/// @description Category of material decision
enum DecisionCategory {
  VENDOR_SELECTION    // Choosing a vendor
  APPROVAL            // Approving something
  COST_AUTHORIZATION  // Authorizing costs
  SCHEDULING          // Scheduling decisions
  ESCALATION          // Escalation decisions
  RESOLUTION          // Resolution decisions
  OTHER               // Other decisions
}

/// @description Material decision record for auditability
model MaterialDecision {
  id             String @id @default(cuid())
  organizationId String @map("organization_id")
  caseId         String? @map("case_id") // Optional link to concierge case

  // Decision details
  category    DecisionCategory
  title       String
  description String @db.Text
  rationale   String @db.Text // Why this decision was made

  // Decision maker
  decidedByUserId String   @map("decided_by_user_id")
  decidedAt       DateTime @map("decided_at")

  // Options considered (JSON array)
  optionsConsidered Json? @map("options_considered")

  // Impact and outcome
  estimatedImpact String? @map("estimated_impact") @db.Text
  actualOutcome   String? @map("actual_outcome") @db.Text
  outcomeRecordedAt DateTime? @map("outcome_recorded_at")

  // Related entities
  relatedDocumentIds Json? @map("related_document_ids") // Array of Document IDs
  relatedActionIds   Json? @map("related_action_ids") // Array of ConciergeAction IDs

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  case         ConciergeCase? @relation(fields: [caseId], references: [id], onDelete: SetNull)
  decidedBy    User           @relation("DecisionMaker", fields: [decidedByUserId], references: [id])

  @@index([organizationId])
  @@index([caseId])
  @@index([category])
  @@index([decidedByUserId])
  @@map("material_decisions")
}
